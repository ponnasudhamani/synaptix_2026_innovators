<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PulseIQ Pro v3 ‚Äî Adaptive Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,500;0,9..144,700;1,9..144,300&family=Instrument+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --cream:#F5F0E8;--cream2:#EDE8DC;--cream3:#E2DBCC;
  --ink:#1A1410;--ink2:#3D3530;--ink3:#6B5E56;
  --teal:#0A7B6C;--teal2:#0D9982;--teal-lt:#E0F4F1;--teal-mid:#B8E8E2;
  --amber:#C97B1A;--amber-lt:#FEF3E2;
  --red:#C0392B;--red-lt:#FDECEA;--red-mid:#F5C6C2;
  --green:#1A7B4A;--green-lt:#E6F4EE;
  --blue:#1A5C9C;--blue-lt:#E6EEF8;
  --purple:#7B1A9C;--purple-lt:#F3E6F8;
  --orange:#B85A00;
  --border:rgba(26,20,16,.1);--border2:rgba(26,20,16,.18);
  --shadow:0 1px 3px rgba(26,20,16,.08),0 4px 12px rgba(26,20,16,.05);
  --shadow-lg:0 4px 16px rgba(26,20,16,.1),0 12px 40px rgba(26,20,16,.06);
  --r:12px;--r2:8px;
  --ff-head:'Fraunces',Georgia,serif;--ff-body:'Instrument Sans',system-ui,sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:15px;scroll-behavior:smooth}
body{background:var(--cream);color:var(--ink);font-family:var(--ff-body);min-height:100vh;-webkit-font-smoothing:antialiased}

/* ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê */
.app-shell{display:flex;min-height:100vh}
.nav{width:224px;flex-shrink:0;background:var(--ink);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;overflow:hidden}
.nav-brand{padding:26px 22px 20px;border-bottom:1px solid rgba(255,255,255,.08)}
.nav-brand-name{font-family:var(--ff-head);font-size:1.4rem;font-weight:700;color:#fff;letter-spacing:-.01em}
.nav-brand-sub{font-size:.68rem;color:rgba(255,255,255,.38);margin-top:2px;letter-spacing:.06em;text-transform:uppercase}
.nav-patient{margin:14px 12px;padding:11px;background:rgba(255,255,255,.06);border-radius:var(--r2);display:flex;align-items:center;gap:9px;cursor:pointer;transition:background .15s}
.nav-patient:hover{background:rgba(255,255,255,.1)}
.nav-avatar{width:34px;height:34px;border-radius:50%;background:var(--teal2);display:flex;align-items:center;justify-content:center;font-family:var(--ff-head);font-size:.85rem;font-weight:700;color:#fff;flex-shrink:0}
.nav-patient-name{font-size:.8rem;font-weight:600;color:#fff;line-height:1.2}
.nav-patient-id{font-size:.66rem;color:rgba(255,255,255,.38)}
.nav-links{flex:1;padding:8px 10px;display:flex;flex-direction:column;gap:2px;overflow-y:auto}
.nav-link{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r2);color:rgba(255,255,255,.55);font-size:.8rem;font-weight:500;cursor:pointer;transition:all .15s;border:none;background:none;width:100%;text-align:left}
.nav-link:hover{color:#fff;background:rgba(255,255,255,.07)}
.nav-link.active{color:#fff;background:var(--teal)}
.nav-link .icon{font-size:.95rem;width:20px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;padding:1px 7px;border-radius:20px;background:var(--red);color:#fff;font-size:.6rem;font-weight:700;display:none}
.nav-badge.show{display:block}
.nav-section-label{font-size:.6rem;color:rgba(255,255,255,.25);letter-spacing:.08em;text-transform:uppercase;padding:14px 12px 4px;font-weight:600}
.nav-footer{padding:14px 12px;border-top:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;gap:8px}
.live-chip{display:flex;align-items:center;gap:8px;padding:7px 11px;background:rgba(10,123,108,.22);border:1px solid rgba(10,123,108,.38);border-radius:var(--r2);font-size:.7rem;color:var(--teal2);font-weight:600}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--teal2);box-shadow:0 0 6px var(--teal2);animation:livepulse 1.8s ease-in-out infinite;flex-shrink:0}
.mic-chip{display:flex;align-items:center;gap:8px;padding:7px 11px;background:rgba(123,26,156,.22);border:1px solid rgba(123,26,156,.38);border-radius:var(--r2);font-size:.7rem;color:#c46be8;font-weight:600;cursor:pointer;transition:all .2s}
.mic-chip:hover{background:rgba(123,26,156,.35)}
.mic-chip.listening{background:rgba(123,26,156,.4);border-color:rgba(123,26,156,.8)}
.mic-dot{width:7px;height:7px;border-radius:50%;background:#c46be8;box-shadow:0 0 6px #c46be8;flex-shrink:0}
@keyframes livepulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.7)}}
.main-content{flex:1;overflow:hidden;display:flex;flex-direction:column}
.page{display:none;flex:1;overflow-y:auto}
.page.active{display:flex;flex-direction:column}
.page-header{padding:26px 30px 0;display:flex;align-items:flex-start;justify-content:space-between;flex-shrink:0}
.page-title{font-family:var(--ff-head);font-size:1.75rem;font-weight:500;color:var(--ink);letter-spacing:-.02em;line-height:1.2}
.page-subtitle{font-size:.8rem;color:var(--ink3);margin-top:4px}
.page-actions{display:flex;align-items:center;gap:8px}
.btn{padding:8px 16px;border-radius:var(--r2);font-family:var(--ff-body);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s;border:none;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--teal);color:#fff}
.btn-primary:hover{background:var(--teal2)}
.btn-danger{background:var(--red);color:#fff}
.btn-danger:hover{background:#a93226}
.btn-ghost{background:transparent;border:1.5px solid var(--border2);color:var(--ink2)}
.btn-ghost:hover{border-color:var(--ink3);background:var(--cream2)}
.btn-sm{padding:5px 11px;font-size:.74rem}
.btn-purple{background:var(--purple);color:#fff}
.btn-purple:hover{background:#9b22c2}

/* ‚ïê‚ïê‚ïê MONITOR PAGE ‚ïê‚ïê‚ïê */
.monitor-body{padding:22px 30px 30px;display:grid;grid-template-columns:1fr 310px;gap:18px;flex:1}
.hri-hero{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:26px;display:flex;align-items:center;gap:28px;grid-column:1/-1;position:relative;overflow:hidden}
.hri-hero::before{content:'';position:absolute;right:-60px;top:-60px;width:250px;height:250px;border-radius:50%;background:var(--teal-lt);opacity:.45}
.hri-gauge-box{position:relative;flex-shrink:0}
.hri-score-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-44%);font-family:var(--ff-head);font-size:2.8rem;font-weight:700;line-height:1;transition:color .5s}
.hri-score-label{position:absolute;bottom:16%;left:50%;transform:translateX(-50%);font-size:.62rem;font-weight:600;color:var(--ink3);letter-spacing:.08em;text-transform:uppercase;white-space:nowrap}
.hri-hero-info{flex:1;position:relative;z-index:1}
.hri-status-badge{display:inline-flex;align-items:center;gap:7px;padding:5px 14px;border-radius:20px;font-size:.76rem;font-weight:700;letter-spacing:.04em;margin-bottom:10px;transition:all .4s}
.hri-hero-title{font-family:var(--ff-head);font-size:1.4rem;font-weight:500;color:var(--ink);line-height:1.3;margin-bottom:7px}
.hri-hero-desc{font-size:.82rem;color:var(--ink3);line-height:1.6;max-width:440px}
.hri-meta{display:flex;gap:20px;margin-top:14px;flex-wrap:wrap}
.hri-meta-item{display:flex;flex-direction:column;gap:2px}
.hri-meta-val{font-family:var(--ff-head);font-size:1.05rem;font-weight:500;color:var(--ink)}
.hri-meta-lbl{font-size:.65rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.06em}

/* Signal grid */
.signal-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;grid-column:1}
.sig-card{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:14px 16px 12px;position:relative;overflow:hidden;transition:box-shadow .2s,border-color .3s}
.sig-card:hover{box-shadow:var(--shadow-lg)}
.sig-card.alert-anim{border-color:var(--red);animation:card-pulse 2s ease infinite}
@keyframes card-pulse{0%,100%{box-shadow:var(--shadow)}50%{box-shadow:0 0 0 3px rgba(192,57,43,.15),var(--shadow-lg)}}
.sig-card-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.sig-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0}
.sig-status-dot{width:7px;height:7px;border-radius:50%;background:var(--green)}
.sig-name{font-size:.68rem;font-weight:600;color:var(--ink3);letter-spacing:.04em;text-transform:uppercase;margin-bottom:1px}
.sig-val-row{display:flex;align-items:baseline;gap:4px;margin-bottom:8px}
.sig-val{font-family:var(--ff-head);font-size:1.8rem;font-weight:500;line-height:1;transition:color .3s}
.sig-unit{font-size:.72rem;color:var(--ink3);font-weight:500}
.sig-range{font-size:.65rem;color:var(--ink3);margin-bottom:6px}
.sig-bar-track{height:4px;border-radius:2px;background:var(--cream2);overflow:hidden}
.sig-bar-fill{height:100%;border-radius:2px;transition:width .4s ease,background .4s}
.sig-mini-wrap{height:34px;margin-top:7px}
canvas.sig-mini{display:block;width:100%;height:34px}
.sig-trend{font-size:.62rem;color:var(--ink3);margin-top:5px;display:flex;align-items:center;gap:3px}

/* Right column */
.monitor-right{display:flex;flex-direction:column;gap:12px}
.alert-banner{border-radius:var(--r);padding:14px;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow);display:none}
.alert-banner.show{display:block}
.alert-banner-top{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.alert-banner-icon{font-size:1.1rem}
.alert-banner-level{font-size:.72rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase}
.alert-banner-time{font-size:.65rem;color:var(--ink3);margin-left:auto}
.alert-banner-msg{font-size:.78rem;color:var(--ink2);line-height:1.5}
.alert-banner-signals{display:flex;gap:5px;flex-wrap:wrap;margin-top:8px}
.signal-chip{padding:2px 8px;border-radius:20px;font-size:.65rem;font-weight:600;background:var(--cream2);color:var(--ink2)}
.widget{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:16px}
.widget-title{font-size:.7rem;font-weight:600;color:var(--ink3);letter-spacing:.06em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
.corr-heatmap{display:grid;gap:3px}
.corr-cell{aspect-ratio:1;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:.5rem;font-weight:700;transition:all .5s;cursor:default}
.corr-row-label{font-size:.55rem;color:var(--ink3);display:flex;align-items:center;justify-content:center;font-weight:600}
.corr-col-labels{gap:3px;margin-top:3px}
.corr-col-label{font-size:.52rem;color:var(--ink3);text-align:center;font-weight:600}
.scenario-btns{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:8px}
.scenario-btn{padding:6px 7px;border-radius:var(--r2);font-size:.7rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:var(--cream);color:var(--ink2);transition:all .15s;text-align:center}
.scenario-btn:hover{border-color:var(--teal);color:var(--teal);background:var(--teal-lt)}
.scenario-btn.active{border-color:var(--teal);background:var(--teal);color:#fff}
.scenario-btn.full{grid-column:1/-1}

/* ‚ïê‚ïê‚ïê SMART ALERTS PANEL ‚ïê‚ïê‚ïê */
.smart-alerts-panel{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px;max-width:340px;pointer-events:none}
.smart-alert-toast{background:#fff;border-radius:14px;border:1.5px solid var(--border);box-shadow:0 8px 32px rgba(0,0,0,.14);padding:14px 16px;display:flex;align-items:flex-start;gap:11px;pointer-events:all;transform:translateX(120%);transition:transform .4s cubic-bezier(.34,1.56,.64,1),opacity .3s;opacity:0;cursor:pointer}
.smart-alert-toast.show{transform:translateX(0);opacity:1}
.smart-alert-toast.emergency{border-color:var(--red);background:var(--red-lt);animation:emergency-pulse 1s ease infinite}
@keyframes emergency-pulse{0%,100%{box-shadow:0 8px 32px rgba(192,57,43,.2)}50%{box-shadow:0 8px 48px rgba(192,57,43,.5),0 0 0 4px rgba(192,57,43,.15)}}
.sa-icon{font-size:1.5rem;flex-shrink:0;margin-top:1px}
.sa-body{flex:1;min-width:0}
.sa-title{font-size:.82rem;font-weight:700;color:var(--ink);margin-bottom:2px}
.sa-msg{font-size:.74rem;color:var(--ink3);line-height:1.45}
.sa-time{font-size:.64rem;color:var(--ink3);margin-top:4px}
.sa-dismiss{font-size:.7rem;color:var(--ink3);cursor:pointer;padding:2px 6px;border-radius:4px;background:var(--cream2);border:none;font-family:var(--ff-body);flex-shrink:0;margin-top:1px}
.sa-dismiss:hover{background:var(--cream3)}

/* ‚ïê‚ïê‚ïê ALARM CLOCK MODAL ‚ïê‚ïê‚ïê */
.alarm-modal{position:fixed;inset:0;background:rgba(26,20,16,.6);backdrop-filter:blur(4px);z-index:10000;display:none;align-items:center;justify-content:center}
.alarm-modal.show{display:flex}
.alarm-box{background:#fff;border-radius:20px;padding:32px;max-width:440px;width:90%;box-shadow:0 24px 80px rgba(0,0,0,.18);text-align:center;animation:alarm-ring 0.6s ease}
@keyframes alarm-ring{0%,100%{transform:rotate(0)}15%{transform:rotate(-3deg)}30%{transform:rotate(3deg)}45%{transform:rotate(-2deg)}60%{transform:rotate(2deg)}75%{transform:rotate(-1deg)}}
.alarm-ring-icon{font-size:3rem;margin-bottom:12px;animation:alarm-ring 0.6s linear infinite}
.alarm-box-time{font-family:var(--ff-head);font-size:3.5rem;font-weight:700;color:var(--ink);line-height:1;margin-bottom:6px}
.alarm-box-label{font-size:1.1rem;color:var(--ink3);margin-bottom:22px}
.alarm-btns{display:flex;gap:10px;justify-content:center}

/* ‚ïê‚ïê‚ïê EMERGENCY CALL MODAL ‚ïê‚ïê‚ïê */
.emergency-modal{position:fixed;inset:0;background:rgba(192,57,43,.85);backdrop-filter:blur(6px);z-index:10001;display:none;align-items:center;justify-content:center}
.emergency-modal.show{display:flex;animation:fadeIn .3s ease}
.emergency-box{background:#fff;border-radius:20px;padding:32px 28px;max-width:480px;width:92%;box-shadow:0 24px 80px rgba(0,0,0,.3)}
.emergency-header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.emergency-icon{font-size:2.5rem;animation:livepulse 1s ease infinite}
.emergency-title{font-family:var(--ff-head);font-size:1.4rem;font-weight:700;color:var(--red)}
.emergency-subtitle{font-size:.8rem;color:var(--ink3)}
.call-list{display:flex;flex-direction:column;gap:8px;margin-bottom:18px}
.call-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;border:1px solid var(--border)}
.call-item.calling{border-color:var(--red);background:var(--red-lt);animation:card-pulse 1.5s ease infinite}
.call-item.called{border-color:var(--green);background:var(--green-lt)}
.call-icon{font-size:1.3rem}
.call-info{flex:1}
.call-name{font-size:.82rem;font-weight:600;color:var(--ink)}
.call-number{font-size:.72rem;color:var(--ink3)}
.call-status{font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:10px}
.call-status.calling{color:var(--red);background:var(--red-lt)}
.call-status.called{color:var(--green);background:var(--green-lt)}
.call-status.pending{color:var(--ink3);background:var(--cream2)}
.emergency-countdown{text-align:center;margin-bottom:16px}
.ems-count{font-family:var(--ff-head);font-size:2.5rem;font-weight:700;color:var(--red)}
.ems-count-label{font-size:.78rem;color:var(--ink3)}

/* ‚ïê‚ïê‚ïê CHATBOT ‚ïê‚ïê‚ïê */
.chatbot-fab{position:fixed;bottom:24px;left:24px;z-index:9998;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--teal2));box-shadow:0 4px 20px rgba(10,123,108,.4);border:none;cursor:pointer;font-size:1.4rem;display:flex;align-items:center;justify-content:center;transition:transform .2s,box-shadow .2s}
.chatbot-fab:hover{transform:scale(1.08);box-shadow:0 6px 28px rgba(10,123,108,.55)}
.chatbot-fab .chat-badge{position:absolute;top:-2px;right:-2px;width:18px;height:18px;border-radius:50%;background:var(--red);color:#fff;font-size:.6rem;font-weight:700;display:none;align-items:center;justify-content:center;border:2px solid #fff}
.chatbot-fab .chat-badge.show{display:flex}
.chatbot-panel{position:fixed;bottom:90px;left:24px;z-index:9998;width:360px;background:#fff;border-radius:16px;border:1px solid var(--border);box-shadow:0 16px 60px rgba(0,0,0,.14);display:none;flex-direction:column;overflow:hidden;max-height:520px}
.chatbot-panel.open{display:flex;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.chat-header{background:linear-gradient(135deg,var(--teal),var(--teal2));padding:14px 16px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.chat-avatar{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.chat-name{font-size:.88rem;font-weight:700;color:#fff}
.chat-status{font-size:.65rem;color:rgba(255,255,255,.75)}
.chat-close{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.7);font-size:1.1rem;cursor:pointer;padding:2px 6px;border-radius:6px}
.chat-close:hover{background:rgba(255,255,255,.15);color:#fff}
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;min-height:200px}
.chat-msg{max-width:84%;padding:9px 12px;border-radius:12px;font-size:.78rem;line-height:1.55}
.chat-msg.bot{background:var(--cream2);color:var(--ink);border-bottom-left-radius:4px;align-self:flex-start}
.chat-msg.user{background:var(--teal);color:#fff;border-bottom-right-radius:4px;align-self:flex-end;text-align:right}
.chat-msg.emergency-msg{background:var(--red-lt);border:1.5px solid var(--red-mid);color:var(--red)}
.chat-typing{display:flex;gap:4px;align-items:center;padding:8px 12px;background:var(--cream2);border-radius:12px;width:fit-content;align-self:flex-start}
.chat-typing span{width:6px;height:6px;border-radius:50%;background:var(--ink3);animation:typingBounce .8s ease infinite}
.chat-typing span:nth-child(2){animation-delay:.16s}
.chat-typing span:nth-child(3){animation-delay:.32s}
@keyframes typingBounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-6px)}}
.chat-quick-btns{padding:8px 14px;display:flex;gap:6px;flex-wrap:wrap;border-top:1px solid var(--border);flex-shrink:0}
.chat-quick-btn{padding:5px 10px;border-radius:20px;border:1.5px solid var(--teal);color:var(--teal);background:var(--teal-lt);font-size:.7rem;font-weight:600;cursor:pointer;transition:all .15s;font-family:var(--ff-body)}
.chat-quick-btn:hover{background:var(--teal);color:#fff}
.chat-input-row{padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-shrink:0}
.chat-input{flex:1;border:1.5px solid var(--border2);border-radius:10px;padding:8px 12px;font-family:var(--ff-body);font-size:.78rem;color:var(--ink);outline:none;background:var(--cream)}
.chat-input:focus{border-color:var(--teal);background:#fff}
.chat-send-btn{width:36px;height:36px;border-radius:50%;background:var(--teal);border:none;color:#fff;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.chat-send-btn:hover{background:var(--teal2)}

/* ‚ïê‚ïê‚ïê SMART SCHEDULE PANEL ‚ïê‚ïê‚ïê */
.schedule-panel{position:fixed;top:50%;right:24px;transform:translateY(-50%);z-index:9000;width:260px;background:#fff;border-radius:14px;border:1px solid var(--border);box-shadow:var(--shadow-lg);padding:14px;display:none}
.schedule-panel.show{display:block;animation:slideUp .3s ease}
.schedule-title{font-size:.72rem;font-weight:700;color:var(--ink);letter-spacing:.04em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.schedule-item{display:flex;align-items:center;gap:9px;padding:8px;border-radius:8px;margin-bottom:5px;cursor:pointer;transition:background .15s}
.schedule-item:hover{background:var(--cream)}
.schedule-item.done{opacity:.5}
.schedule-item.active-now{background:var(--teal-lt);border:1px solid var(--teal-mid)}
.sched-icon{font-size:1.1rem;flex-shrink:0}
.sched-info{flex:1}
.sched-name{font-size:.76rem;font-weight:600;color:var(--ink)}
.sched-time{font-size:.65rem;color:var(--ink3)}
.sched-check{width:18px;height:18px;border-radius:50%;border:1.5px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:.6rem;flex-shrink:0}
.sched-check.done{background:var(--teal);border-color:var(--teal);color:#fff}

/* ‚ïê‚ïê‚ïê DISEASE MONITOR ‚ïê‚ïê‚ïê */
.disease-card{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:16px;margin-bottom:8px}
.disease-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:.68rem;font-weight:700;letter-spacing:.04em;margin-bottom:8px}
.risk-meter{height:8px;border-radius:4px;background:var(--cream2);overflow:hidden;margin:6px 0}
.risk-fill{height:100%;border-radius:4px;transition:width .6s ease}

/* ‚ïê‚ïê‚ïê MIC ANALYSIS WIDGET ‚ïê‚ïê‚ïê */
.mic-widget{background:linear-gradient(135deg,#2D1B42,#1A1028);border-radius:var(--r);border:1px solid rgba(196,107,232,.25);box-shadow:var(--shadow);padding:16px;position:relative;overflow:hidden}
.mic-widget::before{content:'';position:absolute;top:-40px;right:-40px;width:120px;height:120px;border-radius:50%;background:rgba(196,107,232,.08)}
.mic-widget-title{font-size:.7rem;font-weight:600;color:rgba(255,255,255,.6);letter-spacing:.06em;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.mic-widget-title span{color:#c46be8}
.mic-visualizer{height:42px;background:rgba(255,255,255,.04);border-radius:8px;overflow:hidden;margin-bottom:10px;position:relative}
.mic-canvas{display:block;width:100%;height:42px}
.mic-detections{display:flex;flex-direction:column;gap:4px}
.mic-det-row{display:flex;align-items:center;justify-content:space-between;padding:5px 9px;border-radius:6px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
.mic-det-label{font-size:.7rem;color:rgba(255,255,255,.7);display:flex;align-items:center;gap:5px}
.mic-det-conf{font-size:.7rem;font-weight:700;color:#c46be8}
.mic-det-bar{flex:1;height:4px;background:rgba(255,255,255,.08);border-radius:2px;margin:0 10px;overflow:hidden}
.mic-det-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,#7B1A9C,#c46be8);transition:width .5s ease}
.mic-start-btn{width:100%;padding:8px;border:none;border-radius:8px;background:rgba(123,26,156,.5);border:1px solid rgba(196,107,232,.35);color:#c46be8;font-size:.75rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:var(--ff-body);margin-top:8px;display:flex;align-items:center;justify-content:center;gap:6px}
.mic-start-btn:hover{background:rgba(123,26,156,.7)}
.mic-start-btn.active{background:rgba(192,57,43,.5);border-color:rgba(192,57,43,.6);color:#f0a0a0}

/* ‚ïê‚ïê‚ïê STEP COUNT CARD ‚ïê‚ïê‚ïê */
.steps-ring-container{display:flex;align-items:center;gap:14px;margin-top:2px}
.steps-info{flex:1}
.steps-val{font-family:var(--ff-head);font-size:2rem;font-weight:600;color:var(--teal);line-height:1}
.steps-goal{font-size:.7rem;color:var(--ink3);margin-top:2px}
.steps-badges{display:flex;gap:4px;flex-wrap:wrap;margin-top:7px}
.steps-badge{padding:2px 8px;border-radius:12px;font-size:.64rem;font-weight:600}

/* ‚ïê‚ïê‚ïê FEVER / BODY TEMP GAUGE ‚ïê‚ïê‚ïê */
.fever-card{background:linear-gradient(135deg,#fff8ee,#fff);border-radius:var(--r);border:1px solid rgba(201,123,26,.2);box-shadow:var(--shadow);padding:16px}
.fever-zones{display:flex;gap:4px;margin:10px 0;height:8px;border-radius:4px;overflow:hidden}
.fever-zone{flex:1;transition:opacity .3s}
.fever-zone.active-zone{position:relative;box-shadow:0 0 8px currentColor}
.fever-arrow{width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;transition:margin-left .5s ease}
.fever-labels{display:flex;justify-content:space-between;font-size:.58rem;color:var(--ink3);margin-top:4px}
.fever-status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-size:.74rem;font-weight:700;margin-top:8px}

/* ‚ïê‚ïê‚ïê ALERTS PAGE ‚ïê‚ïê‚ïê */
.alerts-body{padding:22px 30px 40px;display:flex;flex-direction:column;gap:18px}
.alert-stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stat-card{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:16px 18px}
.stat-card-val{font-family:var(--ff-head);font-size:1.9rem;font-weight:500;line-height:1;color:var(--ink);margin-bottom:3px}
.stat-card-lbl{font-size:.7rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em}
.alert-filter-row{display:flex;align-items:center;gap:7px;flex-wrap:wrap}
.filter-chip{padding:5px 12px;border-radius:20px;font-size:.73rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:#fff;color:var(--ink2);transition:all .15s}
.filter-chip.active{border-color:var(--teal);background:var(--teal-lt);color:var(--teal)}
.filter-chip:hover{border-color:var(--teal)}
.alert-list{display:flex;flex-direction:column;gap:9px}
.alert-row{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:14px 18px;display:flex;align-items:flex-start;gap:14px;cursor:pointer;transition:box-shadow .15s}
.alert-row:hover{box-shadow:var(--shadow-lg)}
.alert-row-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;margin-top:2px}
.alert-row-body{flex:1;min-width:0}
.alert-row-top{display:flex;align-items:center;gap:7px;margin-bottom:3px}
.alert-row-level{font-size:.68rem;font-weight:700;letter-spacing:.06em;text-transform:uppercase;padding:2px 8px;border-radius:20px}
.alert-row-hri{font-size:.7rem;font-weight:700;color:var(--ink2)}
.alert-row-time{margin-left:auto;font-size:.7rem;color:var(--ink3)}
.alert-row-title{font-size:.85rem;font-weight:600;color:var(--ink);margin-bottom:2px}
.alert-row-desc{font-size:.75rem;color:var(--ink3);line-height:1.5}
.alert-row-signals{display:flex;gap:5px;flex-wrap:wrap;margin-top:7px}

/* ‚ïê‚ïê‚ïê HISTORY PAGE ‚ïê‚ïê‚ïê */
.history-body{padding:22px 30px 40px;display:flex;flex-direction:column;gap:18px}
.history-tabs{display:flex;gap:0;background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:4px;width:fit-content}
.history-tab{padding:6px 18px;border-radius:var(--r2);font-size:.78rem;font-weight:600;cursor:pointer;color:var(--ink3);border:none;background:none;transition:all .15s}
.history-tab.active{background:var(--teal);color:#fff}
.history-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.history-card{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:18px}
.history-card-full{grid-column:1/-1}
.history-card-title{font-family:var(--ff-head);font-size:.95rem;font-weight:500;color:var(--ink);margin-bottom:3px}
.history-card-sub{font-size:.72rem;color:var(--ink3);margin-bottom:14px}
canvas.history-chart{display:block;width:100%;border-radius:6px}
.trend-indicators{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-top:12px}
.trend-item{padding:11px;background:var(--cream);border-radius:var(--r2);text-align:center}
.trend-val{font-family:var(--ff-head);font-size:1.25rem;font-weight:500;color:var(--ink);margin-bottom:2px}
.trend-lbl{font-size:.65rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em}
.pattern-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.pattern-card{padding:12px;border-radius:var(--r2);border:1px solid var(--border)}
.pattern-card-title{font-size:.76rem;font-weight:600;color:var(--ink);margin-bottom:3px}
.pattern-card-body{font-size:.7rem;color:var(--ink3);line-height:1.5}
.daily-summary{display:flex;flex-direction:column;gap:7px}
.day-row{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--cream);border-radius:var(--r2)}
.day-label{font-size:.78rem;font-weight:600;color:var(--ink);width:80px;flex-shrink:0}
.day-bar-track{flex:1;height:8px;border-radius:4px;background:var(--cream2);overflow:hidden}
.day-bar-fill{height:100%;border-radius:4px;transition:width 1s ease}
.day-score{font-size:.76rem;font-weight:700;width:32px;text-align:right;flex-shrink:0}
.day-events{font-size:.68rem;color:var(--ink3);width:80px;text-align:right;flex-shrink:0}

/* ‚ïê‚ïê‚ïê SETTINGS PAGE ‚ïê‚ïê‚ïê */
.settings-body{padding:22px 30px 40px;display:grid;grid-template-columns:300px 1fr;gap:20px;align-items:start}
.settings-nav{display:flex;flex-direction:column;gap:4px}
.settings-nav-item{padding:10px 14px;border-radius:var(--r2);font-size:.82rem;font-weight:500;cursor:pointer;border:none;background:none;text-align:left;color:var(--ink2);transition:all .15s;font-family:var(--ff-body);display:flex;align-items:center;gap:8px}
.settings-nav-item:hover{background:var(--cream2);color:var(--ink)}
.settings-nav-item.active{background:var(--teal-lt);color:var(--teal);font-weight:600}
.settings-content{display:flex;flex-direction:column;gap:16px}
.settings-card{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:22px}
.settings-card-title{font-family:var(--ff-head);font-size:1.05rem;font-weight:500;color:var(--ink);margin-bottom:4px}
.settings-card-sub{font-size:.75rem;color:var(--ink3);margin-bottom:18px;line-height:1.5}
.settings-section{display:none}
.settings-section.active{display:block}
.form-group{margin-bottom:16px}
.form-label{font-size:.72rem;font-weight:600;color:var(--ink2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.form-input{width:100%;padding:9px 13px;border-radius:var(--r2);border:1.5px solid var(--border2);font-family:var(--ff-body);font-size:.85rem;color:var(--ink);background:#fff;transition:border-color .15s}
.form-input:focus{outline:none;border-color:var(--teal)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-select{width:100%;padding:9px 13px;border-radius:var(--r2);border:1.5px solid var(--border2);font-family:var(--ff-body);font-size:.85rem;color:var(--ink);background:#fff;cursor:pointer}
.form-select:focus{outline:none;border-color:var(--teal)}

/* Sensor status cards */
.sensor-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:18px}
.sensor-card{border-radius:var(--r2);border:1.5px solid var(--border);padding:14px;display:flex;align-items:flex-start;gap:10px;transition:all .2s;cursor:pointer}
.sensor-card:hover{border-color:var(--teal);box-shadow:var(--shadow)}
.sensor-card.connected{border-color:var(--teal);background:var(--teal-lt)}
.sensor-card.error{border-color:var(--red);background:var(--red-lt)}
.sensor-card.searching{border-color:var(--amber);background:var(--amber-lt)}
.sensor-icon{font-size:1.4rem;flex-shrink:0}
.sensor-name{font-size:.82rem;font-weight:600;color:var(--ink);margin-bottom:2px}
.sensor-desc{font-size:.7rem;color:var(--ink3)}
.sensor-status{font-size:.68rem;font-weight:700;margin-top:6px;display:inline-flex;align-items:center;gap:4px}
.sensor-status.ok{color:var(--teal)}
.sensor-status.err{color:var(--red)}
.sensor-status.search{color:var(--amber)}
.sensor-dot{width:6px;height:6px;border-radius:50%;display:inline-block}

/* Toggle switch */
.toggle-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
.toggle-row:last-child{border-bottom:none}
.toggle-label{font-size:.82rem;color:var(--ink2);font-weight:500}
.toggle-desc{font-size:.7rem;color:var(--ink3);margin-top:2px}
.toggle{position:relative;width:40px;height:22px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:var(--cream3);border-radius:22px;transition:.3s}
.slider:before{content:'';position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
input:checked+.slider{background:var(--teal)}
input:checked+.slider:before{transform:translateX(18px)}

/* Range slider */
.range-row{display:flex;align-items:center;gap:12px}
.range-slider{-webkit-appearance:none;flex:1;height:5px;border-radius:3px;background:var(--cream2);outline:none}
.range-slider::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--teal);cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.range-val{font-size:.82rem;font-weight:600;color:var(--teal);width:50px;text-align:right}

/* Connection panel */
.conn-input-row{display:flex;gap:8px;align-items:flex-end}
.conn-status-bar{padding:10px 14px;border-radius:var(--r2);background:var(--cream);font-size:.78rem;color:var(--ink3);display:flex;align-items:center;gap:8px;margin-top:10px}
.protocol-tabs{display:flex;gap:4px;margin-bottom:16px}
.proto-tab{padding:6px 14px;border-radius:var(--r2);font-size:.76rem;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:#fff;color:var(--ink3);transition:all .15s}
.proto-tab.active{border-color:var(--teal);background:var(--teal-lt);color:var(--teal)}

/* ‚ïê‚ïê‚ïê PROFILE PAGE ‚ïê‚ïê‚ïê */
.profile-body{padding:22px 30px 40px;display:grid;grid-template-columns:300px 1fr;gap:20px;align-items:start}
.profile-card{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:26px;text-align:center}
.profile-avatar-lg{width:80px;height:80px;border-radius:50%;background:var(--teal);display:flex;align-items:center;justify-content:center;font-family:var(--ff-head);font-size:1.9rem;font-weight:700;color:#fff;margin:0 auto 14px;cursor:pointer;transition:opacity .2s}
.profile-avatar-lg:hover{opacity:.85}
.profile-name{font-family:var(--ff-head);font-size:1.45rem;font-weight:500;color:var(--ink);margin-bottom:3px}
.profile-id{font-size:.7rem;color:var(--ink3);margin-bottom:18px}
.profile-stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:14px}
.profile-stat{padding:9px;background:var(--cream);border-radius:var(--r2);text-align:left}
.profile-stat-val{font-family:var(--ff-head);font-size:1.05rem;font-weight:500;color:var(--ink);margin-bottom:1px}
.profile-stat-lbl{font-size:.62rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em}
.profile-right{display:flex;flex-direction:column;gap:14px}
.info-section{background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:20px 22px}
.info-section-title{font-family:var(--ff-head);font-size:.95rem;font-weight:500;color:var(--ink);margin-bottom:12px;padding-bottom:9px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.info-item{display:flex;flex-direction:column;gap:2px}
.info-label{font-size:.65rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em}
.info-value{font-size:.85rem;font-weight:500;color:var(--ink)}
.baseline-bars{display:flex;flex-direction:column;gap:9px}
.baseline-row{display:flex;align-items:center;gap:9px}
.baseline-sig-name{font-size:.72rem;color:var(--ink2);width:120px;flex-shrink:0;font-weight:500}
.baseline-track{flex:1;height:6px;background:var(--cream2);border-radius:3px;overflow:hidden}
.baseline-fill{height:100%;border-radius:3px}
.baseline-val{font-size:.7rem;font-weight:600;color:var(--ink2);width:70px;text-align:right;flex-shrink:0;font-family:var(--ff-head)}

/* Edit modal */
.modal-overlay{position:fixed;inset:0;background:rgba(26,20,16,.5);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal-overlay.show{display:flex}
.modal{background:#fff;border-radius:var(--r);box-shadow:var(--shadow-lg);padding:28px;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto;animation:fadein .25s ease}
.modal-title{font-family:var(--ff-head);font-size:1.3rem;font-weight:500;color:var(--ink);margin-bottom:4px}
.modal-sub{font-size:.78rem;color:var(--ink3);margin-bottom:22px}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:22px;padding-top:16px;border-top:1px solid var(--border)}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast{position:fixed;top:18px;right:18px;z-index:1000;background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow-lg);padding:13px 16px;max-width:310px;display:flex;gap:11px;align-items:flex-start;transform:translateX(360px);transition:transform .3s cubic-bezier(0.34,1.56,0.64,1)}
.toast.show{transform:translateX(0)}
.toast-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px}
.toast-title{font-size:.8rem;font-weight:700;color:var(--ink);margin-bottom:2px}
.toast-msg{font-size:.72rem;color:var(--ink3);line-height:1.4}
.toast-close{margin-left:auto;flex-shrink:0;background:none;border:none;cursor:pointer;color:var(--ink3);font-size:.95rem;padding:0}

/* Misc */
.divider{height:1px;background:var(--border);margin:4px 0}
.empty-state{text-align:center;padding:38px;color:var(--ink3);font-size:.82rem}
.empty-state-icon{font-size:2.4rem;margin-bottom:11px;opacity:.5}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--cream3);border-radius:3px}
@keyframes fadein{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.fadein{animation:fadein .35s ease both}
@keyframes pulse-border{0%,100%{border-color:rgba(196,107,232,.3)}50%{border-color:rgba(196,107,232,.9)}}
.waveform-bar{display:inline-block;width:3px;border-radius:2px;background:#c46be8;margin:0 1px;transition:height .1s ease;transform-origin:bottom center}

@media(max-width:1200px){.signal-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:1000px){.signal-grid{grid-template-columns:repeat(2,1fr)}.monitor-body{grid-template-columns:1fr 270px}}
@media(max-width:820px){.nav{width:60px}.nav-brand-name,.nav-brand-sub,.nav-patient,.nav-link span:not(.icon),.live-chip span,.mic-chip span,.nav-section-label{display:none}.nav-link{justify-content:center;padding:11px}.monitor-body{grid-template-columns:1fr;padding:16px}.monitor-right{display:none}.signal-grid{grid-template-columns:repeat(2,1fr)}.page-header{padding:18px 16px 0}.settings-body,.profile-body{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app-shell">

<!-- ‚ïê‚ïê‚ïê NAV ‚ïê‚ïê‚ïê -->
<nav class="nav">
  <div class="nav-brand">
    <div class="nav-brand-name">PulseIQ <span style="font-size:.7rem;color:var(--teal2);font-family:var(--ff-body);font-weight:600">PRO</span></div>
    <div class="nav-brand-sub">Adaptive Intelligence v3</div>
  </div>
  <div class="nav-patient" onclick="openEditModal()">
    <div class="nav-avatar" id="nav-avatar">AK</div>
    <div>
      <div class="nav-patient-name" id="nav-name">Alex Kumar</div>
      <div class="nav-patient-id" id="nav-pid">PHM-2841 ¬∑ Edit ‚úèÔ∏è</div>
    </div>
  </div>
  <div class="nav-links">
    <div class="nav-section-label">Monitoring</div>
    <button class="nav-link active" onclick="showPage('monitor',this)"><span class="icon">üíì</span><span>Live Monitor</span></button>
    <button class="nav-link" onclick="showPage('alerts',this)"><span class="icon">üîî</span><span>Alerts</span><span class="nav-badge" id="alert-nav-badge">0</span></button>
    <button class="nav-link" onclick="showPage('history',this)"><span class="icon">üìà</span><span>History</span></button>
    <div class="nav-section-label">Tools</div>
    <button class="nav-link" onclick="showPage('mic',this)"><span class="icon">üéôÔ∏è</span><span>Behaviour AI</span></button>
    <button class="nav-link" onclick="showPage('wellness',this)"><span class="icon">üèÉ</span><span>Wellness</span></button>
    <button class="nav-link" onclick="showPage('schedule',this)"><span class="icon">‚è∞</span><span>Smart Schedule</span></button>
    <button class="nav-link" onclick="showPage('diseases',this)"><span class="icon">ü©∫</span><span>Disease Monitor</span></button>
    <div class="nav-section-label">Account</div>
    <button class="nav-link" onclick="showPage('profile',this)"><span class="icon">üë§</span><span>My Profile</span></button>
    <button class="nav-link" onclick="showPage('settings',this)"><span class="icon">‚öôÔ∏è</span><span>Settings</span></button>
  </div>
  <div class="nav-footer">
    <div class="live-chip" id="sensor-chip"><div class="live-dot"></div><span id="sensor-chip-text">Sensors active</span></div>
    <div class="mic-chip" id="nav-mic-btn" onclick="toggleMicFromNav()"><div class="mic-dot" id="nav-mic-dot" style="animation:none"></div><span id="nav-mic-text">Mic off</span></div>
  </div>
</nav>

<div class="main-content">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: LIVE MONITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-monitor">
  <div class="page-header">
    <div>
      <div class="page-title">Live Monitor</div>
      <div class="page-subtitle" id="monitor-time">Updating now ‚Äî 10 Hz sampling</div>
    </div>
    <div class="page-actions">
      <button class="btn btn-ghost btn-sm" onclick="togglePause()" id="pause-btn">‚è∏ Pause</button>
      <button class="btn btn-primary btn-sm" onclick="resetAll()">‚Ü∫ Reset</button>
    </div>
  </div>

  <div class="monitor-body">
    <!-- HRI Hero -->
    <div class="hri-hero fadein">
      <div class="hri-gauge-box">
        <canvas id="hri-canvas" width="160" height="160" style="display:block"></canvas>
        <div class="hri-score-num" id="hri-num">0</div>
        <div class="hri-score-label">HRI SCORE</div>
      </div>
      <div class="hri-hero-info">
        <div class="hri-status-badge" id="hri-badge">‚óè Normal</div>
        <div class="hri-hero-title" id="hri-title">All signals within your personal baseline</div>
        <div class="hri-hero-desc" id="hri-desc">Your multi-signal correlation patterns are stable.</div>
        <div class="hri-meta">
          <div class="hri-meta-item"><span class="hri-meta-val" id="meta-maha">0.0</span><span class="hri-meta-lbl">Deviation Score</span></div>
          <div class="hri-meta-item"><span class="hri-meta-val" id="meta-lstm">0.0</span><span class="hri-meta-lbl">Pattern Score</span></div>
          <div class="hri-meta-item"><span class="hri-meta-val" id="meta-samples">0</span><span class="hri-meta-lbl">Samples</span></div>
          <div class="hri-meta-item"><span class="hri-meta-val" id="meta-uptime">0s</span><span class="hri-meta-lbl">Session</span></div>
          <div class="hri-meta-item"><span class="hri-meta-val" id="meta-steps" style="color:var(--teal)">0</span><span class="hri-meta-lbl">Steps Today</span></div>
          <div class="hri-meta-item"><span class="hri-meta-val" id="meta-fever" style="color:var(--amber)">36.8¬∞</span><span class="hri-meta-lbl">Body Temp</span></div>
        </div>
      </div>
    </div>

    <!-- Signal Cards -->
    <div class="signal-grid" id="signal-grid"></div>

    <!-- Right column -->
    <div class="monitor-right">
      <div class="alert-banner" id="active-alert-banner">
        <div class="alert-banner-top">
          <span class="alert-banner-icon" id="ab-icon">‚ö†Ô∏è</span>
          <span class="alert-banner-level" id="ab-level">Elevated</span>
          <span class="alert-banner-time" id="ab-time"></span>
        </div>
        <div class="alert-banner-msg" id="ab-msg">Alert message here</div>
        <div class="alert-banner-signals" id="ab-signals"></div>
      </div>
      <!-- Prediction Widget -->
      <div class="widget" id="pred-widget" style="background:linear-gradient(135deg,#f0f9f7,#fff);border-color:var(--teal-mid)">
        <div style="font-size:.68rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">üîÆ Risk Prediction (2 min)</div>
        <div style="font-size:.76rem;color:var(--ink3)">Collecting data for prediction‚Ä¶</div>
      </div>
      <!-- Baseline Learning Status -->
      <div class="widget">
        <div id="baseline-learning-status">
          <div style="font-size:.68rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">üß† Baseline Learning</div>
          <div style="height:6px;background:var(--cream2);border-radius:3px;overflow:hidden;margin-bottom:6px"><div style="height:100%;border-radius:3px;background:var(--amber);width:0%;transition:width .5s"></div></div>
          <div style="font-size:.66rem;color:var(--ink3)">Initializing personal model‚Ä¶</div>
        </div>
        <!-- Blood Volume -->
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
          <div style="font-size:.68rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">ü©∏ Blood Volume Estimate</div>
          <div id="blood-volume-display">
            <span style="font-family:var(--ff-head);font-size:1.4rem;font-weight:600;color:#922B21">‚Äî</span>
            <span style="font-size:.7rem;color:var(--ink3);margin-left:4px">Litres</span>
          </div>
          <div style="font-size:.63rem;color:var(--ink3);margin-top:2px">Nadler's formula ¬∑ Height + Weight</div>
        </div>
      </div>
      <!-- Correlation -->
      <div class="widget">
        <div class="widget-title">Signal Correlations <span style="font-size:.58rem;font-weight:400;color:var(--ink3)">Pearson r</span></div>
        <div class="corr-heatmap" id="corr-heatmap"></div>
        <div class="corr-col-labels" id="corr-col-labels" style="display:grid;gap:3px;margin-top:3px"></div>
      </div>
      <!-- Scenarios -->
      <div class="widget">
        <div class="widget-title">Demo Scenarios</div>
        <div class="scenario-btns">
          <button class="scenario-btn full active" onclick="setScenario('normal',this)">‚úì Normal</button>
          <button class="scenario-btn" onclick="setScenario('cardiac',this)">‚ù§Ô∏è Cardiac</button>
          <button class="scenario-btn" onclick="setScenario('hypoxia',this)">ü´Å Hypoxia</button>
          <button class="scenario-btn" onclick="setScenario('infection',this)">ü¶† Infection</button>
          <button class="scenario-btn" onclick="setScenario('fever',this)">üå°Ô∏è High Fever</button>
          <button class="scenario-btn" onclick="setScenario('overexertion',this)">‚ö° Overexertion</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: ALERTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-alerts">
  <div class="page-header">
    <div><div class="page-title">Alerts</div><div class="page-subtitle">Your health event log and notifications</div></div>
    <div class="page-actions"><button class="btn btn-ghost btn-sm" onclick="clearAlerts()">Clear All</button></div>
  </div>
  <div class="alerts-body fadein">
    <div class="alert-stats-row">
      <div class="stat-card"><div class="stat-card-val" id="astat-total">0</div><div class="stat-card-lbl">Total Alerts</div></div>
      <div class="stat-card"><div class="stat-card-val" id="astat-critical" style="color:var(--red)">0</div><div class="stat-card-lbl">Critical / Emergency</div></div>
      <div class="stat-card"><div class="stat-card-val" id="astat-high" style="color:var(--amber)">0</div><div class="stat-card-lbl">High Risk</div></div>
      <div class="stat-card"><div class="stat-card-val" id="astat-resolved" style="color:var(--green)">0</div><div class="stat-card-lbl">Resolved</div></div>
    </div>
    <div class="alert-filter-row">
      <span style="font-size:.73rem;color:var(--ink3);font-weight:600">Filter:</span>
      <button class="filter-chip active" onclick="filterAlerts('all',this)">All</button>
      <button class="filter-chip" onclick="filterAlerts('emergency',this)">Emergency</button>
      <button class="filter-chip" onclick="filterAlerts('critical',this)">Critical</button>
      <button class="filter-chip" onclick="filterAlerts('high',this)">High</button>
      <button class="filter-chip" onclick="filterAlerts('elevated',this)">Elevated</button>
      <button class="filter-chip" onclick="filterAlerts('fever',this)">üå°Ô∏è Fever</button>
      <button class="filter-chip" onclick="filterAlerts('behaviour',this)">üéôÔ∏è Behaviour</button>
    </div>
    <div class="alert-list" id="alert-list">
      <div class="empty-state"><div class="empty-state-icon">üîî</div>No alerts yet.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-history">
  <div class="page-header">
    <div><div class="page-title">History & Analytics</div><div class="page-subtitle">Your health patterns over time</div></div>
    <div class="page-actions">
      <div class="history-tabs">
        <button class="history-tab active" onclick="setHistoryTab('7d',this)">7 Days</button>
        <button class="history-tab" onclick="setHistoryTab('30d',this)">30 Days</button>
        <button class="history-tab" onclick="setHistoryTab('90d',this)">3 Months</button>
      </div>
    </div>
  </div>
  <div class="history-body fadein">
    <div class="history-grid">
      <div class="history-card history-card-full">
        <div class="history-card-title">Health Risk Index ‚Äî Trend</div>
        <div class="history-card-sub">Daily average HRI with risk band overlay</div>
        <canvas class="history-chart" id="hri-trend-chart" height="120"></canvas>
        <div class="trend-indicators">
          <div class="trend-item"><div class="trend-val" id="tr-avg" style="color:var(--teal)">‚Äî</div><div class="trend-lbl">Avg HRI</div></div>
          <div class="trend-item"><div class="trend-val" id="tr-peak" style="color:var(--red)">‚Äî</div><div class="trend-lbl">Peak HRI</div></div>
          <div class="trend-item"><div class="trend-val" id="tr-events" style="color:var(--amber)">‚Äî</div><div class="trend-lbl">Alert Events</div></div>
        </div>
      </div>
      <div class="history-card">
        <div class="history-card-title">Signal Averages</div>
        <div class="history-card-sub">7-day mean vs. your personal baseline</div>
        <canvas class="history-chart" id="sig-avg-chart" height="160"></canvas>
      </div>
      <div class="history-card">
        <div class="history-card-title">Fever & Temperature</div>
        <div class="history-card-sub">Body temperature trend with fever threshold</div>
        <canvas class="history-chart" id="temp-trend-chart" height="160"></canvas>
      </div>
      <div class="history-card">
        <div class="history-card-title">Daily Steps</div>
        <div class="history-card-sub">Step count vs. goal (10,000 steps)</div>
        <canvas class="history-chart" id="steps-chart" height="160"></canvas>
      </div>
      <div class="history-card">
        <div class="history-card-title">AI Pattern Insights</div>
        <div class="history-card-sub">Detected correlation patterns this week</div>
        <div class="pattern-grid" id="pattern-grid"></div>
      </div>
      <div class="history-card history-card-full">
        <div class="history-card-title">Daily Summary</div>
        <div class="history-card-sub">HRI score and events per day</div>
        <div class="daily-summary" id="daily-summary"></div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: BEHAVIOUR AI (MIC) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-mic">
  <div class="page-header">
    <div>
      <div class="page-title">Behaviour AI</div>
      <div class="page-subtitle">Real-time microphone analysis for health behaviour detection</div>
    </div>
    <div class="page-actions">
      <button class="btn btn-purple btn-sm" id="mic-main-btn" onclick="toggleMic()">üéôÔ∏è Start Listening</button>
    </div>
  </div>
  <div style="padding:22px 30px 40px;display:grid;grid-template-columns:1fr 1fr;gap:20px">
    <!-- Live analysis panel -->
    <div style="display:flex;flex-direction:column;gap:16px">
      <div class="settings-card">
        <div class="settings-card-title">Live Audio Analysis</div>
        <div class="settings-card-sub">AI listens for behavioural patterns including smoking, coughing, drinking, and stress indicators</div>
        <div style="background:#1A1028;border-radius:var(--r2);padding:16px;margin-bottom:14px">
          <div style="font-size:.68rem;color:#c46be8;font-weight:600;text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;display:flex;align-items:center;gap:6px">
            <div class="live-dot" id="mic-vis-dot" style="background:#c46be8;box-shadow:0 0 6px #c46be8;animation:none"></div>
            Audio Waveform
          </div>
          <canvas id="mic-waveform" style="width:100%;height:60px;display:block;border-radius:6px"></canvas>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px" id="behaviour-detections">
          <!-- Populated by JS -->
        </div>
        <div style="margin-top:14px;padding:12px;background:var(--cream);border-radius:var(--r2)">
          <div style="font-size:.7rem;color:var(--ink3);font-weight:600;margin-bottom:6px">ü§ñ AI Interpretation</div>
          <div style="font-size:.82rem;color:var(--ink2);line-height:1.6" id="mic-ai-text">Start listening to receive real-time behavioural analysis.</div>
        </div>
      </div>
      <!-- Session stats -->
      <div class="settings-card">
        <div class="settings-card-title">Session Statistics</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:4px">
          <div style="text-align:center;padding:12px;background:var(--cream);border-radius:var(--r2)">
            <div style="font-family:var(--ff-head);font-size:1.5rem;font-weight:500;color:var(--purple)" id="mic-detections-count">0</div>
            <div style="font-size:.64rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Detections</div>
          </div>
          <div style="text-align:center;padding:12px;background:var(--cream);border-radius:var(--r2)">
            <div style="font-family:var(--ff-head);font-size:1.5rem;font-weight:500;color:var(--red)" id="mic-cough-count">0</div>
            <div style="font-size:.64rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Coughs</div>
          </div>
          <div style="text-align:center;padding:12px;background:var(--cream);border-radius:var(--r2)">
            <div style="font-family:var(--ff-head);font-size:1.5rem;font-weight:500;color:var(--amber)" id="mic-session-time">0m</div>
            <div style="font-size:.64rem;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">Session</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Detection log -->
    <div class="settings-card">
      <div class="settings-card-title">Detection Log</div>
      <div class="settings-card-sub">All detected behavioural events with timestamps</div>
      <div style="display:flex;flex-direction:column;gap:7px;max-height:480px;overflow-y:auto" id="mic-log">
        <div class="empty-state" style="padding:24px"><div class="empty-state-icon">üéôÔ∏è</div>No events detected yet.</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: WELLNESS / STEPS / FEVER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-wellness">
  <div class="page-header">
    <div><div class="page-title">Wellness</div><div class="page-subtitle">Activity, fever monitoring, and health goals</div></div>
    <div class="page-actions">
      <button class="btn btn-ghost btn-sm" onclick="addSteps()">+ Add Steps</button>
    </div>
  </div>
  <div style="padding:22px 30px 40px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px">
    <!-- Step counter card -->
    <div class="settings-card" style="grid-column:1/-1">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px;align-items:center">
        <div>
          <div style="font-size:.7rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">Today's Steps</div>
          <div class="steps-val" id="wellness-steps">0</div>
          <div class="steps-goal" id="wellness-steps-goal">Goal: 10,000 ¬∑ 0%</div>
          <div class="steps-badges" id="steps-badges"></div>
        </div>
        <div style="grid-column:2/4">
          <div style="font-size:.68rem;color:var(--ink3);font-weight:600;margin-bottom:6px">Progress</div>
          <div style="height:14px;background:var(--cream2);border-radius:7px;overflow:hidden;margin-bottom:6px">
            <div id="steps-progress-bar" style="height:100%;border-radius:7px;background:linear-gradient(90deg,var(--teal),var(--teal2));transition:width .5s ease;width:0%"></div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
            <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
              <div style="font-family:var(--ff-head);font-size:1rem;color:var(--teal)" id="ws-calories">0</div>
              <div style="font-size:.62rem;color:var(--ink3)">Calories</div>
            </div>
            <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
              <div style="font-family:var(--ff-head);font-size:1rem;color:var(--blue)" id="ws-distance">0.0</div>
              <div style="font-size:.62rem;color:var(--ink3)">km</div>
            </div>
            <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
              <div style="font-family:var(--ff-head);font-size:1rem;color:var(--amber)" id="ws-active">0</div>
              <div style="font-size:.62rem;color:var(--ink3)">Active min</div>
            </div>
            <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
              <div style="font-family:var(--ff-head);font-size:1rem;color:var(--purple)" id="ws-floors">0</div>
              <div style="font-size:.62rem;color:var(--ink3)">Floors</div>
            </div>
          </div>
        </div>
        <div style="text-align:center">
          <canvas id="steps-donut" width="120" height="120" style="display:block;margin:0 auto"></canvas>
        </div>
      </div>
    </div>

    <!-- Fever / Body temp card -->
    <div class="settings-card" style="grid-column:1/3">
      <div class="settings-card-title">üå°Ô∏è Fever Monitor</div>
      <div class="settings-card-sub">Real-time body temperature with clinical zone classification</div>
      <div style="display:flex;align-items:center;gap:20px;margin-bottom:16px">
        <div>
          <div style="font-family:var(--ff-head);font-size:3.5rem;font-weight:500;line-height:1" id="fever-big-val">36.8</div>
          <div style="font-size:.85rem;color:var(--ink3)">¬∞C body temperature</div>
          <div class="fever-status" id="fever-status-badge" style="background:var(--green-lt);color:var(--green)">‚úì Normal</div>
        </div>
        <div style="flex:1">
          <div style="font-size:.68rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">Temperature Zone</div>
          <div class="fever-zones">
            <div class="fever-zone" style="background:#1A7B4A;flex:1" title="Hypothermic <36¬∞C"></div>
            <div class="fever-zone" style="background:#0A7B6C;flex:1.5" title="Sub-normal 36-36.5¬∞C"></div>
            <div class="fever-zone" style="background:#2196F3;flex:2" title="Normal 36.5-37.5¬∞C"></div>
            <div class="fever-zone" style="background:#C97B1A;flex:1.5" title="Low-grade 37.5-38¬∞C"></div>
            <div class="fever-zone" style="background:#E67E22;flex:1.5" title="Fever 38-39¬∞C"></div>
            <div class="fever-zone" style="background:#C0392B;flex:1" title="High Fever 39-40¬∞C"></div>
            <div class="fever-zone" style="background:#8B0000;flex:0.5" title="Hyperpyrexia >40¬∞C"></div>
          </div>
          <div class="fever-labels">
            <span>&lt;36</span><span>36.5</span><span>37</span><span>37.5</span><span>38</span><span>39</span><span>40+</span>
          </div>
          <!-- Arrow indicator -->
          <div style="position:relative;height:14px;margin-top:2px">
            <div id="fever-arrow" style="position:absolute;top:0;font-size:.8rem;transition:left .5s ease">üî∫</div>
          </div>
        </div>
      </div>
      <!-- Temp history mini chart -->
      <canvas id="fever-mini-chart" style="width:100%;height:60px;display:block" height="60"></canvas>
      <!-- Stats row -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:14px">
        <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
          <div style="font-family:var(--ff-head);font-size:1rem;color:var(--blue)" id="temp-min">36.6</div>
          <div style="font-size:.62rem;color:var(--ink3)">Today Min</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
          <div style="font-family:var(--ff-head);font-size:1rem;color:var(--red)" id="temp-max">36.9</div>
          <div style="font-size:.62rem;color:var(--ink3)">Today Max</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
          <div style="font-family:var(--ff-head);font-size:1rem;color:var(--ink)" id="temp-avg">36.8</div>
          <div style="font-size:.62rem;color:var(--ink3)">Average</div>
        </div>
        <div style="text-align:center;padding:8px;background:var(--cream);border-radius:8px">
          <div style="font-family:var(--ff-head);font-size:1rem;color:var(--amber)" id="temp-trend-val">Stable</div>
          <div style="font-size:.62rem;color:var(--ink3)">Trend</div>
        </div>
      </div>
    </div>

    <!-- Goals card -->
    <div class="settings-card">
      <div class="settings-card-title">Daily Goals</div>
      <div style="display:flex;flex-direction:column;gap:12px;margin-top:8px">
        <div>
          <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:5px"><span style="font-weight:600">üë£ Steps</span><span id="g-steps">0 / 10,000</span></div>
          <div style="height:8px;background:var(--cream2);border-radius:4px;overflow:hidden"><div id="gbar-steps" style="height:100%;background:var(--teal);border-radius:4px;transition:width .5s;width:0%"></div></div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:5px"><span style="font-weight:600">üíß Water (glasses)</span><span id="g-water">0 / 8</span></div>
          <div style="height:8px;background:var(--cream2);border-radius:4px;overflow:hidden"><div id="gbar-water" style="height:100%;background:var(--blue);border-radius:4px;transition:width .5s;width:0%"></div></div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:5px"><span style="font-weight:600">üî• Calories</span><span id="g-calories">0 / 2200</span></div>
          <div style="height:8px;background:var(--cream2);border-radius:4px;overflow:hidden"><div id="gbar-calories" style="height:100%;background:var(--orange);border-radius:4px;transition:width .5s;width:0%"></div></div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:5px"><span style="font-weight:600">üò¥ Sleep (hrs)</span><span id="g-sleep">7.5 / 8</span></div>
          <div style="height:8px;background:var(--cream2);border-radius:4px;overflow:hidden"><div id="gbar-sleep" style="height:100%;background:var(--purple);border-radius:4px;transition:width .5s;width:93.75%"></div></div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:12px;display:flex;flex-direction:column;gap:6px">
          <button class="btn btn-primary btn-sm" style="width:100%;justify-content:center" onclick="addWater()">üíß + Glass of Water</button>
          <button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center" onclick="addSteps()">üë£ + Log Steps</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-profile">
  <div class="page-header">
    <div><div class="page-title">My Profile</div><div class="page-subtitle">Personal details and physiological baseline</div></div>
    <div class="page-actions"><button class="btn btn-primary btn-sm" onclick="openEditModal()">‚úèÔ∏è Edit Profile</button></div>
  </div>
  <div class="profile-body fadein">
    <div class="profile-card">
      <div class="profile-avatar-lg" id="profile-avatar-lg" onclick="openEditModal()">AK</div>
      <div class="profile-name" id="profile-name">Alex Kumar</div>
      <div class="profile-id" id="profile-id">Patient ID: PHM-2841 ¬∑ Joined Jan 2024</div>
      <div class="divider"></div>
      <div style="text-align:left;display:flex;flex-direction:column;gap:7px;margin-top:8px">
        <div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:var(--ink3)">Age</span><span style="font-weight:600" id="p-age">34 years</span></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:var(--ink3)">Gender</span><span style="font-weight:600" id="p-gender">Male</span></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:var(--ink3)">Height</span><span style="font-weight:600" id="p-height">175 cm</span></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:var(--ink3)">Weight</span><span style="font-weight:600" id="p-weight">72 kg</span></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:var(--ink3)">BMI</span><span style="font-weight:600" id="p-bmi">23.5</span></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:var(--ink3)">Blood Type</span><span style="font-weight:600" id="p-blood">A+</span></div>
        <div style="display:flex;justify-content:space-between;font-size:.8rem"><span style="color:var(--ink3)">Device</span><span style="font-weight:600">ESP32 v2.1</span></div>
      </div>
      <div class="profile-stats-grid">
        <div class="profile-stat"><div class="profile-stat-val" id="ps-days">14</div><div class="profile-stat-lbl">Days Active</div></div>
        <div class="profile-stat"><div class="profile-stat-val" id="ps-alerts">0</div><div class="profile-stat-lbl">Alerts Total</div></div>
        <div class="profile-stat"><div class="profile-stat-val" style="color:var(--teal)">98.5%</div><div class="profile-stat-lbl">Baseline Fit</div></div>
        <div class="profile-stat"><div class="profile-stat-val" style="color:var(--green)">Good</div><div class="profile-stat-lbl">Status</div></div>
      </div>
    </div>
    <div class="profile-right">
      <div class="info-section">
        <div class="info-section-title">Medical Information <button class="btn btn-ghost btn-sm" onclick="openEditModal('medical')">Edit</button></div>
        <div class="info-grid">
          <div class="info-item"><span class="info-label">Conditions</span><span class="info-value" id="p-conditions">None listed</span></div>
          <div class="info-item"><span class="info-label">Medications</span><span class="info-value" id="p-medications">None listed</span></div>
          <div class="info-item"><span class="info-label">Allergies</span><span class="info-value" id="p-allergies">Penicillin</span></div>
          <div class="info-item"><span class="info-label">Emergency Contact</span><span class="info-value" id="p-emergency">+91 98765 43210</span></div>
          <div class="info-item"><span class="info-label">Physician</span><span class="info-value" id="p-physician">Dr. R. Sharma</span></div>
          <div class="info-item"><span class="info-label">Last Check-up</span><span class="info-value" id="p-checkup">Nov 2024</span></div>
        </div>
      </div>
      <div class="info-section">
        <div class="info-section-title">Personal Physiological Baseline</div>
        <p style="font-size:.75rem;color:var(--ink3);margin-bottom:12px;line-height:1.5">Learned from your first 14 days of monitoring. Used to calculate your personalized HRI.</p>
        <div class="baseline-bars" id="baseline-bars"></div>
      </div>
      <div class="info-section">
        <div class="info-section-title">Wearable Device</div>
        <div class="info-grid">
          <div class="info-item"><span class="info-label">Hardware</span><span class="info-value">ESP32 WROOM-32</span></div>
          <div class="info-item"><span class="info-label">Firmware</span><span class="info-value">v2.1.4</span></div>
          <div class="info-item"><span class="info-label">Sample Rate</span><span class="info-value">10 Hz</span></div>
          <div class="info-item"><span class="info-label">Battery</span><span class="info-value" id="p-battery">87% (Est. 9hr)</span></div>
          <div class="info-item"><span class="info-label">Sensors</span><span class="info-value">MAX30105, AD8232, DS18B20, GSR, MPU6050</span></div>
          <div class="info-item"><span class="info-label">Protocol</span><span class="info-value" id="p-protocol">BLE 5.0 + MQTT</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-settings">
  <div class="page-header">
    <div><div class="page-title">Settings</div><div class="page-subtitle">Sensor connections, alerts, thresholds, and preferences</div></div>
  </div>
  <div class="settings-body fadein">
    <!-- Settings nav -->
    <div>
      <div style="background:#fff;border-radius:var(--r);border:1px solid var(--border);box-shadow:var(--shadow);padding:8px">
        <div class="settings-nav">
          <button class="settings-nav-item active" onclick="showSettingsSection('sensors',this)">üì° Sensor Connections</button>
          <button class="settings-nav-item" onclick="showSettingsSection('thresholds',this)">üìä Alert Thresholds</button>
          <button class="settings-nav-item" onclick="showSettingsSection('notifications',this)">üîî Notifications</button>
          <button class="settings-nav-item" onclick="showSettingsSection('display',this)">üé® Display & UI</button>
          <button class="settings-nav-item" onclick="showSettingsSection('data',this)">üíæ Data & Privacy</button>
          <button class="settings-nav-item" onclick="showSettingsSection('about',this)">‚ÑπÔ∏è About</button>
        </div>
      </div>
    </div>
    <!-- Settings content -->
    <div class="settings-content">

      <!-- SENSORS -->
      <div class="settings-section active" id="ss-sensors">
        <div class="settings-card">
          <div class="settings-card-title">Sensor Connections</div>
          <div class="settings-card-sub">Manage and configure your wearable sensors. Click a sensor card to toggle its connection state.</div>
          <div class="sensor-grid" id="sensor-grid"></div>
          <div style="font-size:.78rem;font-weight:600;color:var(--ink2);margin-bottom:10px">Connection Protocol</div>
          <div class="protocol-tabs">
            <button class="proto-tab active" id="proto-ble" onclick="setProto('ble',this)">üì∂ BLE 5.0</button>
            <button class="proto-tab" id="proto-wifi" onclick="setProto('wifi',this)">üì° Wi-Fi MQTT</button>
            <button class="proto-tab" id="proto-usb" onclick="setProto('usb',this)">üîå USB Serial</button>
            <button class="proto-tab" id="proto-demo" onclick="setProto('demo',this)">üß™ Demo Mode</button>
          </div>
          <div style="margin-top:12px">
            <div class="form-group">
              <div class="form-label">Device Address / Host</div>
              <div class="conn-input-row">
                <input class="form-input" id="conn-addr" placeholder="e.g. ESP32-PulseIQ or 192.168.1.100" style="flex:1">
                <button class="btn btn-primary btn-sm" onclick="simulateConnect()">Connect</button>
              </div>
            </div>
            <div class="conn-status-bar" id="conn-status">
              <div class="live-dot"></div>
              <span>Demo mode active ‚Äî simulated sensor data streaming at 10 Hz</span>
            </div>
          </div>
        </div>
      </div>

      <!-- THRESHOLDS -->
      <div class="settings-section" id="ss-thresholds">
        <div class="settings-card">
          <div class="settings-card-title">Alert Thresholds</div>
          <div class="settings-card-sub">Customize alert trigger values for each vital sign. Changes take effect immediately.</div>
          <div id="threshold-settings"></div>
        </div>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="settings-section" id="ss-notifications">
        <div class="settings-card">
          <div class="settings-card-title">Notification Settings</div>
          <div class="settings-card-sub">Control how and when PulseIQ notifies you about health events.</div>
          <div>
            <div class="toggle-row">
              <div><div class="toggle-label">Alert Sounds</div><div class="toggle-desc">Play audio for critical alerts</div></div>
              <label class="toggle"><input type="checkbox" checked id="notif-sound"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Browser Notifications</div><div class="toggle-desc">Show system notifications for high-risk events</div></div>
              <label class="toggle"><input type="checkbox" id="notif-browser"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Fever Alerts</div><div class="toggle-desc">Notify when temperature exceeds 37.8¬∞C</div></div>
              <label class="toggle"><input type="checkbox" checked id="notif-fever"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Behaviour Detection Alerts</div><div class="toggle-desc">Alert when smoking or coughing is detected</div></div>
              <label class="toggle"><input type="checkbox" checked id="notif-behaviour"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Step Goal Reminder</div><div class="toggle-desc">Remind when 75% of daily goal not reached by 7pm</div></div>
              <label class="toggle"><input type="checkbox" checked id="notif-steps"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Daily Health Summary</div><div class="toggle-desc">Receive daily summary at 9pm</div></div>
              <label class="toggle"><input type="checkbox" id="notif-summary"><span class="slider"></span></label>
            </div>
          </div>
          <div class="form-group" style="margin-top:18px">
            <div class="form-label">Alert Cooldown (minutes) <span id="cooldown-val" style="color:var(--teal)">4 min</span></div>
            <div class="range-row">
              <input type="range" class="range-slider" min="1" max="30" value="4" id="cooldown-slider" oninput="document.getElementById('cooldown-val').textContent=this.value+' min'">
            </div>
          </div>
        </div>
      </div>

      <!-- DISPLAY -->
      <div class="settings-section" id="ss-display">
        <div class="settings-card">
          <div class="settings-card-title">Display & UI</div>
          <div class="settings-card-sub">Customize the appearance and layout of your dashboard.</div>
          <div>
            <div class="toggle-row">
              <div><div class="toggle-label">Mini Waveforms</div><div class="toggle-desc">Show sparkline charts on signal cards</div></div>
              <label class="toggle"><input type="checkbox" checked id="disp-mini"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Correlation Heatmap</div><div class="toggle-desc">Show real-time correlation matrix</div></div>
              <label class="toggle"><input type="checkbox" checked id="disp-corr"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Animated HRI Gauge</div><div class="toggle-desc">Animate the health risk gauge needle</div></div>
              <label class="toggle"><input type="checkbox" checked id="disp-gauge"><span class="slider"></span></label>
            </div>
          </div>
          <div class="form-group" style="margin-top:18px">
            <div class="form-label">Temperature Unit</div>
            <select class="form-select" id="temp-unit" onchange="updateTempUnit()">
              <option value="C">Celsius (¬∞C)</option>
              <option value="F">Fahrenheit (¬∞F)</option>
            </select>
          </div>
          <div class="form-group">
            <div class="form-label">Step Goal <span id="step-goal-val" style="color:var(--teal)">10,000</span></div>
            <div class="range-row">
              <input type="range" class="range-slider" min="2000" max="20000" step="500" value="10000" id="step-goal-slider" oninput="updateStepGoal(this.value)">
            </div>
          </div>
        </div>
      </div>

      <!-- DATA -->
      <div class="settings-section" id="ss-data">
        <div class="settings-card">
          <div class="settings-card-title">Data & Privacy</div>
          <div class="settings-card-sub">Your health data stays on this device. No data is transmitted to external servers without your consent.</div>
          <div>
            <div class="toggle-row">
              <div><div class="toggle-label">Local Data Storage</div><div class="toggle-desc">Save session data in browser storage</div></div>
              <label class="toggle"><input type="checkbox" id="data-local"><span class="slider"></span></label>
            </div>
            <div class="toggle-row">
              <div><div class="toggle-label">Anonymous Analytics</div><div class="toggle-desc">Help improve PulseIQ with anonymous usage data</div></div>
              <label class="toggle"><input type="checkbox" id="data-anon"><span class="slider"></span></label>
            </div>
          </div>
          <div style="margin-top:18px;display:flex;gap:8px">
            <button class="btn btn-ghost btn-sm" onclick="exportData()">üì• Export Data (JSON)</button>
            <button class="btn btn-danger btn-sm" onclick="if(confirm('Clear all session data?')){resetAll();showToast('Data Cleared','Session data has been reset','normal')}">üóëÔ∏è Clear Session Data</button>
          </div>
        </div>
      </div>

      <!-- ABOUT -->
      <div class="settings-section" id="ss-about">
        <div class="settings-card">
          <div class="settings-card-title">About PulseIQ Pro</div>
          <div style="display:flex;flex-direction:column;gap:10px;margin-top:4px">
            <div class="info-item"><span class="info-label">Version</span><span class="info-value">3.0.0 Pro ‚Äî Adaptive</span></div>
            <div class="info-item"><span class="info-label">Build</span><span class="info-value">2025-02-27</span></div>
            <div class="info-item"><span class="info-label">HRI Engine</span><span class="info-value">Personal Baseline + Z-Score + LSTM + XGBoost</span></div>
            <div class="info-item"><span class="info-label">Signals</span><span class="info-value">12 vital signs incl. BP, Headache, Weakness</span></div>
            <div class="info-item"><span class="info-label">Baseline Learning</span><span class="info-value">Welford's Online Algorithm (48h window)</span></div>
            <div class="info-item"><span class="info-label">Anomaly Detection</span><span class="info-value">Z-Score (personal œÉ) + Multi-signal correlation</span></div>
            <div class="info-item"><span class="info-label">Risk Prediction</span><span class="info-value">Linear regression on HRI trajectory</span></div>
            <div class="info-item"><span class="info-label">Behaviour AI</span><span class="info-value">Web Audio API + Pattern Classifier</span></div>
            <div class="info-item"><span class="info-label">Supported Sensors</span><span class="info-value">MAX30105, AD8232, DS18B20, GSR, MPU6050, BP Cuff, NTC</span></div>
          </div>
          <div style="margin-top:18px;padding:14px;background:var(--teal-lt);border-radius:var(--r2);font-size:.78rem;color:var(--teal);line-height:1.6">
            ‚öïÔ∏è <strong>Medical Disclaimer:</strong> PulseIQ Pro is a wellness monitoring tool and is not a medical device. It is not intended to diagnose, treat, cure, or prevent any medical condition. Always consult a qualified healthcare professional for medical advice.
          </div>
        </div>
      </div>

    </div><!-- /settings-content -->
  </div>
</div>

</div><!-- /main-content -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: SMART SCHEDULE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-schedule">
  <div class="page-header">
    <div><div class="page-title">‚è∞ Smart Schedule</div><div class="page-subtitle">Water, meals, walks, sleep alerts & alarm clock</div></div>
    <div class="page-actions">
      <button class="btn btn-primary btn-sm" onclick="addAlarm()">+ Add Alarm</button>
      <button class="btn btn-ghost btn-sm" onclick="testAllAlerts()">üîî Test All</button>
    </div>
  </div>
  <div style="padding:22px 30px 40px;display:grid;grid-template-columns:1fr 1fr;gap:18px">

    <!-- Today's Schedule -->
    <div class="settings-card" style="grid-column:1/-1">
      <div class="settings-card-title">üìÖ Today's Health Schedule</div>
      <div class="settings-card-sub">Real-time reminders based on your routine and health conditions</div>
      <div id="today-schedule" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:8px"></div>
    </div>

    <!-- Water Reminders -->
    <div class="settings-card">
      <div class="settings-card-title">üíß Hydration Reminders</div>
      <div class="settings-card-sub">Automatic alerts every 2 hours ‚Äî adjusted for diabetes & kidney conditions</div>
      <div style="display:flex;flex-direction:column;gap:8px" id="water-schedule-list"></div>
      <div style="margin-top:14px;padding:10px;background:var(--blue-lt);border-radius:8px;font-size:.76rem;color:var(--blue)">
        <strong>üí° Smart Tip:</strong> Based on your weight (72kg), recommended daily intake is <strong>2.4L (10 glasses)</strong>. Adjusted for climate: Vijayawada heat +200ml.
      </div>
    </div>

    <!-- Meal Schedule -->
    <div class="settings-card">
      <div class="settings-card-title">üçΩÔ∏è Meal Time Alerts</div>
      <div class="settings-card-sub">Smart meal reminders with disease-specific dietary advice</div>
      <div style="display:flex;flex-direction:column;gap:8px" id="meal-schedule-list"></div>
    </div>

    <!-- Walk Reminders -->
    <div class="settings-card">
      <div class="settings-card-title">üö∂ Walk & Movement Alerts</div>
      <div class="settings-card-sub">Sedentary detection ‚Äî alert every 60 min of inactivity</div>
      <div style="display:flex;flex-direction:column;gap:8px" id="walk-schedule-list"></div>
      <div style="margin-top:10px;display:flex;align-items:center;gap:8px">
        <label style="font-size:.78rem;color:var(--ink2)">Sedentary limit:</label>
        <select id="sedentary-limit" style="border:1.5px solid var(--border2);border-radius:6px;padding:4px 8px;font-size:.76rem;font-family:var(--ff-body)" onchange="updateSedentaryLimit(this.value)">
          <option value="30">30 min</option>
          <option value="60" selected>60 min</option>
          <option value="90">90 min</option>
          <option value="120">2 hours</option>
        </select>
      </div>
    </div>

    <!-- Sleep Schedule -->
    <div class="settings-card">
      <div class="settings-card-title">üò¥ Sleep Schedule</div>
      <div class="settings-card-sub">Bedtime reminders, wind-down alerts, wake alarms</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div>
            <div style="font-size:.7rem;color:var(--ink3);margin-bottom:3px">Bedtime</div>
            <input type="time" id="bedtime-input" value="22:00" style="border:1.5px solid var(--border2);border-radius:6px;padding:6px 10px;font-family:var(--ff-body);font-size:.82rem" onchange="updateSleepSchedule()">
          </div>
          <div>
            <div style="font-size:.7rem;color:var(--ink3);margin-bottom:3px">Wake up</div>
            <input type="time" id="wakeup-input" value="06:00" style="border:1.5px solid var(--border2);border-radius:6px;padding:6px 10px;font-family:var(--ff-body);font-size:.82rem" onchange="updateSleepSchedule()">
          </div>
          <div style="margin-top:16px">
            <button class="btn btn-primary btn-sm" onclick="updateSleepSchedule()">Update</button>
          </div>
        </div>
        <div id="sleep-schedule-items" style="display:flex;flex-direction:column;gap:6px"></div>
        <div style="padding:10px;background:var(--purple-lt);border-radius:8px;font-size:.75rem;color:var(--purple)">
          <strong>üò¥ Sleep Goal:</strong> 8 hours ¬∑ Wind-down alert 30 min before bedtime. For diabetics: check glucose before bed!
        </div>
      </div>
    </div>

    <!-- Alarm Clock -->
    <div class="settings-card">
      <div class="settings-card-title">‚è∞ Alarm Clock</div>
      <div class="settings-card-sub">Custom health alarms with medication reminders</div>
      <div id="alarm-list" style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input type="time" id="new-alarm-time" style="border:1.5px solid var(--border2);border-radius:6px;padding:6px 10px;font-family:var(--ff-body);font-size:.82rem;flex:1">
        <input type="text" id="new-alarm-label" placeholder="Alarm label (e.g. Morning Medication)" style="border:1.5px solid var(--border2);border-radius:6px;padding:6px 10px;font-family:var(--ff-body);font-size:.78rem;flex:2">
        <button class="btn btn-primary btn-sm" onclick="addAlarm()">+ Add</button>
      </div>
    </div>

    <!-- Medication Schedule -->
    <div class="settings-card">
      <div class="settings-card-title">üíä Medication Schedule</div>
      <div class="settings-card-sub">Never miss a dose ‚Äî disease-specific reminders</div>
      <div id="med-schedule" style="display:flex;flex-direction:column;gap:8px"></div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px;width:100%;justify-content:center" onclick="addMedication()">+ Add Medication</button>
    </div>

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE: DISEASE MONITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-diseases">
  <div class="page-header">
    <div><div class="page-title">ü©∫ Disease Monitor</div><div class="page-subtitle">Real-time risk assessment for chronic & acute conditions</div></div>
    <div class="page-actions">
      <button class="btn btn-danger btn-sm" onclick="simulateEmergency()">üÜò Test Emergency</button>
    </div>
  </div>
  <div style="padding:22px 30px 40px;display:grid;grid-template-columns:1fr 1fr;gap:18px">

    <!-- Active Conditions -->
    <div class="settings-card" style="grid-column:1/-1">
      <div class="settings-card-title">üìã Registered Health Conditions</div>
      <div class="settings-card-sub">Add conditions to get personalised alerts, dietary advice, and emergency protocols</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px" id="condition-tags"></div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <select id="add-condition-select" style="border:1.5px solid var(--border2);border-radius:6px;padding:6px 10px;font-family:var(--ff-body);font-size:.78rem;flex:1">
          <option value="">-- Select condition to add --</option>
          <option value="heart">‚ù§Ô∏è Heart Disease / CAD</option>
          <option value="hypertension">ü©∏ Hypertension</option>
          <option value="diabetes_t1">üç¨ Diabetes Type 1</option>
          <option value="diabetes_t2">üç¨ Diabetes Type 2</option>
          <option value="liver">ü´Å Liver Disease / Cirrhosis</option>
          <option value="kidney">ü´ò Chronic Kidney Disease</option>
          <option value="asthma">üå¨Ô∏è Asthma / COPD</option>
          <option value="stroke">üß† Stroke Risk</option>
          <option value="thyroid">ü¶ã Thyroid Disorder</option>
          <option value="anemia">ü©∏ Anemia</option>
          <option value="arthritis">ü¶¥ Arthritis</option>
          <option value="epilepsy">‚ö° Epilepsy</option>
          <option value="obesity">‚öñÔ∏è Obesity</option>
          <option value="anxiety">üß† Anxiety / Panic Disorder</option>
        </select>
        <button class="btn btn-primary btn-sm" onclick="addCondition()">Add Condition</button>
      </div>
    </div>

    <!-- Real-time disease risk -->
    <div class="settings-card" style="grid-column:1/-1">
      <div class="settings-card-title">üìä Real-Time Disease Risk Assessment</div>
      <div class="settings-card-sub">AI-powered analysis of current vitals against condition-specific thresholds</div>
      <div id="disease-risk-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:10px"></div>
    </div>

    <!-- Emergency protocol -->
    <div class="settings-card">
      <div class="settings-card-title">üÜò Emergency Auto-Call Protocol</div>
      <div class="settings-card-sub">Automatically contacts family & nearest hospital when critical threshold is reached</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--red-lt);border-radius:8px;border:1px solid var(--red-mid)">
          <span style="font-size:.8rem;font-weight:600;color:var(--red)">üÜò Auto-Emergency Call</span>
          <label style="position:relative;display:inline-block;width:42px;height:22px">
            <input type="checkbox" id="auto-emergency-toggle" checked style="opacity:0;width:0;height:0" onchange="toggleAutoEmergency(this.checked)">
            <span id="auto-toggle-slider" style="position:absolute;cursor:pointer;inset:0;background:var(--teal);border-radius:11px;transition:.3s"></span>
            <span style="position:absolute;content:'';height:16px;width:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;transform:translateX(20px);display:block"></span>
          </label>
        </div>
        <div id="emergency-contacts-list" style="display:flex;flex-direction:column;gap:7px"></div>
        <button class="btn btn-ghost btn-sm" onclick="addEmergencyContact()" style="justify-content:center">+ Add Emergency Contact</button>
        <div style="padding:10px;background:var(--amber-lt);border-radius:8px;font-size:.74rem;color:var(--amber);line-height:1.5">
          <strong>‚ö†Ô∏è Note:</strong> This is a simulation. In a real deployment, this integrates with cellular APIs (Twilio/MSG91) and your country's emergency services. Auto-call triggers when HRI &gt; 90 sustained for 10s.
        </div>
      </div>
    </div>

    <!-- Nearby hospitals -->
    <div class="settings-card">
      <div class="settings-card-title">üè• Nearest Hospitals (Vijayawada)</div>
      <div class="settings-card-sub">Pre-loaded emergency hospitals based on your location</div>
      <div id="hospital-list" style="display:flex;flex-direction:column;gap:8px"></div>
      <button class="btn btn-danger btn-sm" style="margin-top:12px;width:100%;justify-content:center" onclick="callNearestHospital()">üìû Call Nearest Hospital</button>
    </div>

  </div>
</div>
</div><!-- /app-shell -->

<!-- ‚ïê‚ïê‚ïê EDIT PROFILE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-title">Edit Profile</div>
    <div class="modal-sub">Update your personal details. Changes are reflected immediately across the app.</div>
    <div class="form-row">
      <div class="form-group"><div class="form-label">First Name</div><input class="form-input" id="edit-first" value="Alex"></div>
      <div class="form-group"><div class="form-label">Last Name</div><input class="form-input" id="edit-last" value="Kumar"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><div class="form-label">Age</div><input class="form-input" id="edit-age" type="number" value="34" min="1" max="120"></div>
      <div class="form-group"><div class="form-label">Gender</div>
        <select class="form-select" id="edit-gender"><option>Male</option><option>Female</option><option>Other</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><div class="form-label">Height (cm)</div><input class="form-input" id="edit-height" type="number" value="175"></div>
      <div class="form-group"><div class="form-label">Weight (kg)</div><input class="form-input" id="edit-weight" type="number" value="72"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><div class="form-label">Blood Type</div>
        <select class="form-select" id="edit-blood">
          <option>A+</option><option>A-</option><option>B+</option><option>B-</option><option>AB+</option><option>AB-</option><option>O+</option><option>O-</option>
        </select>
      </div>
      <div class="form-group"><div class="form-label">Patient ID</div><input class="form-input" id="edit-pid" value="PHM-2841"></div>
    </div>
    <div style="font-size:.78rem;font-weight:600;color:var(--ink2);margin:6px 0 12px;padding-top:12px;border-top:1px solid var(--border)">Medical Details</div>
    <div class="form-group"><div class="form-label">Conditions</div><input class="form-input" id="edit-conditions" value="None listed" placeholder="e.g. Hypertension, Diabetes"></div>
    <div class="form-group"><div class="form-label">Medications</div><input class="form-input" id="edit-medications" value="None listed"></div>
    <div class="form-group"><div class="form-label">Allergies</div><input class="form-input" id="edit-allergies" value="Penicillin"></div>
    <div class="form-row">
      <div class="form-group"><div class="form-label">Emergency Contact</div><input class="form-input" id="edit-emergency" value="+91 98765 43210"></div>
      <div class="form-group"><div class="form-label">Physician</div><input class="form-input" id="edit-physician" value="Dr. R. Sharma"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeEditModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveProfile()">üíæ Save Changes</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê -->
<div class="toast" id="toast">
  <div class="toast-icon" id="toast-icon">üîî</div>
  <div><div class="toast-title" id="toast-title">Alert</div><div class="toast-msg" id="toast-msg">Message</div></div>
  <button class="toast-close" onclick="hideToast()">‚úï</button>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DATA MODEL  (v3 ‚Äî Adaptive Baseline)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const SIGNALS = [
  { key:'hr',    name:'Heart Rate',      short:'HR',   unit:'bpm',    icon:'‚ù§Ô∏è',  color:'#C0392B', bg:'#FDECEA', base:72,    std:8,    range:[40,150], lo:55,  hi:100  },
  { key:'hrv',   name:'HRV (RMSSD)',     short:'HRV',  unit:'ms',     icon:'üíõ',  color:'#1A5C9C', bg:'#E6EEF8', base:45,    std:8,    range:[10,80],  lo:20,  hi:70   },
  { key:'spo2',  name:'SpO‚ÇÇ',           short:'SpO‚ÇÇ', unit:'%',      icon:'ü©µ',  color:'#0A7B6C', bg:'#E0F4F1', base:98.5,  std:1.2,  range:[85,100], lo:94,  hi:100  },
  { key:'temp',  name:'Temperature',    short:'Temp', unit:'¬∞C',     icon:'üå°Ô∏è', color:'#C97B1A', bg:'#FEF3E2', base:36.8,  std:0.4,  range:[35,42],  lo:36,  hi:37.5 },
  { key:'fever', name:'Core Temp',      short:'Core', unit:'¬∞C',     icon:'üî•',  color:'#E74C3C', bg:'#FDECEA', base:36.8,  std:0.3,  range:[35,42],  lo:36,  hi:37.8 },
  { key:'resp',  name:'Respiration',    short:'Resp', unit:'br/min', icon:'üí®',  color:'#7B1A9C', bg:'#F3E6F8', base:16,    std:3,    range:[8,35],   lo:12,  hi:22   },
  { key:'gsr',   name:'GSR / Stress',   short:'GSR',  unit:'¬µS',     icon:'‚ö°',  color:'#1A6B1A', bg:'#E6F4E6', base:0.5,   std:0.3,  range:[0.1,3],  lo:0.1, hi:1.5  },
  { key:'bps',   name:'BP Systolic',    short:'BPS',  unit:'mmHg',   icon:'ü©∏',  color:'#922B21', bg:'#FDEDEC', base:118,   std:8,    range:[80,200], lo:90,  hi:140  },
  { key:'bpd',   name:'BP Diastolic',   short:'BPD',  unit:'mmHg',   icon:'üíâ',  color:'#6E2C00', bg:'#FAE5D3', base:76,    std:6,    range:[50,130], lo:60,  hi:90   },
  { key:'headache', name:'Headache',    short:'Head', unit:'/10',    icon:'üß†',  color:'#8E44AD', bg:'#F5EEF8', base:0.5,   std:0.8,  range:[0,10],   lo:0,   hi:4    },
  { key:'weakness', name:'Body Weakness',short:'Weak', unit:'/10',   icon:'ü¶¥',  color:'#6D4C41', bg:'#EFEBE9', base:0.5,   std:0.8,  range:[0,10],   lo:0,   hi:4    },
  { key:'steps', name:'Step Count',     short:'Step', unit:'steps',  icon:'üë£',  color:'#0A7B6C', bg:'#E0F4F1', base:0,     std:50,   range:[0,20000],lo:0,   hi:15000 },
];

/* ‚îÄ‚îÄ PERSONAL BASELINE LEARNING ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Collects rolling window of 2880 samples (‚âà 48h at 10Hz tick/100ms)
   Computes Welford's online mean + variance for each signal.
   Personalization threshold: after MIN_SAMPLES the system uses learned
   baseline instead of population defaults.
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const BASELINE_WINDOW = 2880;  // ~48h
const MIN_SAMPLES_FOR_PERSONALIZATION = 300; // ~30s demo, ~5min real

const personalBaseline = {};
SIGNALS.forEach(s => {
  personalBaseline[s.key] = {
    samples: [],       // rolling window
    n: 0,             // count
    mean: s.base,     // Welford mean
    M2: s.std * s.std * 10, // Welford M2 (sum of squared diffs)
    get std(){ return this.n > 1 ? Math.sqrt(this.M2 / (this.n - 1)) : s.std; },
    get isLearned(){ return this.n >= MIN_SAMPLES_FOR_PERSONALIZATION; }
  };
});

function updateBaseline(key, value) {
  const pb = personalBaseline[key];
  pb.samples.push(value);
  if (pb.samples.length > BASELINE_WINDOW) {
    // Remove oldest ‚Äî adjust Welford stats
    const removed = pb.samples.shift();
    const old_mean = pb.mean;
    pb.n--;
    pb.mean += (pb.mean - removed) / pb.n;
    pb.M2 -= (removed - old_mean) * (removed - pb.mean);
    if (pb.M2 < 0) pb.M2 = 0;
  }
  // Add new value via Welford's
  pb.n++;
  const delta = value - pb.mean;
  pb.mean += delta / pb.n;
  const delta2 = value - pb.mean;
  pb.M2 += delta * delta2;
}

function getZScore(key, value) {
  const pb = personalBaseline[key];
  const std = pb.std || 0.01;
  return (value - pb.mean) / std;
}

// Blood volume estimate (Nadler's formula simplified)
function estimateBloodVolume(weightKg, heightCm, gender) {
  if (gender === 'Male') return (0.3669 * Math.pow(heightCm/100, 3) + 0.03219 * weightKg + 0.6041).toFixed(2);
  return (0.3561 * Math.pow(heightCm/100, 3) + 0.03308 * weightKg + 0.1833).toFixed(2);
}

// HRI History for prediction
const HRI_HIST = Array(120).fill(0);

// Prediction engine: linear regression on last N HRI values ‚Üí project forward
function predictHRI(horizon = 20) {
  const data = HRI_HIST.slice(-40);
  const n = data.length; if (n < 5) return null;
  let sx=0,sy=0,sxy=0,sx2=0;
  data.forEach((y,i)=>{sx+=i;sy+=y;sxy+=i*y;sx2+=i*i;});
  const slope=(n*sxy-sx*sy)/(n*sx2-sx*sx);
  const intercept=(sy-slope*sx)/n;
  const predicted = clamp(Math.round(intercept + slope*(n+horizon)), 0, 100);
  return {slope: slope.toFixed(2), predicted, trend: slope > 0.5 ? 'rising' : slope < -0.5 ? 'falling' : 'stable'};
}

const BUFSZ = 1200;
const bufs = {};
SIGNALS.forEach(s=>{ bufs[s.key] = Array(BUFSZ).fill(s.key==='steps'?0:s.base); });
// steps & fever separate trackers
let stepsBuf = Array(288).fill(0);   // 24h at 5-min intervals
let tempBuf = Array(144).fill(36.8); // 24h at 10-min intervals
let totalSteps = 0;
let todayStepGoal = 10000;
let waterCount = 0;

/* ‚ïê‚ïê‚ïê v4 State Variables ‚ïê‚ïê‚ïê */
let nextMedId=3;
let autoEmergencyEnabled=true;
let emergencyTriggered=false;
let lastEmergencyTime=0;
let emergencyCountdownInterval=null;
let sedentaryMinutes=0;
let sedentaryLimit=60;
let lastSmartWaterAlert=0;
let lastSmartWalkAlert=0;
let lastSmartMealAlert=0;
let chatOpen=false;
let chatHistory=[];

let tick=0, paused=false, scenario='normal', scenTick=0;
let totalSamples=0, sessionStart=Date.now();
let alertLogData=[], alertCounts={total:0,critical:0,high:0,elevated:0,resolved:0};
let currentFilter='all', lastAlertLevel='normal', lastAlertMs=0;
let micActive=false, micStream=null, micAnalyser=null, micSessionStart=null;
let micDetectionCounts={cough:0,smoking:0,drinking:0,sneeze:0,snore:0};
let micTotalDetections=0, micLogEntries=[];
let micAnimFrame=null;

const TEAL='#0A7B6C', AMBER='#C97B1A', ORG='#B85A00', RED='#C0392B';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCENARIOS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function randn(sd=1){ let u,v; do u=Math.random();while(!u);do v=Math.random();while(!v);return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v)*sd; }
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}

const scenarioFns = {
  normal:       t=>({hr:72+3*Math.sin(t/30)+randn(1.2),hrv:45+randn(3.5),spo2:98.5+randn(.2),temp:36.8+randn(.06),fever:36.8+randn(.05),resp:16+randn(.7),gsr:.5+randn(.03),bps:118+randn(3),bpd:76+randn(2.5),headache:.4+Math.abs(randn(.2)),weakness:.4+Math.abs(randn(.2))}),
  cardiac:      t=>{const p=Math.min(t/200,1);return{hr:72+p*42+randn(3),hrv:45-p*32+randn(2),spo2:98.5-p*2.5+randn(.3),temp:36.8+p*.4+randn(.07),fever:36.8+p*.5+randn(.06),resp:16+p*8+randn(1),gsr:.5+p*1.4+randn(.07),bps:118+p*38+randn(4),bpd:76+p*22+randn(3),headache:.5+p*3.5+randn(.3),weakness:.5+p*2+randn(.2)}},
  hypoxia:      t=>{const p=Math.min(t/250,1);return{hr:72+p*18+randn(2),hrv:45-p*15+randn(2.5),spo2:98.5-p*7.5+randn(.2),temp:36.8+randn(.08),fever:36.8+randn(.07),resp:16+p*10+randn(1.2),gsr:.5+p*.5+randn(.04),bps:118+p*12+randn(3),bpd:76+p*8+randn(2),headache:.4+p*4+randn(.4),weakness:.4+p*3+randn(.3)}},
  infection:    t=>{const p=Math.min(t/300,1);return{hr:72+p*22+randn(2),hrv:45-p*20+randn(2.5),spo2:98.5-p*.8+randn(.25),temp:36.8+p*1.8+randn(.1),fever:36.8+p*2.1+randn(.12),resp:16+p*4+randn(.9),gsr:.5+p+randn(.08),bps:118+p*10+randn(3),bpd:76+p*6+randn(2),headache:.4+p*3.2+randn(.3),weakness:.4+p*3.5+randn(.35)}},
  fever:        t=>{const p=Math.min(t/200,1);return{hr:72+p*26+randn(2.5),hrv:45-p*22+randn(2),spo2:98.5-p*1.2+randn(.3),temp:36.8+p*3.2+randn(.15),fever:36.8+p*3.5+randn(.18),resp:16+p*5+randn(1),gsr:.5+p*.6+randn(.06),bps:118+p*14+randn(3),bpd:76+p*8+randn(2.5),headache:.5+p*5+randn(.4),weakness:.5+p*4+randn(.35)}},
  overexertion: t=>{const p=Math.min(t/150,1);return{hr:72+p*55+Math.sin(t/80)*5+randn(3.5),hrv:45-p*38+randn(1.8),spo2:98.5-p*3.5+randn(.35),temp:36.8+p*.9+randn(.09),fever:36.8+p*1.0+randn(.1),resp:16+p*14+randn(1.8),gsr:.5+p*2+randn(.12),bps:118+p*45+randn(5),bpd:76+p*18+randn(3),headache:.4+p*2+randn(.2),weakness:.4+p*3+randn(.3)}},
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HRI ENGINE v3 ‚Äî Personalized Baseline
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function computeHRI(vals){
  const sigs = SIGNALS.filter(s=>s.key!=='steps'&&s.key!=='fever');

  // ‚ë† Mahalanobis-like distance using PERSONAL baseline (or population if not yet learned)
  let maha2=0;
  sigs.forEach(s=>{
    const z = getZScore(s.key, vals[s.key]);
    maha2 += z*z;
  });
  const mS=Math.min(maha2/(sigs.length*4),1);  // normalise by # signals

  // ‚ë° LSTM-like: deviation from recent rolling mean (trend detection)
  let lstm=0;
  sigs.forEach(s=>{
    const r=bufs[s.key].slice(-60);
    const m=r.reduce((a,b)=>a+b,0)/r.length;
    const pb=personalBaseline[s.key];
    const std=pb.std||s.std||0.01;
    lstm+=Math.abs(vals[s.key]-m)/std;
  });
  const lS=Math.min(lstm/sigs.length,1);

  // ‚ë¢ XGBoost-like: rule-based risk features using PERSONAL baseline
  let xgb=0;
  const bpbHR=personalBaseline['hr'];const bpbHRV=personalBaseline['hrv'];
  const bpbSPO2=personalBaseline['spo2'];const bpbBPS=personalBaseline['bps'];
  // Use learned thresholds if available, else population
  const hrHi = bpbHR.isLearned ? bpbHR.mean+2.5*bpbHR.std : 100;
  const hrHiEx = bpbHR.isLearned ? bpbHR.mean+3.5*bpbHR.std : 120;
  const hrvLo = bpbHRV.isLearned ? bpbHRV.mean-2*bpbHRV.std : 25;
  const spo2Lo = bpbSPO2.isLearned ? bpbSPO2.mean-2.5*bpbSPO2.std : 94;
  const bpsHi = bpbBPS.isLearned ? bpbBPS.mean+2.5*bpbBPS.std : 140;
  if(vals.hr>hrHi) xgb+=.2; if(vals.hr>hrHiEx) xgb+=.1;
  if(vals.hrv<hrvLo) xgb+=.2;
  if(vals.spo2<spo2Lo) xgb+=.35;
  if(vals.temp>37.8) xgb+=.15; if(vals.fever>38.0) xgb+=.2;
  if(vals.resp>22) xgb+=.12;
  if(vals.bps>bpsHi) xgb+=.18;
  if(vals.headache>5) xgb+=.1; if(vals.headache>7) xgb+=.1;
  if(vals.weakness>5) xgb+=.08; if(vals.weakness>7) xgb+=.08;
  xgb=Math.min(xgb,1);

  const hri=clamp(Math.round(100*(0.35*mS+0.45*lS+0.20*xgb)),0,100);

  // Anomaly Z-score map for UI
  const zMap={};
  sigs.forEach(s=>{ zMap[s.key]=Math.abs(getZScore(s.key,vals[s.key])).toFixed(1); });

  return{hri,maha:maha2.toFixed(1),lstm:lstm.toFixed(1),zMap};
}

function hriMeta(hri){
  if(hri<=30) return{level:'normal',   label:'Normal',   color:TEAL, bg:'var(--teal-lt)', icon:'‚úì', title:'All signals within your personal baseline', desc:"Multi-signal Z-scores all within 1.5œÉ of your personal baseline. No abnormal correlations."};
  if(hri<=55) return{level:'elevated', label:'Elevated', color:AMBER,bg:'var(--amber-lt)',icon:'‚ö†', title:'Early deviation detected from your baseline',    desc:"1‚Äì2 signals deviating >1.5œÉ from your personal mean. Correlations shifting ‚Äî early-stage risk flag."};
  if(hri<=75) return{level:'high',     label:'High Risk',color:ORG,  bg:'#FFF0E6',        icon:'‚ö°', title:'Multi-signal anomaly detected',              desc:"2+ signals beyond 2œÉ personal baseline simultaneously. Pattern deviation threshold-based monitors would miss."};
  if(hri<=89) return{level:'critical', label:'Critical', color:RED,  bg:'var(--red-lt)',  icon:'üö®', title:'Critical physiological pattern ‚Äî act now',   desc:"Multiple signals >2.5œÉ from personal baseline deviating together. Pattern consistent with acute physiological stress."};
  return               {level:'emergency',label:'EMERGENCY',color:'#8B0000',bg:'#FFEBEE', icon:'üÜò', title:'EMERGENCY ‚Äî Seek immediate help',             desc:"Emergency-level multi-signal crisis across your personalized model. Call emergency services immediately."};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILD UI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildSignalGrid(){
  const grid=document.getElementById('signal-grid');
  grid.innerHTML='';
  SIGNALS.filter(s=>s.key!=='steps').forEach(s=>{
    const card=document.createElement('div');
    card.className='sig-card fadein'; card.id=`sigcard-${s.key}`;
    card.innerHTML=`
      <div class="sig-card-top">
        <div class="sig-icon" style="background:${s.bg}">${s.icon}</div>
        <div class="sig-status-dot" id="sd-${s.key}"></div>
      </div>
      <div class="sig-name">${s.name}</div>
      <div class="sig-val-row">
        <span class="sig-val" id="sv-${s.key}" style="color:${s.color}">--</span>
        <span class="sig-unit">${s.unit}</span>
      </div>
      <div class="sig-range" id="sr-${s.key}">Normal: ${s.lo}‚Äì${s.hi} ${s.unit}</div>
      <div class="sig-bar-track"><div class="sig-bar-fill" id="sb-${s.key}" style="background:${s.color}"></div></div>
      <div class="sig-mini-wrap"><canvas class="sig-mini" id="sm-${s.key}" height="34"></canvas></div>
      <div class="sig-trend" id="st-${s.key}"><span>‚Üî</span><span style="margin-left:2px">Stable</span></div>`;
    grid.appendChild(card);
  });
  // Steps card special
  const stepsCard=document.createElement('div');
  stepsCard.className='sig-card fadein'; stepsCard.id='sigcard-steps';
  stepsCard.innerHTML=`
    <div class="sig-card-top">
      <div class="sig-icon" style="background:var(--teal-lt)">üë£</div>
      <div class="sig-status-dot" id="sd-steps" style="background:var(--green)"></div>
    </div>
    <div class="sig-name">Step Count</div>
    <div class="steps-ring-container">
      <div class="steps-info">
        <div class="steps-val" id="sv-steps">0</div>
        <div class="steps-goal" id="steps-goal-text">Goal: ${todayStepGoal.toLocaleString()} ¬∑ 0%</div>
        <div class="steps-badges" id="steps-badges-card"></div>
      </div>
      <canvas id="steps-donut-card" width="60" height="60" style="display:block;flex-shrink:0"></canvas>
    </div>
    <div style="margin-top:8px;height:4px;background:var(--cream2);border-radius:2px;overflow:hidden">
      <div id="steps-card-bar" style="height:100%;background:var(--teal);border-radius:2px;transition:width .5s;width:0%"></div>
    </div>`;
  grid.appendChild(stepsCard);
}

function buildCorrGrid(){
  const sigs=SIGNALS.filter(s=>s.key!=='steps'&&s.key!=='fever');
  const n=sigs.length;
  const grid=document.getElementById('corr-heatmap');
  const cols=document.getElementById('corr-col-labels');
  grid.innerHTML='';cols.innerHTML='';
  grid.style.cssText=`display:grid;grid-template-columns:repeat(${n},1fr);gap:2px`;
  cols.style.cssText=`display:grid;grid-template-columns:repeat(${n},1fr);gap:2px`;
  sigs.forEach((s1,i)=>{
    sigs.forEach((s2,j)=>{
      const c=document.createElement('div');c.className='corr-cell';c.id=`cc-${i}-${j}`;c.title=`${s1.short}‚Üî${s2.short}`;
      if(i===j){c.style.background='#E0F4F1';c.textContent='1';c.style.color=TEAL;c.style.fontWeight='800';}
      grid.appendChild(c);
    });
  });
  sigs.forEach(s=>{const d=document.createElement('div');d.className='corr-col-label';d.textContent=s.short;cols.appendChild(d);});
}

function buildBaselineBars(){
  const c=document.getElementById('baseline-bars');c.innerHTML='';
  SIGNALS.filter(s=>s.key!=='steps').forEach(s=>{
    const pb=personalBaseline[s.key];
    const mean=pb.isLearned?pb.mean:s.base;
    const pct=((mean-s.range[0])/(s.range[1]-s.range[0])*100).toFixed(0);
    const dec=s.key==='spo2'||s.key==='temp'||s.key==='fever'||s.key==='headache'||s.key==='weakness'?1:s.key==='gsr'?2:0;
    const label=pb.isLearned?`<span style="color:var(--teal);font-size:.55rem;font-weight:700">‚óèPERSONAL</span>`:`<span style="color:var(--ink3);font-size:.55rem">pop.</span>`;
    c.innerHTML+=`<div class="baseline-row">
      <span class="baseline-sig-name">${s.icon} ${s.name}</span>
      <div class="baseline-track"><div class="baseline-fill" id="blf-${s.key}" style="width:${pct}%;background:${s.color}"></div></div>
      <span class="baseline-val" style="color:${s.color}" id="blv-${s.key}">${mean.toFixed(dec)} ${s.unit}</span>
      ${label}
    </div>`;
  });
}

function buildSensorGrid(){
  const sensors=[
    {id:'max30105',name:'MAX30105',desc:'SpO‚ÇÇ & Heart Rate',icon:'‚ù§Ô∏è',state:'connected'},
    {id:'ad8232',name:'AD8232',desc:'ECG / HRV Monitor',icon:'üì°',state:'connected'},
    {id:'ds18b20',name:'DS18B20',desc:'Body Temperature',icon:'üå°Ô∏è',state:'connected'},
    {id:'gsr',name:'GSR Module',desc:'Galvanic Skin Response',icon:'‚ö°',state:'connected'},
    {id:'mpu6050',name:'MPU-6050',desc:'Accelerometer / Steps',icon:'üë£',state:'connected'},
    {id:'ntc',name:'NTC Thermistor',desc:'Ambient Temperature',icon:'üå°Ô∏è',state:'searching'},
    {id:'mic',name:'MEMS Microphone',desc:'Behaviour Detection',icon:'üéôÔ∏è',state:'error'},
    {id:'esp32',name:'ESP32 WROOM-32',desc:'Main Controller',icon:'üîå',state:'connected'},
  ];
  const grid=document.getElementById('sensor-grid');grid.innerHTML='';
  sensors.forEach(s=>{
    const cls=s.state==='connected'?'connected':s.state==='error'?'error':'searching';
    const statusIcon=s.state==='connected'?'‚óè':s.state==='error'?'‚úï':'‚óå';
    const statusLabel=s.state==='connected'?'Connected':s.state==='error'?'Error':'Searching...';
    const statusCls=s.state==='connected'?'ok':s.state==='error'?'err':'search';
    const card=document.createElement('div');
    card.className=`sensor-card ${cls}`;card.onclick=()=>toggleSensor(s.id,card);
    card.innerHTML=`<div class="sensor-icon">${s.icon}</div><div style="flex:1"><div class="sensor-name">${s.name}</div><div class="sensor-desc">${s.desc}</div><div class="sensor-status ${statusCls}" id="ss-${s.id}"><span class="sensor-dot" style="background:${s.state==='connected'?'var(--teal)':s.state==='error'?'var(--red)':'var(--amber)'}"></span>${statusLabel}</div></div>`;
    grid.appendChild(card);
  });
}

function buildThresholdSettings(){
  const container=document.getElementById('threshold-settings');container.innerHTML='';
  SIGNALS.filter(s=>s.key!=='steps').forEach(s=>{
    const dec=s.key==='spo2'||s.key==='temp'||s.key==='fever'?1:s.key==='gsr'?2:0;
    container.innerHTML+=`<div style="margin-bottom:18px;padding-bottom:18px;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <span>${s.icon}</span>
        <span style="font-size:.85rem;font-weight:600;color:var(--ink)">${s.name}</span>
        <span style="font-size:.72rem;color:var(--ink3)">(${s.unit})</span>
      </div>
      <div class="form-row">
        <div class="form-group">
          <div class="form-label">Low Alert Threshold <span style="color:var(--blue)" id="th-lo-val-${s.key}">${s.lo}</span></div>
          <input type="range" class="range-slider" min="${s.range[0]}" max="${s.base}" step="${dec?0.1:1}" value="${s.lo}" oninput="s_updateTh('lo','${s.key}',this.value);document.getElementById('th-lo-val-${s.key}').textContent=parseFloat(this.value).toFixed(${dec})">
        </div>
        <div class="form-group">
          <div class="form-label">High Alert Threshold <span style="color:var(--red)" id="th-hi-val-${s.key}">${s.hi}</span></div>
          <input type="range" class="range-slider" min="${s.base}" max="${s.range[1]}" step="${dec?0.1:1}" value="${s.hi}" oninput="s_updateTh('hi','${s.key}',this.value);document.getElementById('th-hi-val-${s.key}').textContent=parseFloat(this.value).toFixed(${dec})">
        </div>
      </div>
    </div>`;
  });
}

function s_updateTh(lohi,key,val){
  const s=SIGNALS.find(x=>x.key===key);
  if(s){if(lohi==='lo')s.lo=parseFloat(val);else s.hi=parseFloat(val);}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DRAW FUNCTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function drawMini(key){
  const canvas=document.getElementById(`sm-${key}`);if(!canvas)return;
  const s=SIGNALS.find(x=>x.key===key);
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth||180,H=34;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  const data=bufs[key].slice(-150);const n=data.length;if(n<2)return;
  const mn=s.range[0],mx=s.range[1];
  ctx.clearRect(0,0,W,H);
  ctx.strokeStyle=s.color;ctx.lineWidth=1.5;ctx.lineJoin='round';ctx.lineCap='round';
  ctx.beginPath();
  for(let i=0;i<n;i++){const x=(i/(n-1))*(W-2)+1;const y=H-2-(data[i]-mn)/(mx-mn)*(H-4);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
  ctx.stroke();
  const grad=ctx.createLinearGradient(0,0,0,H);grad.addColorStop(0,s.color+'30');grad.addColorStop(1,s.color+'00');
  ctx.fillStyle=grad;ctx.lineTo(W-1,H);ctx.lineTo(1,H);ctx.closePath();ctx.fill();
}

function drawHRI(score){
  const canvas=document.getElementById('hri-canvas');if(!canvas)return;
  const dpr=window.devicePixelRatio||1;const W=160,H=160;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);
  const cx=80,cy=88,R=62;const sa=Math.PI*.75,ea=Math.PI*2.25;
  ctx.strokeStyle='#EDE8DC';ctx.lineWidth=14;ctx.lineCap='round';
  ctx.beginPath();ctx.arc(cx,cy,R,sa,ea);ctx.stroke();
  const zones=[{from:0,to:.3,c:'#1A7B4A20'},{from:.3,to:.55,c:'#C97B1A20'},{from:.55,to:.75,c:'#B85A0020'},{from:.75,to:.9,c:'#C0392B25'},{from:.9,to:1,c:'#8B000030'}];
  zones.forEach(z=>{const a1=sa+z.from*(ea-sa),a2=sa+z.to*(ea-sa);ctx.strokeStyle=z.c;ctx.lineWidth=14;ctx.beginPath();ctx.arc(cx,cy,R,a1,a2);ctx.stroke();});
  const t=score/100;const fillEnd=sa+t*(ea-sa);
  const meta=hriMeta(score);
  const grad=ctx.createLinearGradient(cx-R,cy,cx+R,cy);
  grad.addColorStop(0,'#1A7B4A');grad.addColorStop(.4,'#C97B1A');grad.addColorStop(.7,'#C0392B');grad.addColorStop(1,'#8B0000');
  ctx.strokeStyle=grad;ctx.lineWidth=14;ctx.lineCap='round';
  ctx.beginPath();ctx.arc(cx,cy,R,sa,fillEnd);ctx.stroke();
  for(let i=0;i<=10;i++){const a=sa+i/10*(ea-sa);const x1=cx+(R-10)*Math.cos(a),y1=cy+(R-10)*Math.sin(a);const x2=cx+(R+0)*Math.cos(a),y2=cy+(R+0)*Math.sin(a);ctx.strokeStyle='rgba(255,255,255,.6)';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();}
  const na=sa+t*(ea-sa);
  ctx.save();ctx.translate(cx,cy);ctx.strokeStyle=meta.color;ctx.lineWidth=3;ctx.lineCap='round';ctx.shadowColor=meta.color;ctx.shadowBlur=8;
  ctx.beginPath();ctx.moveTo(-8*Math.cos(na),-8*Math.sin(na));ctx.lineTo((R-8)*Math.cos(na),(R-8)*Math.sin(na));ctx.stroke();
  ctx.shadowBlur=0;ctx.fillStyle=meta.color;ctx.beginPath();ctx.arc(0,0,6,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(0,0,3,0,Math.PI*2);ctx.fill();
  ctx.restore();
}

function drawStepsDonut(canvasId,steps,goal){
  const canvas=document.getElementById(canvasId);if(!canvas)return;
  const dpr=window.devicePixelRatio||1;
  const W=canvas.offsetWidth||120,H=canvas.offsetHeight||120;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);
  const cx=W/2,cy=H/2,R=Math.min(W,H)/2-4,lw=8;
  const pct=Math.min(steps/goal,1);
  ctx.strokeStyle='#EDE8DC';ctx.lineWidth=lw;ctx.lineCap='round';
  ctx.beginPath();ctx.arc(cx,cy,R,-Math.PI/2,-Math.PI/2+Math.PI*2);ctx.stroke();
  if(pct>0){
    const grad=ctx.createLinearGradient(0,0,W,H);
    grad.addColorStop(0,TEAL);grad.addColorStop(1,'#0D9982');
    ctx.strokeStyle=grad;ctx.lineWidth=lw;ctx.lineCap='round';
    ctx.beginPath();ctx.arc(cx,cy,R,-Math.PI/2,-Math.PI/2+pct*Math.PI*2);ctx.stroke();
  }
  ctx.fillStyle=TEAL;ctx.textAlign='center';ctx.textBaseline='middle';
  ctx.font=`bold ${Math.round(W*0.14)}px 'Instrument Sans'`;
  ctx.fillText(Math.round(pct*100)+'%',cx,cy);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STEPS & FEVER UPDATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateStepsUI(){
  const pct=Math.min(totalSteps/todayStepGoal,1);
  const pctStr=(pct*100).toFixed(0)+'%';
  document.getElementById('sv-steps').textContent=totalSteps.toLocaleString();
  document.getElementById('steps-goal-text').textContent=`Goal: ${todayStepGoal.toLocaleString()} ¬∑ ${pctStr}`;
  document.getElementById('steps-card-bar').style.width=(pct*100)+'%';
  document.getElementById('meta-steps').textContent=totalSteps.toLocaleString();
  // Wellness page
  document.getElementById('wellness-steps').textContent=totalSteps.toLocaleString();
  document.getElementById('wellness-steps-goal').textContent=`Goal: ${todayStepGoal.toLocaleString()} ¬∑ ${pctStr}`;
  document.getElementById('steps-progress-bar').style.width=(pct*100)+'%';
  document.getElementById('ws-calories').textContent=Math.round(totalSteps*0.04);
  document.getElementById('ws-distance').textContent=(totalSteps*0.00076).toFixed(1);
  document.getElementById('ws-active').textContent=Math.round(totalSteps/100);
  document.getElementById('ws-floors').textContent=Math.round(totalSteps/1500);
  document.getElementById('g-steps').textContent=`${totalSteps.toLocaleString()} / ${todayStepGoal.toLocaleString()}`;
  document.getElementById('gbar-steps').style.width=(pct*100)+'%';
  document.getElementById('g-calories').textContent=`${Math.round(totalSteps*0.04)} / 2200`;
  document.getElementById('gbar-calories').style.width=Math.min(totalSteps*0.04/22,100)+'%';
  drawStepsDonut('steps-donut',totalSteps,todayStepGoal);
  drawStepsDonut('steps-donut-card',totalSteps,todayStepGoal);
  // Badges
  const badges=[];
  if(totalSteps>=2500)badges.push({label:'Early Bird',color:'#1A7B4A',bg:'#E6F4EE'});
  if(totalSteps>=5000)badges.push({label:'Halfway',color:'#C97B1A',bg:'#FEF3E2'});
  if(totalSteps>=7500)badges.push({label:'Active',color:'#1A5C9C',bg:'#E6EEF8'});
  if(totalSteps>=10000)badges.push({label:'Goal! üéâ',color:'#0A7B6C',bg:'#E0F4F1'});
  const html=badges.map(b=>`<span class="steps-badge" style="background:${b.bg};color:${b.color}">${b.label}</span>`).join('');
  document.getElementById('steps-badges-card').innerHTML=html;
  if(document.getElementById('steps-badges'))document.getElementById('steps-badges').innerHTML=html;
}

function updateFeverUI(temp){
  const el=document.getElementById('fever-big-val');if(el)el.textContent=temp.toFixed(1);
  document.getElementById('meta-fever').textContent=temp.toFixed(1)+'¬∞';
  // Zone classification
  let status,color,bg;
  if(temp<36){status='Hypothermic';color='#1A7B4A';bg='var(--teal-lt)';}
  else if(temp<36.5){status='Sub-normal';color='#0A7B6C';bg='var(--teal-lt)';}
  else if(temp<=37.5){status='Normal';color='#1A7B4A';bg:'var(--green-lt)';}
  else if(temp<=38.0){status='Low-grade Fever';color:'#C97B1A';bg='var(--amber-lt)';}
  else if(temp<=39.0){status='Fever';color:'#E67E22';bg='var(--amber-lt)';}
  else if(temp<=40.0){status='High Fever üö®';color:'#C0392B';bg='var(--red-lt)';}
  else{status='Hyperpyrexia ‚ö†Ô∏è';color:'#8B0000';bg='#FFEBEE';}
  const badge=document.getElementById('fever-status-badge');
  if(badge){badge.textContent=(temp<=37.5?'‚úì ':temp<=38?'‚ö† ':'üö® ')+status;badge.style.color=color;badge.style.background=bg;}
  // Arrow position (pct of 35 to 41 range = 6¬∞)
  const arrowPct=Math.max(0,Math.min(100,(temp-35)/6*100));
  const arrowEl=document.getElementById('fever-arrow');if(arrowEl)arrowEl.style.left=`calc(${arrowPct}% - 8px)`;
  // Fever signal card
  const sv=document.getElementById('sv-fever');if(sv)sv.textContent=temp.toFixed(1);
  // Stats
  tempBuf.push(temp);if(tempBuf.length>144)tempBuf.shift();
  const todayTemps=tempBuf.filter(v=>v>0);
  if(todayTemps.length){
    document.getElementById('temp-min').textContent=Math.min(...todayTemps).toFixed(1);
    document.getElementById('temp-max').textContent=Math.max(...todayTemps).toFixed(1);
    document.getElementById('temp-avg').textContent=(todayTemps.reduce((a,b)=>a+b,0)/todayTemps.length).toFixed(1);
    const recent=tempBuf.slice(-6);
    const trend=recent[recent.length-1]-recent[0];
    document.getElementById('temp-trend-val').textContent=trend>0.2?'Rising‚Üë':trend<-0.2?'Falling‚Üì':'Stable';
  }
  drawFeverMiniChart(temp);
}

function drawFeverMiniChart(currentTemp){
  const canvas=document.getElementById('fever-mini-chart');if(!canvas)return;
  const dpr=window.devicePixelRatio||1;const W=canvas.offsetWidth||300,H=60;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
  ctx.clearRect(0,0,W,H);
  const data=tempBuf.slice(-60);const n=data.length;if(n<2)return;
  const mn=35.5,mx=40.5;
  // Fever threshold line
  const fy=H-(38-mn)/(mx-mn)*H;
  ctx.strokeStyle='rgba(192,57,43,.25)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(0,fy);ctx.lineTo(W,fy);ctx.stroke();ctx.setLineDash([]);
  ctx.strokeStyle=AMBER;ctx.lineWidth=2;ctx.lineCap='round';ctx.lineJoin='round';
  ctx.beginPath();
  for(let i=0;i<n;i++){const x=(i/(n-1))*W;const y=H-2-(data[i]-mn)/(mx-mn)*(H-4);i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
  ctx.stroke();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN UPDATE LOOP  (v3)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let lastCorrTick=0, lastPredTick=0, lastBaselineUiTick=0;
function update(){
  if(paused)return;
  tick++;scenTick++;totalSamples++;
  // Simulate steps accumulating during day
  if(tick%50===0&&totalSteps<todayStepGoal*1.1){
    totalSteps+=Math.round(Math.random()*8+2);
    updateStepsUI();
  }
  const fn=scenarioFns[scenario]||scenarioFns.normal;
  const raw=fn(scenTick);
  const vals={};
  SIGNALS.forEach(s=>{
    if(s.key==='steps'){vals[s.key]=totalSteps;return;}
    vals[s.key]=clamp(parseFloat((raw[s.key]??s.base).toFixed(2)),s.range[0],s.range[1]);
  });
  SIGNALS.forEach(s=>{
    bufs[s.key].push(vals[s.key]);
    if(bufs[s.key].length>BUFSZ)bufs[s.key].shift();
    // Feed personal baseline learning (all signals except steps)
    if(s.key!=='steps') updateBaseline(s.key, vals[s.key]);
  });

  const {hri,maha,lstm,zMap}=computeHRI(vals);

  // Store HRI history for prediction
  HRI_HIST.push(hri); if(HRI_HIST.length>120) HRI_HIST.shift();

  const meta=hriMeta(hri);
  drawHRI(hri);
  document.getElementById('hri-num').textContent=hri;
  document.getElementById('hri-num').style.color=meta.color;
  const badge=document.getElementById('hri-badge');
  badge.textContent='‚óè '+meta.label;badge.style.color=meta.color;badge.style.background=meta.bg;badge.style.border=`1.5px solid ${meta.color}40`;
  document.getElementById('hri-title').textContent=meta.title;
  document.getElementById('hri-desc').textContent=meta.desc;
  document.getElementById('meta-maha').textContent=maha;
  document.getElementById('meta-lstm').textContent=lstm;
  document.getElementById('meta-samples').textContent=totalSamples;
  const sec=Math.floor((Date.now()-sessionStart)/1000);
  document.getElementById('meta-uptime').textContent=sec<60?sec+'s':Math.floor(sec/60)+'m';
  document.getElementById('monitor-time').textContent=`Updated ${new Date().toLocaleTimeString()} ‚Äî 10 Hz`;
  // Update fever
  updateFeverUI(vals.fever);

  // Signal cards
  SIGNALS.filter(s=>s.key!=='steps').forEach(s=>{
    const v=vals[s.key];
    const dec=s.key==='spo2'||s.key==='temp'||s.key==='fever'||s.key==='headache'||s.key==='weakness'?1:s.key==='gsr'?2:s.key==='bps'||s.key==='bpd'?0:0;
    const el=document.getElementById(`sv-${s.key}`);if(el)el.textContent=v.toFixed(dec);
    const pct=((v-s.range[0])/(s.range[1]-s.range[0])*100).toFixed(1);
    const bar=document.getElementById(`sb-${s.key}`);if(bar)bar.style.width=pct+'%';
    const dot=document.getElementById(`sd-${s.key}`);
    const card=document.getElementById(`sigcard-${s.key}`);

    // Use Z-score for anomaly flag (>2.5œÉ from personal baseline)
    const z = Math.abs(getZScore(s.key, v));
    const isAnom = z > 2.5 || v < s.lo || v > s.hi;
    if(dot){dot.style.background=isAnom?RED:'#1A7B4A';dot.style.boxShadow=isAnom?`0 0 5px ${RED}`:'none';}
    if(card){isAnom?card.classList.add('alert-anim'):card.classList.remove('alert-anim');}

    // Show Z-score on trend line
    if(tick%3===0)drawMini(s.key);
    const buf=bufs[s.key];const recent=buf.slice(-20);const prev=buf.slice(-40,-20);
    const rMean=recent.reduce((a,b)=>a+b,0)/recent.length;const pMean=prev.reduce((a,b)=>a+b,0)/prev.length;
    const diff=rMean-pMean;
    const tEl=document.getElementById(`st-${s.key}`);
    const pb=personalBaseline[s.key];
    const std=pb.std||s.std||0.01;
    if(tEl){
      const arrow=diff>std*.3?'‚Üë':diff<-std*.3?'‚Üì':'‚Üî';
      const col=z>2?RED:z>1.5?AMBER:z>1?ORG:'var(--ink3)';
      const zLabel=pb.isLearned?` Z:${(getZScore(s.key,v)).toFixed(1)}`:'';
      tEl.innerHTML=`<span style="color:${col}">${arrow}</span><span style="margin-left:2px;color:${col}">${z>2.5?'Anomaly':z>1.5?'Deviation':Math.abs(diff)<0.01?'Stable':diff>0?'Rising':'Falling'}${zLabel}</span>`;
    }
    // Update range display with personal baseline if learned
    const rangeEl=document.getElementById(`sr-${s.key}`);
    if(rangeEl && pb.isLearned){
      const dec2=s.key==='spo2'||s.key==='temp'||s.key==='fever'||s.key==='headache'||s.key==='weakness'?1:s.key==='gsr'?2:0;
      rangeEl.innerHTML=`<span style="color:var(--teal);font-weight:600">Personal: ${(pb.mean-pb.std).toFixed(dec2)}‚Äì${(pb.mean+pb.std).toFixed(dec2)}</span>`;
    }
  });

  if(tick-lastCorrTick>=50){lastCorrTick=tick;updateCorrMatrix();}

  // Update prediction every 20 ticks
  if(tick-lastPredTick>=20){lastPredTick=tick;updatePrediction();}

  // Update baseline learning UI every 50 ticks
  if(tick-lastBaselineUiTick>=50){lastBaselineUiTick=tick;updateBaselineUI();}

  if(meta.level!==lastAlertLevel){
    if(meta.level!=='normal')triggerAlert(hri,meta,vals);
    else resolveAlert();
    lastAlertLevel=meta.level;
  }
  // Active alert banner
  const banner=document.getElementById('active-alert-banner');
  if(meta.level!=='normal'){
    banner.classList.add('show');banner.style.borderLeftColor=meta.color;banner.style.borderColor=meta.color+'50';
    document.getElementById('ab-icon').textContent=meta.icon;
    document.getElementById('ab-level').textContent=meta.label;document.getElementById('ab-level').style.color=meta.color;
    document.getElementById('ab-time').textContent=new Date().toLocaleTimeString();
    document.getElementById('ab-msg').textContent=meta.desc;
    const chips=document.getElementById('ab-signals');chips.innerHTML='';
    SIGNALS.filter(s=>s.key!=='steps').forEach(s=>{const v=vals[s.key];const z=Math.abs(getZScore(s.key,v));const anom=z>2.5||v<s.lo||v>s.hi;if(anom){const dec=s.key==='spo2'||s.key==='temp'||s.key==='fever'||s.key==='headache'||s.key==='weakness'?1:s.key==='gsr'?2:0;chips.innerHTML+=`<span class="signal-chip" style="background:${s.bg};color:${s.color}">${s.icon} ${s.short}: ${v.toFixed(dec)} (Z:${getZScore(s.key,v).toFixed(1)})</span>`;}});
  }else{banner.classList.remove('show');}
}

function updatePrediction(){
  const pred=predictHRI();
  const el=document.getElementById('pred-widget');
  if(!el||!pred)return;
  const trendIcon=pred.trend==='rising'?'üìà':pred.trend==='falling'?'üìâ':'‚û°Ô∏è';
  const trendColor=pred.trend==='rising'?RED:pred.trend==='falling'?TEAL:AMBER;
  el.innerHTML=`
    <div style="font-size:.68rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">üîÆ Risk Prediction (2 min)</div>
    <div style="display:flex;align-items:center;gap:14px">
      <div style="font-family:var(--ff-head);font-size:2rem;font-weight:700;color:${trendColor}">${pred.predicted}</div>
      <div>
        <div style="font-size:.78rem;font-weight:600;color:${trendColor}">${trendIcon} ${pred.trend.charAt(0).toUpperCase()+pred.trend.slice(1)}</div>
        <div style="font-size:.66rem;color:var(--ink3)">Slope: ${pred.slope}/tick</div>
      </div>
    </div>`;
}

function updateBaselineUI(){
  const container=document.getElementById('baseline-learning-status');
  if(!container)return;
  const sigs=SIGNALS.filter(s=>s.key!=='steps');
  const total=sigs.length;
  const learned=sigs.filter(s=>personalBaseline[s.key].isLearned).length;
  const pct=Math.round(learned/total*100);
  const minN=Math.min(...sigs.map(s=>personalBaseline[s.key].n));
  const progress=Math.min(minN/MIN_SAMPLES_FOR_PERSONALIZATION*100,100);
  container.innerHTML=`
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
      <span style="font-size:.68rem;font-weight:600;color:var(--ink3);text-transform:uppercase;letter-spacing:.05em">üß† Baseline Learning</span>
      <span style="font-size:.72rem;font-weight:700;color:${pct===100?TEAL:AMBER}">${pct}% Personalized</span>
    </div>
    <div style="height:6px;background:var(--cream2);border-radius:3px;overflow:hidden;margin-bottom:6px">
      <div style="height:100%;border-radius:3px;background:${progress>=100?TEAL:AMBER};width:${progress}%;transition:width .5s"></div>
    </div>
    <div style="font-size:.66rem;color:var(--ink3)">${progress<100?`Collecting data‚Ä¶ ${minN}/${MIN_SAMPLES_FOR_PERSONALIZATION} samples`:`Personal model active ¬∑ ${sigs[0]&&personalBaseline[sigs[0].key].n} samples learned`}</div>`;

  // Update live baseline bars
  SIGNALS.filter(s=>s.key!=='steps').forEach(s=>{
    const pb=personalBaseline[s.key];
    const mean=pb.isLearned?pb.mean:s.base;
    const dec=s.key==='spo2'||s.key==='temp'||s.key==='fever'||s.key==='headache'||s.key==='weakness'?1:s.key==='gsr'?2:0;
    const pct=((mean-s.range[0])/(s.range[1]-s.range[0])*100).toFixed(0);
    const fillEl=document.getElementById(`blf-${s.key}`);
    const valEl=document.getElementById(`blv-${s.key}`);
    if(fillEl) fillEl.style.width=pct+'%';
    if(valEl) valEl.textContent=`${mean.toFixed(dec)} ${s.unit}`;
  });
  // Also update blood volume display
  const bvEl=document.getElementById('blood-volume-display');
  if(bvEl){
    const wt=parseFloat(document.getElementById('edit-weight')?.value||72);
    const ht=parseFloat(document.getElementById('edit-height')?.value||175);
    const gen=document.getElementById('edit-gender')?.value||'Male';
    const bv=estimateBloodVolume(wt,ht,gen);
    bvEl.innerHTML=`<span style="font-family:var(--ff-head);font-size:1.4rem;font-weight:600;color:#922B21">${bv}</span><span style="font-size:.7rem;color:var(--ink3);margin-left:4px">Litres</span>`;
  }
}

function updateCorrMatrix(){
  const sigs=SIGNALS.filter(s=>s.key!=='steps'&&s.key!=='fever');
  sigs.forEach((s1,i)=>{
    sigs.forEach((s2,j)=>{
      if(i===j)return;
      const a=bufs[s1.key].slice(-100),b=bufs[s2.key].slice(-100);
      const n=a.length;const ma=a.reduce((x,y)=>x+y,0)/n,mb=b.reduce((x,y)=>x+y,0)/n;
      let nm=0,da=0,db=0;
      for(let k=0;k<n;k++){const ea=a[k]-ma,eb=b[k]-mb;nm+=ea*eb;da+=ea*ea;db+=eb*eb;}
      const r=(da&&db)?nm/Math.sqrt(da*db):0;
      const c=document.getElementById(`cc-${i}-${j}`);if(!c)return;
      const abs=Math.abs(r);
      c.style.background=r>0?`rgba(10,123,108,${0.08+0.7*abs})`:`rgba(192,57,43,${0.08+0.7*abs})`;
      c.textContent=r.toFixed(1);c.style.color=abs>0.4?'#fff':(r>0?TEAL:RED);c.style.fontSize=abs>0.5?'.58rem':'.5rem';
    });
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ALERTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function triggerAlert(hri,meta,vals){
  const now=Date.now();if(now-lastAlertMs<4000)return;
  lastAlertMs=now;
  alertCounts.total++;
  if(meta.level==='critical'||meta.level==='emergency')alertCounts.critical++;
  else if(meta.level==='high')alertCounts.high++;
  else alertCounts.elevated++;
  document.getElementById('astat-total').textContent=alertCounts.total;
  document.getElementById('astat-critical').textContent=alertCounts.critical;
  document.getElementById('astat-high').textContent=alertCounts.high;
  document.getElementById('ps-alerts').textContent=alertCounts.total;
  const nb=document.getElementById('alert-nav-badge');nb.textContent=alertCounts.total;nb.classList.add('show');
  const entry={id:alertCounts.total,hri,level:meta.level,label:meta.label,color:meta.color,bg:meta.bg,icon:meta.icon,title:meta.title,desc:meta.desc,time:new Date().toLocaleTimeString(),
    signals:SIGNALS.filter(s=>s.key!=='steps'&&(vals[s.key]<s.lo||vals[s.key]>s.hi)).map(s=>{const dec=s.key==='spo2'||s.key==='temp'||s.key==='fever'?1:s.key==='gsr'?2:0;return{key:s.key,short:s.short,icon:s.icon,val:vals[s.key].toFixed(dec),color:s.color,bg:s.bg}})};
  alertLogData.unshift(entry);renderAlertList();
  showToast(meta.icon+' '+meta.label,`HRI ${hri} ‚Äî ${meta.title}`,meta.level);
}
function resolveAlert(){alertCounts.resolved=(alertCounts.resolved||0)+1;document.getElementById('astat-resolved').textContent=alertCounts.resolved;}
function renderAlertList(){
  const list=document.getElementById('alert-list');
  const filtered=currentFilter==='all'?alertLogData:alertLogData.filter(a=>a.level===currentFilter||a.category===currentFilter);
  if(filtered.length===0){list.innerHTML='<div class="empty-state"><div class="empty-state-icon">üîî</div>No alerts matching this filter.</div>';return;}
  list.innerHTML='';
  filtered.forEach(a=>{
    const row=document.createElement('div');row.className='alert-row fadein';
    const sigChips=a.signals.map(s=>`<span class="signal-chip" style="background:${s.bg};color:${s.color}">${s.icon} ${s.short}: ${s.val}</span>`).join('');
    row.innerHTML=`<div class="alert-row-icon" style="background:${a.bg}">${a.icon}</div>
      <div class="alert-row-body">
        <div class="alert-row-top"><span class="alert-row-level" style="background:${a.bg};color:${a.color}">${a.label}</span><span class="alert-row-hri" style="color:${a.color}">HRI ${a.hri}</span><span class="alert-row-time">${a.time}</span></div>
        <div class="alert-row-title">${a.title}</div>
        <div class="alert-row-desc">${a.desc}</div>
        ${sigChips?`<div class="alert-row-signals">${sigChips}</div>`:''}
      </div>`;
    list.appendChild(row);
  });
}
function filterAlerts(f,btn){currentFilter=f;document.querySelectorAll('.filter-chip').forEach(b=>b.classList.remove('active'));btn.classList.add('active');renderAlertList();}
function clearAlerts(){alertLogData=[];alertCounts={total:0,critical:0,high:0,elevated:0,resolved:0};document.getElementById('astat-total').textContent='0';document.getElementById('astat-critical').textContent='0';document.getElementById('astat-high').textContent='0';document.getElementById('astat-resolved').textContent='0';document.getElementById('alert-nav-badge').classList.remove('show');document.getElementById('ps-alerts').textContent='0';renderAlertList();}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MICROPHONE / BEHAVIOUR AI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const BEHAVIOURS=[
  {key:'cough',label:'Coughing',icon:'üòÆ‚Äçüí®',color:'#C0392B',desc:'Repetitive forced exhalation detected'},
  {key:'smoking',label:'Smoking',icon:'üö¨',color:'#6B5E56',desc:'Prolonged inhale-exhale pattern detected'},
  {key:'drinking',label:'Drinking',icon:'üíß',color:'#1A5C9C',desc:'Swallowing sound sequence detected'},
  {key:'sneeze',label:'Sneezing',icon:'ü§ß',color:'#E67E22',desc:'Sudden burst exhalation detected'},
  {key:'snore',label:'Snoring',icon:'üò¥',color:'#7B1A9C',desc:'Rhythmic airway vibration detected'},
];

// Simulated confidence values (realistic-looking)
let behaviourConfs={cough:0,smoking:0,drinking:0,sneeze:0,snore:0};
let micTick=0;

function buildBehaviourPanel(){
  const container=document.getElementById('behaviour-detections');container.innerHTML='';
  BEHAVIOURS.forEach(b=>{
    container.innerHTML+=`<div class="mic-det-row">
      <div class="mic-det-label">${b.icon} <span>${b.label}</span></div>
      <div class="mic-det-bar"><div class="mic-det-fill" id="mic-fill-${b.key}" style="width:0%"></div></div>
      <div class="mic-det-conf" id="mic-conf-${b.key}">0%</div>
    </div>`;
  });
}

async function toggleMic(){
  if(!micActive){
    try{
      if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){
        micStream=await navigator.mediaDevices.getUserMedia({audio:true});
        const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
        micAnalyser=audioCtx.createAnalyser();
        micAnalyser.fftSize=256;
        const source=audioCtx.createMediaStreamSource(micStream);
        source.connect(micAnalyser);
        startMicVis(micAnalyser);
        showToast('üéôÔ∏è Microphone Active','Real-time behaviour detection started','normal');
      }else{
        // Demo mode if no mic available
        startMicDemo();
      }
    }catch(e){startMicDemo();}
    micActive=true;micSessionStart=Date.now();
    document.getElementById('mic-main-btn').textContent='‚èπ Stop Listening';
    document.getElementById('mic-main-btn').className='btn btn-danger btn-sm';
    document.getElementById('nav-mic-btn').classList.add('listening');
    document.getElementById('nav-mic-dot').style.animation='livepulse 1.2s ease-in-out infinite';
    document.getElementById('nav-mic-text').textContent='Mic on';
    document.getElementById('mic-vis-dot').style.animation='livepulse 1.2s ease-in-out infinite';
  }else{
    stopMic();
  }
}

function stopMic(){
  micActive=false;
  if(micStream)micStream.getTracks().forEach(t=>t.stop());
  if(micAnimFrame)cancelAnimationFrame(micAnimFrame);
  document.getElementById('mic-main-btn').textContent='üéôÔ∏è Start Listening';
  document.getElementById('mic-main-btn').className='btn btn-purple btn-sm';
  document.getElementById('nav-mic-btn').classList.remove('listening');
  document.getElementById('nav-mic-dot').style.animation='none';
  document.getElementById('nav-mic-text').textContent='Mic off';
  document.getElementById('mic-vis-dot').style.animation='none';
  clearCanvas('mic-waveform');
  showToast('üéôÔ∏è Microphone Off','Behaviour detection paused','normal');
}

function toggleMicFromNav(){
  if(!micActive)toggleMic();else stopMic();
}

function startMicVis(analyser){
  const canvas=document.getElementById('mic-waveform');
  function draw(){
    micAnimFrame=requestAnimationFrame(draw);
    const dpr=window.devicePixelRatio||1;
    const W=canvas.offsetWidth||300,H=60;
    canvas.width=W*dpr;canvas.height=H*dpr;
    canvas.style.width=W+'px';canvas.style.height=H+'px';
    const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
    ctx.clearRect(0,0,W,H);
    const bufLen=analyser.frequencyBinCount;
    const data=new Uint8Array(bufLen);
    analyser.getByteTimeDomainData(data);
    ctx.strokeStyle='#c46be8';ctx.lineWidth=2;ctx.beginPath();
    for(let i=0;i<bufLen;i++){const x=(i/bufLen)*W;const y=(data[i]/128)*H/2;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}
    ctx.stroke();
    updateBehaviourSim();
  }
  draw();
}

function startMicDemo(){
  const canvas=document.getElementById('mic-waveform');
  function draw(){
    micAnimFrame=requestAnimationFrame(draw);
    if(!micActive)return;
    const dpr=window.devicePixelRatio||1;
    const W=canvas.offsetWidth||300,H=60;
    canvas.width=W*dpr;canvas.height=H*dpr;
    canvas.style.width=W+'px';canvas.style.height=H+'px';
    const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);
    ctx.clearRect(0,0,W,H);
    const t=Date.now()/200;
    ctx.strokeStyle='#c46be8';ctx.lineWidth=2;ctx.beginPath();
    for(let i=0;i<W;i++){const y=H/2+Math.sin(i*0.08+t)*(10+Math.sin(t*0.5+i*0.02)*8)+randn(.8)*3;i===0?ctx.moveTo(i,y):ctx.lineTo(i,y);}
    ctx.stroke();
    updateBehaviourSim();
  }
  draw();
}

let lastBehaviourDetect=0;
function updateBehaviourSim(){
  if(!micActive)return;
  micTick++;
  const now=Date.now();
  // Update session time
  if(micSessionStart){const s=Math.floor((now-micSessionStart)/1000);document.getElementById('mic-session-time').textContent=s<60?s+'s':Math.floor(s/60)+'m';}
  // Simulate slowly changing confidence
  BEHAVIOURS.forEach(b=>{
    const target=Math.max(0,Math.min(100,behaviourConfs[b.key]+randn(4)));
    behaviourConfs[b.key]=behaviourConfs[b.key]*0.88+target*0.12;
    const el=document.getElementById(`mic-fill-${b.key}`);
    const conf=document.getElementById(`mic-conf-${b.key}`);
    if(el)el.style.width=behaviourConfs[b.key].toFixed(0)+'%';
    if(conf)conf.textContent=behaviourConfs[b.key].toFixed(0)+'%';
  });
  // Random spike = detection event
  if(micTick%80===0){
    const b=BEHAVIOURS[Math.floor(Math.random()*BEHAVIOURS.length)];
    behaviourConfs[b.key]=Math.min(100,behaviourConfs[b.key]+Math.random()*50+30);
    if(now-lastBehaviourDetect>3000&&behaviourConfs[b.key]>70){
      lastBehaviourDetect=now;
      logBehaviourDetection(b);
    }
  }
  // AI text
  const top=BEHAVIOURS.reduce((a,b)=>behaviourConfs[a.key]>behaviourConfs[b.key]?a:b);
  const aiTexts={
    cough:`Repeated forced exhalation pattern detected. Confidence ${behaviourConfs.cough.toFixed(0)}%. May indicate respiratory irritation or infection.`,
    smoking:`Extended slow-breathing pattern with pause detected. Confidence ${behaviourConfs.smoking.toFixed(0)}%. Monitoring for sustained pattern.`,
    drinking:`Sequential deglutition sounds detected. Confidence ${behaviourConfs.drinking.toFixed(0)}%. Pattern consistent with fluid intake.`,
    sneeze:`Brief high-amplitude acoustic burst detected. Confidence ${behaviourConfs.sneeze.toFixed(0)}%. Consistent with sneezing pattern.`,
    snore:`Low-frequency rhythmic vibration detected. Confidence ${behaviourConfs.snore.toFixed(0)}%. Consistent with sleep apnoea pattern.`,
  };
  const aiEl=document.getElementById('mic-ai-text');
  if(aiEl&&behaviourConfs[top.key]>25)aiEl.textContent=aiTexts[top.key];
  else if(aiEl)aiEl.textContent='Monitoring ambient audio. No significant behavioural pattern detected. Baseline noise level normal.';
}

function logBehaviourDetection(b){
  micTotalDetections++;
  if(b.key==='cough')micDetectionCounts.cough++;
  document.getElementById('mic-detections-count').textContent=micTotalDetections;
  document.getElementById('mic-cough-count').textContent=micDetectionCounts.cough;
  const log=document.getElementById('mic-log');
  const emptyState=log.querySelector('.empty-state');if(emptyState)emptyState.remove();
  const entry=document.createElement('div');
  entry.style.cssText='display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);animation:fadein .3s ease';
  entry.innerHTML=`<span style="font-size:1.1rem">${b.icon}</span><div style="flex:1"><div style="font-size:.8rem;font-weight:600;color:var(--ink)">${b.label}</div><div style="font-size:.7rem;color:var(--ink3)">${b.desc}</div></div><div style="font-size:.7rem;color:var(--ink3)">${new Date().toLocaleTimeString()}</div>`;
  log.insertBefore(entry,log.firstChild);
  // Add to alerts
  const alertEntry={id:alertCounts.total+1,hri:0,level:'elevated',label:b.label,color:b.color,bg:'var(--cream)',icon:b.icon,title:`Behaviour Detected: ${b.label}`,desc:b.desc,time:new Date().toLocaleTimeString(),category:'behaviour',signals:[]};
  alertLogData.unshift(alertEntry);
  showToast(b.icon+' '+b.label+' Detected',b.desc,'elevated');
}

function clearCanvas(id){const c=document.getElementById(id);if(c){const ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   HISTORY PAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let historyTab='7d';
function buildHistoryPage(){
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const hriData=[18,22,35,28,19,45,68];
  const events=[0,0,1,0,0,2,alertCounts.total||0];
  const avg=Math.round(hriData.reduce((a,b)=>a+b,0)/hriData.length);
  const peak=Math.max(...hriData);
  document.getElementById('tr-avg').textContent=avg;
  document.getElementById('tr-peak').textContent=peak;
  document.getElementById('tr-events').textContent=events.reduce((a,b)=>a+b,0)+alertCounts.total;
  drawHistoryChart('hri-trend-chart',days,hriData,'#0A7B6C');
  drawBarChart('sig-avg-chart');
  drawTempHistoryChart();
  drawStepsHistoryChart();
  // Daily summary
  const ds=document.getElementById('daily-summary');ds.innerHTML='';
  const stepData=[3200,6800,8100,4500,9200,5600,totalSteps];
  days.forEach((d,i)=>{
    const v=hriData[i];const c=v<=30?'#1A7B4A':v<=55?'#C97B1A':v<=75?'#B85A00':'#C0392B';
    ds.innerHTML+=`<div class="day-row"><span class="day-label">${d}</span><div class="day-bar-track"><div class="day-bar-fill" style="width:${v}%;background:${c}"></div></div><span class="day-score" style="color:${c}">${v}</span><span class="day-events" style="font-size:.65rem;color:var(--ink3)">üë£ ${stepData[i].toLocaleString()}</span><span class="day-events">${events[i]?events[i]+' alert':'‚Äî'}</span></div>`;
  });
  const patterns=[
    {title:'üß¨ HR-HRV Coupling',color:TEAL,bg:'var(--teal-lt)',desc:'Strong inverse correlation (r=‚àí0.78). Normal autonomic function.'},
    {title:'ü©µ SpO‚ÇÇ Stability',color:'#1A5C9C',bg:'var(--blue-lt)',desc:'Oxygen stable at 98.2¬±0.4%. No hypoxia risk.'},
    {title:'üå°Ô∏è Temperature Trend',color:AMBER,bg:'var(--amber-lt)',desc:'Slight elevation Sunday afternoon. Correlated with elevated HR.'},
    {title:'üë£ Activity Pattern',color:TEAL,bg:'var(--teal-lt)',desc:'Average 5,800 steps/day. Below 10K goal on 5/7 days.'},
  ];
  const pg=document.getElementById('pattern-grid');pg.innerHTML='';
  patterns.forEach(p=>{pg.innerHTML+=`<div class="pattern-card" style="background:${p.bg};border-color:${p.color}40"><div class="pattern-card-title" style="color:${p.color}">${p.title}</div><div class="pattern-card-body">${p.desc}</div></div>`;});
}

function drawTempHistoryChart(){
  const canvas=document.getElementById('temp-trend-chart');if(!canvas)return;
  const dpr=window.devicePixelRatio||1;const W=canvas.offsetWidth||300,H=160;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const data=[36.8,36.9,37.1,38.2,37.6,36.8,36.9];
  const pad={t:10,b:30,l:8,r:8};const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;
  const mn=36,mx=39.5;const n=data.length;
  // Fever threshold band
  const fy=pad.t+(1-(38-mn)/(mx-mn))*cH;
  ctx.fillStyle='rgba(192,57,43,.06)';ctx.fillRect(pad.l,pad.t,cW,fy-pad.t);
  ctx.strokeStyle='rgba(192,57,43,.3)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(pad.l,fy);ctx.lineTo(W-pad.r,fy);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='rgba(192,57,43,.6)';ctx.font='9px Instrument Sans';ctx.fillText('Fever 38¬∞C',pad.l+4,fy-3);
  data.forEach((v,i)=>{
    const x=pad.l+(i/(n-1))*cW;const y=pad.t+(1-(v-mn)/(mx-mn))*cH;
    const c=v>=38?RED:v>=37.5?AMBER:TEAL;
    ctx.fillStyle=c;ctx.beginPath();ctx.arc(x,y,5,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(26,20,16,.5)';ctx.font='10px Instrument Sans';ctx.textAlign='center';ctx.fillText(labels[i],x,H-pad.b+14);
    ctx.fillStyle=c;ctx.font='bold 9px Instrument Sans';ctx.fillText(v.toFixed(1),x,y-8);
  });
  // Line
  ctx.strokeStyle=AMBER;ctx.lineWidth=2;ctx.beginPath();
  data.forEach((v,i)=>{const x=pad.l+(i/(n-1))*cW;const y=pad.t+(1-(v-mn)/(mx-mn))*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();
}

function drawStepsHistoryChart(){
  const canvas=document.getElementById('steps-chart');if(!canvas)return;
  const dpr=window.devicePixelRatio||1;const W=canvas.offsetWidth||300,H=160;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const labels=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const data=[3200,6800,8100,4500,9200,5600,totalSteps||2100];
  const goal=todayStepGoal;
  const pad={t:10,b:28,l:8,r:8};const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;
  const n=data.length;const mx=12000;
  const barW=Math.max(cW/n*0.6,16);const gap=(cW-(barW*n))/(n+1);
  // Goal line
  const gy=pad.t+(1-goal/mx)*cH;
  ctx.strokeStyle='rgba(10,123,108,.4)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
  ctx.beginPath();ctx.moveTo(pad.l,gy);ctx.lineTo(W-pad.r,gy);ctx.stroke();ctx.setLineDash([]);
  ctx.fillStyle='rgba(10,123,108,.7)';ctx.font='9px Instrument Sans';ctx.fillText('Goal',pad.l+4,gy-3);
  data.forEach((v,i)=>{
    const x=pad.l+gap+(barW+gap)*i;const bH=(v/mx)*cH;const y=pad.t+cH-bH;
    const c=v>=goal?TEAL:v>=goal*0.75?AMBER:RED;
    const grad=ctx.createLinearGradient(0,y,0,y+bH);grad.addColorStop(0,c);grad.addColorStop(1,c+'80');
    ctx.fillStyle=grad;ctx.beginPath();
    ctx.moveTo(x+4,y);ctx.lineTo(x+barW-4,y);ctx.quadraticCurveTo(x+barW,y,x+barW,y+4);
    ctx.lineTo(x+barW,y+bH);ctx.lineTo(x,y+bH);ctx.lineTo(x,y+4);ctx.quadraticCurveTo(x,y,x+4,y);ctx.closePath();ctx.fill();
    ctx.fillStyle='rgba(26,20,16,.5)';ctx.font='9px Instrument Sans';ctx.textAlign='center';ctx.fillText(labels[i],x+barW/2,H-pad.b+12);
  });
}

function drawHistoryChart(id,labels,data,color){
  const canvas=document.getElementById(id);if(!canvas)return;
  const dpr=window.devicePixelRatio||1;const W=canvas.offsetWidth||600,H=120;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const pad={t:10,b:30,l:8,r:8};const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;const n=data.length;
  const bands=[{from:0,to:.3,c:'#1A7B4A08'},{from:.3,to:.55,c:'#C97B1A08'},{from:.55,to:1,c:'#C0392B08'}];
  bands.forEach(b=>{ctx.fillStyle=b.c;ctx.fillRect(pad.l,pad.t+cH*(1-b.to),cW,cH*(b.to-b.from));});
  [25,50,75].forEach(v=>{const y=pad.t+(1-v/100)*cH;ctx.strokeStyle='rgba(26,20,16,.06)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();});ctx.setLineDash([]);
  const grad=ctx.createLinearGradient(0,pad.t,0,H-pad.b);grad.addColorStop(0,color+'40');grad.addColorStop(1,color+'00');
  ctx.fillStyle=grad;ctx.beginPath();ctx.moveTo(pad.l,pad.t+cH);
  for(let i=0;i<n;i++){const x=pad.l+(i/(n-1))*cW;const y=pad.t+(1-data[i]/100)*cH;i===0?ctx.lineTo(x,y):ctx.lineTo(x,y);}
  ctx.lineTo(W-pad.r,pad.t+cH);ctx.closePath();ctx.fill();
  ctx.strokeStyle=color;ctx.lineWidth=2;ctx.lineCap='round';ctx.beginPath();
  for(let i=0;i<n;i++){const x=pad.l+(i/(n-1))*cW;const y=pad.t+(1-data[i]/100)*cH;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);}ctx.stroke();
  for(let i=0;i<n;i++){const x=pad.l+(i/(n-1))*cW;const y=pad.t+(1-data[i]/100)*cH;ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.fill();ctx.strokeStyle=color;ctx.lineWidth=2;ctx.beginPath();ctx.arc(x,y,4,0,Math.PI*2);ctx.stroke();ctx.fillStyle='rgba(26,20,16,.5)';ctx.font='10px Instrument Sans';ctx.textAlign='center';ctx.fillText(labels[i],x,H-pad.b+14);}
}

function drawBarChart(id){
  const canvas=document.getElementById(id);if(!canvas)return;
  const dpr=window.devicePixelRatio||1;const W=canvas.offsetWidth||300,H=160;
  canvas.width=W*dpr;canvas.height=H*dpr;canvas.style.width=W+'px';canvas.style.height=H+'px';
  const ctx=canvas.getContext('2d');ctx.scale(dpr,dpr);ctx.clearRect(0,0,W,H);
  const sigs=SIGNALS.filter(s=>s.key!=='steps'&&s.key!=='fever');
  const pad={t:8,b:28,l:8,r:8};const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;const n=sigs.length;
  const barW=Math.max(cW/n*0.55,16);const gap=(cW-(barW*n))/(n+1);
  sigs.forEach((s,i)=>{const x=pad.l+gap+(barW+gap)*i;const pct=(s.base-s.range[0])/(s.range[1]-s.range[0]);const bH=pct*cH;const y=pad.t+cH-bH;const grad=ctx.createLinearGradient(0,y,0,y+bH);grad.addColorStop(0,s.color);grad.addColorStop(1,s.color+'80');ctx.fillStyle=grad;ctx.beginPath();const r=4;ctx.moveTo(x+r,y);ctx.lineTo(x+barW-r,y);ctx.quadraticCurveTo(x+barW,y,x+barW,y+r);ctx.lineTo(x+barW,y+bH);ctx.lineTo(x,y+bH);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();ctx.fill();ctx.fillStyle='rgba(26,20,16,.5)';ctx.font='9px Instrument Sans';ctx.textAlign='center';ctx.fillText(s.short,x+barW/2,H-pad.b+12);});
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SETTINGS SECTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showSettingsSection(id,btn){
  document.querySelectorAll('.settings-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.settings-nav-item').forEach(b=>b.classList.remove('active'));
  document.getElementById('ss-'+id).classList.add('active');
  btn.classList.add('active');
}
function setProto(p,btn){
  document.querySelectorAll('.proto-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  const msgs={ble:'Scanning for BLE devices... Make sure your ESP32 is in pairing mode.',wifi:'Enter your MQTT broker address and click Connect.',usb:'Connect ESP32 via USB. Select COM port and click Connect.',demo:'Demo mode active ‚Äî simulated sensor data streaming at 10 Hz'};
  const bar=document.getElementById('conn-status');
  bar.innerHTML=`<div class="live-dot" style="background:${p==='demo'?'var(--teal2)':'var(--amber)'};box-shadow:0 0 6px ${p==='demo'?'var(--teal2)':'var(--amber)'}"></div><span>${msgs[p]}</span>`;
}
function simulateConnect(){
  const addr=document.getElementById('conn-addr').value.trim()||'ESP32-PulseIQ';
  document.getElementById('conn-status').innerHTML=`<div class="live-dot"></div><span>Connected to ${addr} ‚Äî streaming at 10 Hz</span>`;
  showToast('üì° Connected','Sensor stream active: '+addr,'normal');
}
function toggleSensor(id,card){
  const isConnected=card.classList.contains('connected');
  card.className='sensor-card '+(isConnected?'searching':'connected');
  const s=card.querySelector('.sensor-status');
  s.textContent=isConnected?'‚óå Searching...':'‚óè Connected';
  s.className='sensor-status '+(isConnected?'search':'ok');
  showToast('üì° Sensor '+(isConnected?'Disconnected':'Reconnected'),id.toUpperCase(),(isConnected?'elevated':'normal'));
}
function updateTempUnit(){
  const unit=document.getElementById('temp-unit').value;
  showToast('‚öôÔ∏è Temperature Unit','Now showing in ¬∞'+unit,'normal');
}
function updateStepGoal(val){
  todayStepGoal=parseInt(val);
  document.getElementById('step-goal-val').textContent=parseInt(val).toLocaleString();
  updateStepsUI();
}
function exportData(){
  const data={patient:document.getElementById('p-name')?.textContent||'Alex Kumar',exportedAt:new Date().toISOString(),signals:SIGNALS.map(s=>({key:s.key,base:s.base,lo:s.lo,hi:s.hi})),alertCount:alertCounts,stepsToday:totalSteps};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='pulseiq-export.json';a.click();URL.revokeObjectURL(url);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PROFILE EDIT MODAL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function openEditModal(section){
  document.getElementById('edit-modal').classList.add('show');
}
function closeEditModal(){document.getElementById('edit-modal').classList.remove('show');}
function saveProfile(){
  const first=document.getElementById('edit-first').value.trim();
  const last=document.getElementById('edit-last').value.trim();
  const full=`${first} ${last}`;
  const initials=(first[0]||'')+(last[0]||'');
  const age=document.getElementById('edit-age').value;
  const gender=document.getElementById('edit-gender').value;
  const height=document.getElementById('edit-height').value;
  const weight=document.getElementById('edit-weight').value;
  const bmi=(weight/((height/100)**2)).toFixed(1);
  const pid=document.getElementById('edit-pid').value;
  // Update all display elements
  document.getElementById('nav-name').textContent=full;
  document.getElementById('nav-avatar').textContent=initials;
  document.getElementById('nav-pid').textContent=pid+' ¬∑ Edit ‚úèÔ∏è';
  document.getElementById('profile-name').textContent=full;
  document.getElementById('profile-id').textContent='Patient ID: '+pid+' ¬∑ Joined Jan 2024';
  document.getElementById('profile-avatar-lg').textContent=initials;
  document.getElementById('p-age').textContent=age+' years';
  document.getElementById('p-gender').textContent=gender;
  document.getElementById('p-height').textContent=height+' cm';
  document.getElementById('p-weight').textContent=weight+' kg';
  document.getElementById('p-bmi').textContent=bmi;
  document.getElementById('p-blood').textContent=document.getElementById('edit-blood').value;
  document.getElementById('p-conditions').textContent=document.getElementById('edit-conditions').value;
  document.getElementById('p-medications').textContent=document.getElementById('edit-medications').value;
  document.getElementById('p-allergies').textContent=document.getElementById('edit-allergies').value;
  document.getElementById('p-emergency').textContent=document.getElementById('edit-emergency').value;
  document.getElementById('p-physician').textContent=document.getElementById('edit-physician').value;
  closeEditModal();
  showToast('‚úÖ Profile Saved','Your profile has been updated successfully','normal');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WELLNESS ACTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addSteps(){
  const n=parseInt(prompt('How many steps to add?','500')||0);
  if(n>0){totalSteps+=n;updateStepsUI();showToast('üë£ Steps Added',`+${n} steps. Total: ${totalSteps.toLocaleString()}`,'normal');}
}
function addWater(){
  waterCount++;
  document.getElementById('g-water').textContent=`${waterCount} / 8`;
  document.getElementById('gbar-water').style.width=Math.min(waterCount/8*100,100)+'%';
  showToast('üíß Water Logged',`${waterCount}/8 glasses today. ${waterCount>=8?'Goal reached! üéâ':'Keep it up!'}`,'normal');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAV & PAGE CONTROLS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showPage(page,navBtn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  navBtn.classList.add('active');
  if(page==='history')setTimeout(buildHistoryPage,100);
  if(page==='mic')buildBehaviourPanel();
}
function setScenario(sc,btn){
  scenario=sc;scenTick=0;
  document.querySelectorAll('.scenario-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  showToast('üß™ Scenario: '+sc.charAt(0).toUpperCase()+sc.slice(1),'Simulating '+sc+' physiological pattern','normal');
}
function setHistoryTab(tab,btn){historyTab=tab;document.querySelectorAll('.history-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');buildHistoryPage();}
function togglePause(){
  paused=!paused;const btn=document.getElementById('pause-btn');
  btn.textContent=paused?'‚ñ∂ Resume':'‚è∏ Pause';
  btn.className=paused?'btn btn-primary btn-sm':'btn btn-ghost btn-sm';
}
function resetAll(){
  SIGNALS.forEach(s=>bufs[s.key].fill(s.base));
  scenario='normal';scenTick=0;totalSamples=0;sessionStart=Date.now();
  lastAlertLevel='normal';lastAlertMs=0;totalSteps=0;waterCount=0;
  document.querySelectorAll('.scenario-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.scenario-btn.full').classList.add('active');
  updateStepsUI();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TOAST
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let toastTimer=null;
function showToast(title,msg,level){
  const icons={elevated:'‚ö†Ô∏è',high:'‚ö°',critical:'üö®',emergency:'üÜò',normal:'‚úì'};
  document.getElementById('toast-icon').textContent=icons[level]||'üîî';
  document.getElementById('toast-title').textContent=title;
  document.getElementById('toast-msg').textContent=msg;
  const t=document.getElementById('toast');t.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),4500);
}
function hideToast(){document.getElementById('toast').classList.remove('show');}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
buildSignalGrid();
buildCorrGrid();
buildBaselineBars();
buildSensorGrid();
buildThresholdSettings();
buildBehaviourPanel();
drawHRI(0);
// Initial step count
totalSteps=Math.round(Math.random()*3000+1000);
updateStepsUI();
setInterval(update,100);
window.addEventListener('resize',()=>{SIGNALS.filter(s=>s.key!=='steps').forEach(s=>drawMini(s.key));if(document.getElementById('page-history').classList.contains('active'))buildHistoryPage();});
// Close modal on overlay click
document.getElementById('edit-modal').addEventListener('click',function(e){if(e.target===this)closeEditModal();});


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   v4: SMART SCHEDULE, CHATBOT,
   DISEASE MONITOR, EMERGENCY SYSTEM
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PULSEIQ PRO v4 ‚Äî SMART SCHEDULE, DISEASE MONITOR,
   CHATBOT, EMERGENCY SYSTEM, ALARM CLOCK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ‚îÄ Data ‚îÄ‚îÄ‚îÄ */
const SCHEDULE_ITEMS=[
  {id:'wakeup',icon:'‚òÄÔ∏è',name:'Wake Up',time:'06:00',type:'sleep',tip:'Drink water first! Check morning vitals.'},
  {id:'water1',icon:'üíß',name:'Drink Water',time:'07:00',type:'water',tip:'Start your day with 500ml water ‚Äî flushes toxins!'},
  {id:'breakfast',icon:'üç≥',name:'Breakfast',time:'07:30',type:'meal',tip:'High-protein breakfast. Avoid refined carbs.'},
  {id:'meds_morning',icon:'üíä',name:'Morning Medication',time:'08:30',type:'med',tip:'Take with food. Never skip! Consistency saves lives.'},
  {id:'walk1',icon:'üö∂',name:'Morning Walk',time:'09:00',type:'walk',tip:'15-30 min brisk walk reduces blood pressure!'},
  {id:'water2',icon:'üíß',name:'Drink Water',time:'10:00',type:'water',tip:'1 glass ‚Äî stay ahead of thirst!'},
  {id:'snack',icon:'üçé',name:'Mid-morning Snack',time:'10:30',type:'meal',tip:'Fruits or nuts ‚Äî keeps blood sugar stable.'},
  {id:'water3',icon:'üíß',name:'Drink Water',time:'12:00',type:'water',tip:'1 glass before lunch ‚Äî aids digestion!'},
  {id:'lunch',icon:'üç±',name:'Lunch',time:'13:00',type:'meal',tip:'50% veggies, 25% protein, 25% complex carbs.'},
  {id:'walk2',icon:'üö∂',name:'Post-lunch Walk',time:'13:30',type:'walk',tip:'10 min walk after lunch reduces sugar spikes by 30%!'},
  {id:'water4',icon:'üíß',name:'Drink Water',time:'15:00',type:'water',tip:'Afternoon energy boost ‚Äî 1 glass!'},
  {id:'tea',icon:'ü´ñ',name:'Evening Tea Break',time:'16:00',type:'meal',tip:'Green tea or herbal. Avoid high-sugar snacks.'},
  {id:'water5',icon:'üíß',name:'Drink Water',time:'17:00',type:'water',tip:'Pre-exercise hydration!'},
  {id:'exercise',icon:'üèÉ',name:'Evening Exercise',time:'18:00',type:'walk',tip:'30 min cardio/yoga ‚Äî peak performance time!'},
  {id:'dinner',icon:'üç≤',name:'Dinner',time:'19:30',type:'meal',tip:'Light dinner. Eat 3 hours before bedtime.'},
  {id:'water6',icon:'üíß',name:'Drink Water',time:'20:00',type:'water',tip:'Last large glass. Avoid fluids close to bed.'},
  {id:'meds_night',icon:'üíä',name:'Night Medication',time:'21:00',type:'med',tip:'Take as prescribed. Check blood sugar if diabetic!'},
  {id:'winddown',icon:'üåô',name:'Wind-down',time:'21:30',type:'sleep',tip:'Dim lights, no screens. Prepare for quality sleep.'},
  {id:'bedtime',icon:'üò¥',name:'Bedtime',time:'22:00',type:'sleep',tip:'8 hours sleep target ‚Äî it\'s medicine!'},
];

let userAlarms=[
  {id:1,time:'06:00',label:'‚òÄÔ∏è Wake Up ‚Äî Good Morning!',enabled:true,icon:'‚òÄÔ∏è'},
  {id:2,time:'08:30',label:'üíä Morning Medication',enabled:true,icon:'üíä'},
  {id:3,time:'21:00',label:'üíä Night Medication',enabled:true,icon:'üíä'},
];
let nextAlarmId=4;
let snoozedUntil=null;
let scheduleDoneIds=new Set();

let userConditions=[];
const CONDITION_DATA={
  heart:{label:'‚ù§Ô∏è Heart Disease',color:'#C0392B',bg:'#FDECEA',thresholds:{hr_hi:100,bps_hi:140,spo2_lo:95},emergency:'‚ö†Ô∏è Possible cardiac event! Call 108 & chew Aspirin!',dietary:'Low sodium, low fat. Omega-3 fish, nuts, olive oil.',exercise:'Light walking only. No intense cardio. Consult cardiologist.',meds:'Never miss Aspirin, statins, or beta-blockers!'},
  hypertension:{label:'ü©∏ Hypertension',color:'#922B21',bg:'#FDECEA',thresholds:{bps_hi:130,bpd_hi:85},emergency:'üö® Hypertensive crisis! Sit calmly, take medication, call doctor!',dietary:'DASH diet ‚Äî low salt <2g/day. Lots of fruits & vegetables.',exercise:'30 min moderate exercise daily reduces BP by 5-8 mmHg!',meds:'Anti-hypertensives ‚Äî take at same time every day!'},
  diabetes_t1:{label:'üç¨ Diabetes Type 1',color:'#8E44AD',bg:'#F8EFF9',thresholds:{hr_hi:105},emergency:'‚ö†Ô∏è Possible hypoglycemia! Eat glucose/sugar immediately!',dietary:'Count carbs: 45-60g per meal. CGM monitoring essential.',exercise:'Monitor blood sugar before/after exercise. Carry glucose gel.',meds:'Insulin ‚Äî NEVER skip! Multiple daily injections or pump.'},
  diabetes_t2:{label:'üç¨ Diabetes Type 2',color:'#7D3C98',bg:'#F8EFF9',thresholds:{hr_hi:105},emergency:'‚ö†Ô∏è High blood sugar! Take medication, drink water, light walk.',dietary:'Low glycemic index foods. Avoid sugar & white rice.',exercise:'150 min moderate exercise/week. Post-meal walks essential!',meds:'Metformin with food. Check blood sugar 2-4x daily.'},
  liver:{label:'ü´Å Liver Disease',color:'#B7950B',bg:'#FEF9E7',thresholds:{temp_hi:38,hr_hi:95},emergency:'üö® Liver crisis! Zero alcohol, no NSAIDs. Call doctor urgently!',dietary:'Low sodium, low protein when needed. Small frequent meals.',exercise:'Light activities ‚Äî no heavy lifting. Gentle yoga is fine.',meds:'AVOID NSAIDs and paracetamol. All meds need doctor approval.'},
  kidney:{label:'ü´ò Kidney Disease',color:'#1A5F7A',bg:'#EBF5FB',thresholds:{bps_hi:130},emergency:'üö® Monitor urine output. BP rising ‚Äî call doctor now!',dietary:'Low potassium, low phosphorus, controlled fluid intake.',exercise:'Low-impact: walking, swimming. Avoid dehydration.',meds:'No NSAIDs! Take phosphate binders with meals.'},
  asthma:{label:'üå¨Ô∏è Asthma/COPD',color:'#1A5C9C',bg:'#EBF5FB',thresholds:{spo2_lo:93,resp_hi:22},emergency:'üö® Difficulty breathing! Use rescue inhaler NOW! Call 108!',dietary:'Anti-inflammatory foods. Vitamin D, magnesium. Avoid dairy triggers.',exercise:'Warm up slowly. Always carry inhaler. Avoid cold dry air.',meds:'Rescue inhaler ALWAYS within reach! Controller inhaler daily.'},
  stroke:{label:'üß† Stroke Risk',color:'#922B21',bg:'#FDECEA',thresholds:{bps_hi:140,hr_hi:110},emergency:'üÜò FAST test: Face drooping, Arm weak, Speech slurred ‚Üí Time to call 108!',dietary:'Mediterranean diet. Omega-3. Low sodium, high potassium.',exercise:'Regular moderate exercise reduces stroke risk by 27%.',meds:'Blood thinners ‚Äî NEVER stop without doctor! Regular BP monitoring.'},
  thyroid:{label:'ü¶ã Thyroid',color:'#0E6655',bg:'#E8F8F5',thresholds:{hr_lo:55,hr_hi:110},emergency:'‚ö†Ô∏è Thyroid storm or myxedema: Seek immediate emergency care!',dietary:'Selenium-rich: Brazil nuts, tuna. Avoid soy, raw cruciferous.',exercise:'Regular moderate exercise supports thyroid function.',meds:'Levothyroxine ‚Äî empty stomach, same time daily! 45 min before food.'},
  anemia:{label:'ü©∏ Anemia',color:'#CB4335',bg:'#FDECEA',thresholds:{spo2_lo:95,hr_hi:100},emergency:'‚ö†Ô∏è Severe anemia signs (fainting, breathlessness) ‚Äî seek care!',dietary:'Iron-rich: spinach, lentils, jaggery, red meat. Vitamin C helps absorption!',exercise:'Light exercise only. Monitor for breathlessness and fatigue.',meds:'Iron with Vitamin C, not with dairy or tea. B12 supplements if needed.'},
  arthritis:{label:'ü¶¥ Arthritis',color:'#7D6608',bg:'#FEF9E7',thresholds:{},emergency:'Severe joint inflammation with fever ‚Äî see doctor immediately!',dietary:'Anti-inflammatory: turmeric, ginger, omega-3. Avoid processed foods.',exercise:'Water aerobics, gentle yoga, swimming. Low-impact daily activity.',meds:'NSAIDs with food to protect stomach. DMARD injections as scheduled.'},
  epilepsy:{label:'‚ö° Epilepsy',color:'#6C3483',bg:'#F4ECF7',thresholds:{hr_hi:130},emergency:'üÜò Seizure: Clear area, turn side, time it. If >5 min ‚Üí Call 108!',dietary:'Ketogenic diet may help. Zero alcohol. Regular meals.',exercise:'Always with companion. No swimming alone. Avoid heights.',meds:'Anti-epileptics ‚Äî NEVER miss even ONE dose! Life-critical.'},
  obesity:{label:'‚öñÔ∏è Obesity',color:'#2E86C1',bg:'#EBF5FB',thresholds:{hr_hi:100},emergency:'Chest pain + obesity ‚Üí Immediate cardiac evaluation needed!',dietary:'500 cal deficit. High fiber, high protein. Avoid liquid calories.',exercise:'Start with 10 min walking, increase by 5 min weekly.',meds:'Consult doctor before any weight loss medication.'},
  anxiety:{label:'üß† Anxiety',color:'#7B1A9C',bg:'#F3E6F8',thresholds:{hr_hi:110,hrv_lo:30},emergency:'Panic attack: 4-7-8 breathing ‚Äî breathe in 4s, hold 7s, out 8s!',dietary:'Reduce caffeine. Magnesium: dark chocolate, nuts, spinach.',exercise:'Yoga, meditation, walking ‚Äî as effective as medication for mild anxiety!',meds:'SSRIs take 4-6 weeks. NEVER stop abruptly ‚Äî taper with doctor.'},
};

let emergencyContacts=[
  {name:'Family - Priya Kumar',number:'+91 98765 43210',relation:'Spouse'},
  {name:'Family - Ravi Kumar',number:'+91 87654 32109',relation:'Son'},
];

const HOSPITALS=[
  {name:'Andhra Hospitals',address:'Governorpet, Vijayawada',distance:'1.2 km',phone:'08662477701',speciality:'Multi-specialty, 24/7 Emergency'},
  {name:'Ramesh Hospitals',address:'Collector Office Rd',distance:'2.1 km',phone:'08662455555',speciality:'Cardiology, Neurology'},
  {name:'KIMS Hospital',address:'Bandar Road',distance:'3.4 km',phone:'08662476744',speciality:'Trauma Centre, ICU'},
  {name:'Govt. General Hospital',address:'Suryaraopet',distance:'2.8 km',phone:'08662577891',speciality:'Public Hospital, Free Emergency'},
  {name:'Apollo Clinics',address:'MG Road',distance:'4.2 km',phone:'08666686868',speciality:'Cardiology, Diabetes Care'},
];

let medications=[
  {id:1,name:'Metformin 500mg',time:'08:30',condition:'Diabetes',done:false,icon:'üíä'},
  {id:2,name:'Amlodipine 5mg',time:'21:00',condition:'Hypertension',done:false,icon:'üíä'},
];

/* ‚îÄ‚îÄ‚îÄ Smart Schedule ‚îÄ‚îÄ‚îÄ */
function buildSchedulePage(){
  buildTodaySchedule();
  buildWaterSchedule();
  buildMealSchedule();
  buildWalkSchedule();
  buildSleepSchedule();
  buildAlarmList();
  buildMedSchedule();
}

function buildTodaySchedule(){
  const container=document.getElementById('today-schedule');
  if(!container)return;
  container.innerHTML='';
  const now=new Date();
  const curMin=now.getHours()*60+now.getMinutes();
  const colors={meal:'var(--amber)',water:'var(--blue)',walk:'var(--teal)',med:'var(--red)',sleep:'var(--purple)'};
  const bgs={meal:'var(--amber-lt)',water:'var(--blue-lt)',walk:'var(--teal-lt)',med:'var(--red-lt)',sleep:'var(--purple-lt)'};
  SCHEDULE_ITEMS.forEach(item=>{
    const [h,m]=item.time.split(':').map(Number);
    const itemMin=h*60+m;
    const isPast=itemMin<curMin;
    const isNow=Math.abs(itemMin-curMin)<=15;
    const isDone=scheduleDoneIds.has(item.id);
    const div=document.createElement('div');
    div.style.cssText=`padding:10px;border-radius:10px;background:${isDone?'var(--cream2)':isNow?bgs[item.type]:'#fff'};border:1.5px solid ${isNow?colors[item.type]+'80':'var(--border)'};cursor:pointer;transition:all .2s;opacity:${isPast&&!isNow?'.6':'1'}`;
    div.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px"><span style="font-size:1.2rem">${item.icon}</span><span style="font-size:.65rem;font-weight:700;color:${isDone?'var(--teal)':isNow?colors[item.type]:'var(--ink3)'}">${isDone?'‚úÖ':isNow?'üîî NOW!':item.time}</span></div>
    <div style="font-size:.76rem;font-weight:600;color:${isDone?'var(--ink3)':isNow?colors[item.type]:'var(--ink)'};text-decoration:${isDone?'line-through':'none'}">${item.name}</div>
    <div style="font-size:.65rem;color:var(--ink3);margin-top:3px;line-height:1.4">${item.tip}</div>`;
    div.onclick=()=>{scheduleDoneIds.add(item.id);buildTodaySchedule();showSmartAlert('‚úÖ','Done!','Marked: '+item.name,4000,'normal');};
    container.appendChild(div);
  });
}

function buildWaterSchedule(){
  const el=document.getElementById('water-schedule-list');if(!el)return;
  const times=['07:00','09:00','11:00','13:00','15:00','17:00','19:00','21:00'];
  const curMin=new Date().getHours()*60+new Date().getMinutes();
  el.innerHTML='';
  times.forEach((t,i)=>{
    const [h,m]=t.split(':').map(Number);const past=h*60+m<curMin;
    el.innerHTML+=`<div style="display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:${past?'var(--cream)':'var(--blue-lt)'};border:1px solid ${past?'var(--border)':'rgba(26,92,156,.2)'}">
      <span>üíß</span><span style="font-size:.78rem;font-weight:600;flex:1;color:${past?'var(--ink3)':'var(--blue)'}">${t} ‚Äî Glass ${i+1}</span>
      <span style="font-size:.7rem;color:${past?'var(--teal)':'var(--ink3)'}">${past?'‚úÖ Done':'Upcoming'}</span></div>`;
  });
}

function buildMealSchedule(){
  const el=document.getElementById('meal-schedule-list');if(!el)return;
  const meals=[
    {time:'07:30',name:'üç≥ Breakfast',tip:'High protein: eggs, oats, fruit. Avoid sugary cereal.'},
    {time:'10:30',name:'üçé Mid-morning Snack',tip:'Nuts, yogurt, or fresh fruit. 150-200 cal.'},
    {time:'13:00',name:'üç± Lunch',tip:'Largest meal: rice/roti + dal + sabzi + salad.'},
    {time:'16:00',name:'ü´ñ Evening Snack',tip:'Light: sprouts, roasted chana, green tea.'},
    {time:'19:30',name:'üç≤ Dinner',tip:'Light & early. Avoid carbs after 7pm. Soup ideal.'},
  ];
  const cur=new Date().getHours()*60+new Date().getMinutes();
  el.innerHTML='';
  meals.forEach(m=>{
    const [h,mn]=m.time.split(':').map(Number);const past=h*60+mn<cur;const isNow=Math.abs((h*60+mn)-cur)<=20;
    el.innerHTML+=`<div style="padding:9px;border-radius:8px;background:${isNow?'var(--amber-lt)':'var(--cream)'};border:1.5px solid ${isNow?'rgba(201,123,26,.4)':'var(--border)'}">
      <div style="display:flex;justify-content:space-between"><span style="font-size:.82rem;font-weight:600">${m.name}</span>
      <span style="font-size:.7rem;font-weight:700;color:${isNow?'var(--amber)':past?'var(--teal)':'var(--ink3)'}">${isNow?'üîî EAT NOW!':past?'‚úÖ':m.time}</span></div>
      <div style="font-size:.7rem;color:var(--ink3);margin-top:2px">${m.tip}</div></div>`;
  });
}

function buildWalkSchedule(){
  const el=document.getElementById('walk-schedule-list');if(!el)return;
  const walks=[
    {time:'09:00',name:'Morning Walk',dur:'30 min',tip:'Fasted walk burns fat better!'},
    {time:'13:30',name:'Post-lunch Walk',dur:'10 min',tip:'Reduces blood sugar spike by 30%!'},
    {time:'18:00',name:'Evening Exercise',dur:'30 min',tip:'Peak body temp ‚Äî best for cardio.'},
    {time:'20:00',name:'Night Stroll',dur:'10 min',tip:'Gentle walk aids digestion & sleep.'},
  ];
  const cur=new Date().getHours()*60+new Date().getMinutes();
  el.innerHTML='';
  walks.forEach(w=>{
    const [h,m]=w.time.split(':').map(Number);const past=h*60+m<cur;
    el.innerHTML+=`<div style="display:flex;gap:10px;padding:9px;border-radius:8px;background:${past?'var(--cream)':'var(--teal-lt)'};border:1px solid ${past?'var(--border)':'rgba(10,123,108,.2)'}">
      <span>üö∂</span>
      <div style="flex:1"><div style="font-size:.78rem;font-weight:600;color:${past?'var(--ink3)':'var(--teal)'}">${w.time} ‚Äî ${w.name} (${w.dur})</div>
      <div style="font-size:.68rem;color:var(--ink3)">${w.tip}</div></div>
      <span style="font-size:.8rem">${past?'‚úÖ':''}</span></div>`;
  });
}

function buildSleepSchedule(){
  const bedtime=document.getElementById('bedtime-input')?.value||'22:00';
  const [bh,bm]=bedtime.split(':').map(Number);
  const windH=bh===0?23:bh-1;
  const el=document.getElementById('sleep-schedule-items');if(!el)return;
  el.innerHTML=`
    <div style="display:flex;gap:8px;padding:9px;border-radius:8px;background:var(--purple-lt);border:1px solid rgba(123,26,156,.2)">
      <span>üåô</span><div><div style="font-size:.78rem;font-weight:600;color:var(--purple)">${windH.toString().padStart(2,'0')}:${bm.toString().padStart(2,'0')} ‚Äî Wind-down time</div>
      <div style="font-size:.68rem;color:var(--ink3)">Dim lights, no screens, relaxation exercises</div></div></div>
    <div style="display:flex;gap:8px;padding:9px;border-radius:8px;background:var(--purple-lt);border:1px solid rgba(123,26,156,.2)">
      <span>üò¥</span><div><div style="font-size:.78rem;font-weight:600;color:var(--purple)">${bedtime} ‚Äî Bedtime</div>
      <div style="font-size:.68rem;color:var(--ink3)">8-hour sleep target for optimal health</div></div></div>
    <div style="display:flex;gap:8px;padding:9px;border-radius:8px;background:var(--amber-lt);border:1px solid rgba(201,123,26,.2)">
      <span>‚òÄÔ∏è</span><div><div style="font-size:.78rem;font-weight:600;color:var(--amber)">${document.getElementById('wakeup-input')?.value||'06:00'} ‚Äî Wake Up Alarm</div>
      <div style="font-size:.68rem;color:var(--ink3)">Drink water first, check vitals, morning walk!</div></div></div>`;
}

function updateSleepSchedule(){buildSleepSchedule();showSmartAlert('üò¥','Sleep schedule updated!','Your sleep alarms have been set.',4000,'normal');}
function updateSedentaryLimit(val){sedentaryLimit=parseInt(val);showSmartAlert('üö∂','Walk alert updated!','You\'ll be reminded every '+val+' min.',4000,'normal');}

function buildAlarmList(){
  const el=document.getElementById('alarm-list');if(!el)return;
  el.innerHTML='';
  userAlarms.forEach(a=>{
    const div=document.createElement('div');
    div.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;background:var(--cream);border:1px solid var(--border)';
    div.innerHTML=`<span style="font-size:1.2rem">${a.icon}</span>
      <div style="flex:1"><div style="font-size:.84rem;font-weight:600;color:${a.enabled?'var(--ink)':'var(--ink3)'}">${a.time}</div>
      <div style="font-size:.72rem;color:var(--ink3)">${a.label}</div></div>
      <input type="checkbox" ${a.enabled?'checked':''} onchange="toggleAlarm(${a.id},this.checked)" style="width:18px;height:18px;cursor:pointer;accent-color:var(--teal)">
      <button onclick="deleteAlarm(${a.id})" style="background:none;border:none;cursor:pointer;color:var(--ink3);font-size:.9rem;padding:4px">‚úï</button>`;
    el.appendChild(div);
  });
}

function addAlarm(){
  const t=document.getElementById('new-alarm-time')?.value;
  const l=document.getElementById('new-alarm-label')?.value||'Alarm';
  if(!t){showSmartAlert('‚è∞','Pick a time!','Please select alarm time.',4000,'normal');return;}
  userAlarms.push({id:nextAlarmId++,time:t,label:l,enabled:true,icon:'‚è∞'});
  buildAlarmList();
  showSmartAlert('‚è∞','Alarm Set!',t+' ‚Äî '+l,5000,'normal');
}

function toggleAlarm(id,enabled){const a=userAlarms.find(x=>x.id===id);if(a){a.enabled=enabled;buildAlarmList();}}
function deleteAlarm(id){userAlarms=userAlarms.filter(x=>x.id!==id);buildAlarmList();}

function checkAlarms(){
  const now=new Date();
  const cur=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  if(snoozedUntil&&Date.now()<snoozedUntil)return;
  userAlarms.forEach(a=>{
    if(a.enabled&&a.time===cur&&!a._rungAt){a._rungAt=cur;ringAlarm(a);}
    else if(a._rungAt!==cur)delete a._rungAt;
  });
  medications.forEach(m=>{
    if(m.time===cur&&!m._rungAt){m._rungAt=cur;showSmartAlert('üíä','Medication Time!','Take: '+m.name,12000,'red');}
    else if(m._rungAt!==cur)delete m._rungAt;
  });
}

function ringAlarm(alarm){
  document.getElementById('alarm-ring-time').textContent=alarm.time;
  document.getElementById('alarm-ring-label').textContent=alarm.label;
  document.getElementById('alarm-ring-icon').textContent=alarm.icon;
  document.getElementById('alarm-ring-modal').classList.add('show');
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    [0,.3,.6,.9].forEach(t=>{
      const osc=ctx.createOscillator();const g=ctx.createGain();osc.connect(g);g.connect(ctx.destination);
      osc.frequency.value=880;g.gain.setValueAtTime(.25,ctx.currentTime+t);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+t+.28);
      osc.start(ctx.currentTime+t);osc.stop(ctx.currentTime+t+.28);
    });
  }catch(e){}
}

function dismissAlarm(){snoozedUntil=Date.now()+5*60*1000;document.getElementById('alarm-ring-modal').classList.remove('show');showSmartAlert('üò¥','Snoozed 5 minutes','Alarm will ring again in 5 min.',4000,'normal');}
function stopAlarm(){document.getElementById('alarm-ring-modal').classList.remove('show');}

function testAllAlerts(){
  setTimeout(()=>showSmartAlert('üíß','Time to Drink Water!','You haven\'t had water in 2 hours. Drink 1 glass now!',8000,'blue'),200);
  setTimeout(()=>showSmartAlert('üö∂','Time to Move!','You\'ve been sitting for 60 minutes. Take a short walk!',8000,'teal'),2500);
  setTimeout(()=>showSmartAlert('üç±','Lunch Time!','It\'s time for your midday meal. Balanced plate: veggies + protein + carbs!',8000,'amber'),5000);
  setTimeout(()=>showSmartAlert('üò¥','Bedtime in 1 Hour!','Start winding down. No screens. Relaxation time.',8000,'purple'),7500);
  setTimeout(()=>showSmartAlert('üíä','Medication Reminder!','Time to take: Metformin 500mg with food.',10000,'red'),10000);
  setTimeout(()=>ringAlarm({time:new Date().toLocaleTimeString().slice(0,5),label:'‚è∞ Test Alarm ‚Äî PulseIQ Pro v4',icon:'‚è∞'}),12500);
}

function buildMedSchedule(){
  const el=document.getElementById('med-schedule');if(!el)return;
  el.innerHTML='';
  if(medications.length===0){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--ink3);font-size:.78rem">No medications added. Click + Add Medication below.</div>';return;}
  medications.forEach(m=>{
    const div=document.createElement('div');
    div.style.cssText=`display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:${m.done?'var(--cream)':'var(--red-lt)'};border:1.5px solid ${m.done?'var(--border)':'rgba(192,57,43,.2)'}`;
    div.innerHTML=`<span style="font-size:1.1rem">üíä</span>
      <div style="flex:1"><div style="font-size:.8rem;font-weight:600;color:${m.done?'var(--ink3)':'var(--ink)'};text-decoration:${m.done?'line-through':'none'}">${m.name}</div>
      <div style="font-size:.7rem;color:var(--ink3)">${m.time} ¬∑ ${m.condition}</div></div>
      <button onclick="markMedDone(${m.id})" style="font-size:.7rem;padding:4px 10px;border-radius:6px;background:${m.done?'var(--teal-lt)':'var(--teal)'};color:${m.done?'var(--teal)':'#fff'};border:none;cursor:pointer;font-family:var(--ff-body)">${m.done?'‚úÖ Taken':'Take'}</button>`;
    el.appendChild(div);
  });
}

function addMedication(){
  const name=prompt('Medication name & dose (e.g. Metformin 500mg):');if(!name)return;
  const time=prompt('Time (HH:MM):');if(!time)return;
  const condition=prompt('For condition:')||'General';
  medications.push({id:nextMedId++,name,time,condition,done:false,icon:'üíä'});
  buildMedSchedule();showSmartAlert('üíä','Medication Added',name+' at '+time,5000,'normal');
}
function markMedDone(id){const m=medications.find(x=>x.id===id);if(m){m.done=true;buildMedSchedule();showSmartAlert('üíä','Taken!',m.name+' recorded.',4000,'normal');}}

/* ‚îÄ‚îÄ‚îÄ Disease Monitor ‚îÄ‚îÄ‚îÄ */
function addCondition(){
  const sel=document.getElementById('add-condition-select');const key=sel.value;
  if(!key||userConditions.includes(key))return;
  userConditions.push(key);
  buildConditionTags();buildDiseaseRiskGrid();buildEmergencyContactsUI();
  sel.value='';
  const c=CONDITION_DATA[key];
  showSmartAlert(c.label.split(' ')[0],'Condition Added','Monitoring activated for '+c.label+'. Personalized alerts enabled!',7000,'normal');
  // Auto-add suggested meds
  const meds={hypertension:[{name:'Amlodipine 5mg',time:'21:00',condition:'Hypertension'}],
    diabetes_t2:[{name:'Metformin 500mg',time:'08:30',condition:'Diabetes T2'}],
    heart:[{name:'Aspirin 75mg',time:'08:00',condition:'Heart Disease'}],
    thyroid:[{name:'Levothyroxine 50mcg',time:'07:00',condition:'Thyroid'}]};
  if(meds[key])meds[key].forEach(s=>{if(!medications.find(m=>m.name===s.name)){medications.push({id:nextMedId++,...s,done:false,icon:'üíä'});}});
  buildMedSchedule();
}

function removeCondition(key){userConditions=userConditions.filter(k=>k!==key);buildConditionTags();buildDiseaseRiskGrid();}

function buildConditionTags(){
  const el=document.getElementById('condition-tags');if(!el)return;
  if(userConditions.length===0){el.innerHTML='<span style="font-size:.78rem;color:var(--ink3);font-style:italic">No conditions added yet. Add from the dropdown above.</span>';return;}
  el.innerHTML='';
  userConditions.forEach(k=>{
    const c=CONDITION_DATA[k];const tag=document.createElement('div');
    tag.style.cssText=`display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;background:${c.bg};border:1.5px solid ${c.color}40;font-size:.76rem;font-weight:600;color:${c.color}`;
    tag.innerHTML=`${c.label} <button onclick="removeCondition('${k}')" style="background:none;border:none;cursor:pointer;color:${c.color};font-size:.85rem">‚úï</button>`;
    el.appendChild(tag);
  });
}

function computeConditionRisk(key){
  const hri=parseInt(document.getElementById('hri-num')?.textContent||'0');
  const c=CONDITION_DATA[key];
  let risk=hri*0.45;
  try{
    const hr=parseFloat(document.getElementById('sv-hr')?.textContent||'72');
    const spo2=parseFloat(document.getElementById('sv-spo2')?.textContent||'98');
    const bps=parseFloat(document.getElementById('sv-bps')?.textContent||'118');
    const resp=parseFloat(document.getElementById('sv-resp')?.textContent||'16');
    const temp=parseFloat(document.getElementById('sv-temp')?.textContent||'36.8');
    if(c.thresholds.hr_hi&&hr>c.thresholds.hr_hi)risk+=20;
    if(c.thresholds.hr_lo&&hr<c.thresholds.hr_lo)risk+=15;
    if(c.thresholds.spo2_lo&&spo2<c.thresholds.spo2_lo)risk+=30;
    if(c.thresholds.bps_hi&&bps>c.thresholds.bps_hi)risk+=20;
    if(c.thresholds.resp_hi&&resp>c.thresholds.resp_hi)risk+=15;
    if(c.thresholds.temp_hi&&temp>c.thresholds.temp_hi)risk+=15;
  }catch(e){}
  return Math.min(Math.round(risk),100);
}

function buildDiseaseRiskGrid(){
  const grid=document.getElementById('disease-risk-grid');if(!grid)return;
  if(userConditions.length===0){
    grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--ink3)">Add health conditions above to see real-time risk assessment</div>';return;
  }
  grid.innerHTML='';
  userConditions.forEach(k=>{
    const c=CONDITION_DATA[k];const risk=computeConditionRisk(k);
    const riskColor=risk>70?'var(--red)':risk>40?'var(--amber)':'var(--teal)';
    const riskLabel=risk>70?'HIGH RISK':risk>40?'MODERATE':'LOW';
    const div=document.createElement('div');
    div.style.cssText=`padding:14px;border-radius:12px;background:${c.bg};border:1.5px solid ${c.color}30`;
    div.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <span style="font-size:.8rem;font-weight:700;color:${c.color}">${c.label}</span>
      <span style="font-size:.7rem;font-weight:700;color:${riskColor};padding:2px 8px;border-radius:10px;background:rgba(255,255,255,.6)">${riskLabel}</span></div>
    <div class="risk-meter"><div class="risk-fill" style="width:${risk}%;background:${riskColor}"></div></div>
    <div style="font-size:.68rem;color:${c.color};margin-top:6px;font-weight:600">Risk: ${risk}%</div>
    <div style="margin-top:8px;display:flex;flex-direction:column;gap:4px">
      <div style="font-size:.67rem;color:var(--ink3)">ü•ó <strong>Diet:</strong> ${c.dietary.substring(0,65)}‚Ä¶</div>
      <div style="font-size:.67rem;color:var(--ink3)">üèÉ <strong>Exercise:</strong> ${c.exercise.substring(0,65)}‚Ä¶</div>
      <div style="font-size:.67rem;padding:5px;border-radius:6px;background:rgba(255,255,255,.7);color:${c.color};font-weight:600">üíä ${c.meds.substring(0,65)}‚Ä¶</div>
      ${risk>65?`<div style="font-size:.67rem;padding:5px;border-radius:6px;background:var(--red-lt);color:var(--red);font-weight:600;margin-top:2px">üÜò ${c.emergency.substring(0,70)}‚Ä¶</div>`:''}
    </div>`;
    grid.appendChild(div);
  });
}

function buildEmergencyContactsUI(){
  const el=document.getElementById('emergency-contacts-list');if(!el)return;
  el.innerHTML='';
  emergencyContacts.forEach((c,i)=>{
    el.innerHTML+=`<div style="display:flex;align-items:center;gap:10px;padding:10px;border-radius:8px;background:var(--cream);border:1px solid var(--border)">
      <span style="font-size:1.1rem">üë§</span>
      <div style="flex:1"><div style="font-size:.8rem;font-weight:600">${c.name}</div>
      <div style="font-size:.7rem;color:var(--ink3)">${c.relation} ¬∑ ${c.number}</div></div>
      <button onclick="removeEmergencyContact(${i})" style="background:none;border:none;cursor:pointer;color:var(--red)">‚úï</button></div>`;
  });
}

function removeEmergencyContact(i){emergencyContacts.splice(i,1);buildEmergencyContactsUI();}
function addEmergencyContact(){
  const name=prompt('Contact name:');if(!name)return;
  const number=prompt('Phone number:');if(!number)return;
  const relation=prompt('Relation:')||'Family';
  emergencyContacts.push({name,number,relation});buildEmergencyContactsUI();
  showSmartAlert('üë§','Contact Added',name+' added as emergency contact.',5000,'normal');
}
function toggleAutoEmergency(enabled){autoEmergencyEnabled=enabled;}

function buildHospitalList(){
  const el=document.getElementById('hospital-list');if(!el)return;el.innerHTML='';
  HOSPITALS.forEach(h=>{
    el.innerHTML+=`<div onclick="callHospital('${h.phone}','${h.name}')" style="display:flex;gap:10px;padding:10px;border-radius:8px;background:var(--cream);border:1px solid var(--border);cursor:pointer;transition:background .15s" onmouseover="this.style.background='var(--cream2)'" onmouseout="this.style.background='var(--cream)'">
      <span style="font-size:1.2rem">üè•</span>
      <div style="flex:1"><div style="font-size:.8rem;font-weight:600">${h.name}</div>
      <div style="font-size:.7rem;color:var(--ink3)">${h.address} ¬∑ <strong style="color:var(--teal)">${h.distance}</strong></div>
      <div style="font-size:.67rem;color:var(--blue)">${h.speciality}</div></div>
      <span style="font-size:.9rem;align-self:center">üìû</span></div>`;
  });
}

function callHospital(phone,name){
  showSmartAlert('üè•','Calling '+name,phone,6000,'normal');
  setTimeout(()=>window.location.href='tel:'+phone,500);
}
function callNearestHospital(){callHospital(HOSPITALS[0].phone,HOSPITALS[0].name);}

/* ‚îÄ‚îÄ‚îÄ Emergency System ‚îÄ‚îÄ‚îÄ */
function checkForEmergency(hri){
  if(!autoEmergencyEnabled)return;
  if(hri>=90&&!emergencyTriggered&&Date.now()-lastEmergencyTime>60000){
    lastEmergencyTime=Date.now();emergencyTriggered=true;
    setTimeout(()=>emergencyTriggered=false,90000);
    triggerEmergencyProtocol(hri);
  }
}

function triggerEmergencyProtocol(hri){
  const sub=document.getElementById('em-subtitle');
  if(sub)sub.textContent='HRI '+hri+' ‚Äî Critical pattern detected. Auto-calling contacts in:';
  const cl=document.getElementById('em-call-list');
  if(cl){
    cl.innerHTML='';
    emergencyContacts.forEach((c,i)=>{
      cl.innerHTML+=`<div class="call-item ${i===0?'calling':'pending'}" id="em-ci-${i}">
        <div class="call-icon">üìû</div>
        <div class="call-info"><div class="call-name">${c.name}</div><div class="call-number">${c.relation} ¬∑ ${c.number}</div></div>
        <div class="call-status ${i===0?'calling':'pending'}" id="em-cs-${i}">${i===0?'Calling‚Ä¶':'Pending'}</div></div>`;
    });
    cl.innerHTML+=`<div class="call-item pending" id="em-ci-amb">
      <div class="call-icon">üöë</div>
      <div class="call-info"><div class="call-name">${HOSPITALS[0].name}</div><div class="call-number">Nearest Emergency ¬∑ ${HOSPITALS[0].phone}</div></div>
      <div class="call-status pending" id="em-cs-amb">Pending</div></div>`;
  }
  document.getElementById('emergency-modal').classList.add('show');
  let count=10;const cdEl=document.getElementById('ems-countdown');
  emergencyCountdownInterval=setInterval(()=>{
    count--;if(cdEl)cdEl.textContent=count;
    if(count===8){const s=document.getElementById('em-cs-0');const c=document.getElementById('em-ci-0');if(s){s.textContent='Called ‚úì';s.className='call-status called';}if(c)c.className='call-item called';}
    if(count===5&&emergencyContacts.length>1){const s=document.getElementById('em-cs-1');const c=document.getElementById('em-ci-1');if(s){s.textContent='Calling‚Ä¶';s.className='call-status calling';}if(c)c.className='call-item calling';}
    if(count===3){const s=document.getElementById('em-cs-amb');const c=document.getElementById('em-ci-amb');if(s){s.textContent='Notified';s.className='call-status calling';}if(c)c.className='call-item calling';}
    if(count<=0){clearInterval(emergencyCountdownInterval);triggerEmergencyNow();}
  },1000);
  showSmartAlert('üÜò','EMERGENCY DETECTED','HRI '+hri+' ‚Äî Auto-calling emergency contacts!',15000,'emergency');
}

function dismissEmergencyModal(){clearInterval(emergencyCountdownInterval);document.getElementById('emergency-modal').classList.remove('show');showSmartAlert('‚úÖ','Dismissed','If in danger, call 108 immediately!',8000,'normal');}
function triggerEmergencyNow(){
  clearInterval(emergencyCountdownInterval);document.getElementById('emergency-modal').classList.remove('show');
  if(emergencyContacts.length>0)window.location.href='tel:'+emergencyContacts[0].number.replace(/[\s\-]/g,'');
  showSmartAlert('üìû','Calling Emergency Contact','Help is on the way!',8000,'emergency');
}
function simulateEmergency(){triggerEmergencyProtocol(95);}

/* ‚îÄ‚îÄ‚îÄ Smart Alert Toasts ‚îÄ‚îÄ‚îÄ */
function showSmartAlert(icon,title,msg,duration,type){
  const panel=document.getElementById('smart-alerts-panel');if(!panel)return;
  const id='sa'+Date.now()+Math.random();
  const colors={red:'var(--red)',blue:'var(--blue)',teal:'var(--teal)',purple:'var(--purple)',amber:'var(--amber)',normal:'var(--ink)',emergency:'var(--red)'};
  const bgs={red:'var(--red-lt)',blue:'var(--blue-lt)',teal:'var(--teal-lt)',purple:'var(--purple-lt)',amber:'var(--amber-lt)',normal:'#fff',emergency:'var(--red-lt)'};
  const el=document.createElement('div');
  el.className='smart-alert-toast'+(type==='emergency'?' emergency':'');
  el.id=id;
  el.style.borderColor=(colors[type]||'#ccc')+'50';
  el.style.background=bgs[type]||'#fff';
  el.innerHTML=`<div class="sa-icon">${icon}</div>
    <div class="sa-body"><div class="sa-title" style="color:${colors[type]||'var(--ink)'}">${title}</div>
    <div class="sa-msg">${msg}</div>
    <div class="sa-time">${new Date().toLocaleTimeString()}</div></div>
    <button class="sa-dismiss" onclick="dismissSA('${id}')">‚úï</button>`;
  panel.appendChild(el);
  setTimeout(()=>el.classList.add('show'),30);
  setTimeout(()=>dismissSA(id),duration||6000);
  // Limit to 3
  const all=panel.querySelectorAll('.smart-alert-toast');
  if(all.length>3)dismissSA(all[0].id);
}
function dismissSA(id){const el=document.getElementById(id);if(!el)return;el.classList.remove('show');setTimeout(()=>el.remove(),400);}

/* ‚îÄ‚îÄ‚îÄ Health Chatbot ‚îÄ‚îÄ‚îÄ */
const CHATBOT_KB={
  vitals:()=>{const hr=document.getElementById('sv-hr')?.textContent||'--';const spo2=document.getElementById('sv-spo2')?.textContent||'--';const bps=document.getElementById('sv-bps')?.textContent||'--';const bpd=document.getElementById('sv-bpd')?.textContent||'--';const temp=document.getElementById('sv-temp')?.textContent||'--';const hri=document.getElementById('hri-num')?.textContent||'--';return`üìä Your current vitals:\n‚Ä¢ Heart Rate: ${hr} bpm\n‚Ä¢ SpO‚ÇÇ: ${spo2}%\n‚Ä¢ Blood Pressure: ${bps}/${bpd} mmHg\n‚Ä¢ Temperature: ${temp}¬∞C\n‚Ä¢ Health Risk Index: ${hri}/100\n\n${parseInt(hri)<30?'‚úÖ All excellent!':parseInt(hri)<55?'‚ö†Ô∏è Slightly elevated ‚Äî monitor closely.':'üö® Alert state ‚Äî please seek medical advice!'}`},
  breakfast:()=>`üç≥ Breakfast recommendations:\n\n‚Ä¢ Eggs + whole grain toast + vegetables\n‚Ä¢ Oats with berries, flaxseeds & nuts\n‚Ä¢ Idli/dosa with sambar (great protein + fiber!)\n‚Ä¢ Avoid: white bread, sugary cereal, fruit juice\n\n${userConditions.includes('diabetes_t2')||userConditions.includes('diabetes_t1')?'üç¨ Diabetic: High-protein, low-carb breakfast. No fruit juice!\n':''}\nProtein goal: 20-30g stabilizes blood sugar all day.\n‚è∞ Best time: 7:00-8:00 AM`,
  lunch:()=>`üç± Lunch recommendations:\n\n‚Ä¢ 50% vegetables + 25% protein + 25% complex carbs\n‚Ä¢ Brown rice/roti + dal + sabzi + salad + curd\n${userConditions.includes('diabetes_t2')?'‚Ä¢ üç¨ Diabetes: Smaller rice portions. Post-meal 10-min walk!\n':''}${userConditions.includes('heart')?'‚Ä¢ ‚ù§Ô∏è Heart: No fried food. Grilled/steamed only.\n':''}\n‚è∞ Best: 12:30-1:30 PM. Post-meal walk reduces sugar spike by 30%!`,
  dinner:()=>`üç≤ Dinner recommendations:\n\n‚Ä¢ Keep it LIGHT ‚Äî smallest meal of the day!\n‚Ä¢ Best: Khichdi, soup, grilled protein + salad\n‚Ä¢ Avoid heavy carbs & fried foods after 7 PM\n${userConditions.includes('diabetes_t2')||userConditions.includes('diabetes_t1')?'‚Ä¢ üç¨ Check blood sugar before bed!\n':''}${userConditions.includes('hypertension')?'‚Ä¢ ü©∏ Low-sodium dinner ‚Äî no pickles or papad!\n':''}\n‚è∞ Eat 3 hours before bedtime for good digestion & sleep.`,
  exercise:()=>`üèÉ Today's exercise plan:\n\n${userConditions.includes('heart')?'‚ö†Ô∏è HEART DISEASE: Light walking only! 20-30 min gentle walk.\n':''}${userConditions.includes('diabetes_t2')||userConditions.includes('diabetes_t1')?'üç¨ DIABETES: Check blood sugar before/after. 30 min post-meal walk!\n':''}${userConditions.includes('asthma')?'üå¨Ô∏è ASTHMA: Always carry inhaler! Warm up slowly.\n':''}\n‚Ä¢ General: 30 min moderate activity daily\n‚Ä¢ Best time: 6-8 AM or 5-7 PM (cooler in Vijayawada!)\n‚Ä¢ Current HRI: ${document.getElementById('hri-num')?.textContent||'--'}/100 ‚Äî ${parseInt(document.getElementById('hri-num')?.textContent||'30')>55?'‚ö†Ô∏è Rest today! Vitals elevated.':'‚úÖ Safe to exercise!'}`,
  chest_pain:()=>`üö® CHEST PAIN IS SERIOUS!\n\nDo NOW:\n1. Stop all activity immediately\n2. Sit or lie down\n3. Call 108 (Emergency) NOW!\n4. If available: Aspirin 325mg (chew, don't swallow whole)\n5. Use nitroglycerin spray if prescribed\n6. Unlock door for paramedics\n\nDo NOT drive yourself. Do NOT ignore this.\n\n‚òéÔ∏è CALL 108 NOW!`,
  dizzy:()=>`üòµ Dizziness assessment:\n\n1. Sit or lie down immediately ‚Äî avoid falls!\n2. Drink water slowly (may be dehydration)\n3. Check blood pressure\n\nCommon causes:\n‚Ä¢ Low BP (stand up slowly next time)\n‚Ä¢ Low blood sugar ‚Üí eat something immediately\n‚Ä¢ Dehydration ‚Üí drink 2 glasses water\n‚Ä¢ Heart rhythm issue\n\nYour HR: ${document.getElementById('sv-hr')?.textContent||'--'} bpm\n${(parseInt(document.getElementById('sv-hr')?.textContent||'70')<55||parseInt(document.getElementById('sv-hr')?.textContent||'70')>115)?'‚ö†Ô∏è Abnormal HR + dizziness ‚Äî call doctor NOW!':'Rest 10-15 min and drink water. Call doctor if it persists.'}\n\n‚ö†Ô∏è If dizziness + chest pain + arm numbness ‚Üí Call 108 IMMEDIATELY!`,
  blood_sugar:()=>`üç¨ High blood sugar guidance:\n\nIf blood sugar > 250 mg/dL:\n1. Take medication as prescribed\n2. Drink water (helps flush glucose)\n3. Light gentle walk (10-15 min)\n4. Avoid ALL carbs until normalized\n5. Recheck in 1 hour\n\nüÜò If > 400 mg/dL or feeling very unwell ‚Üí Call doctor NOW!\n\nPrevention:\n‚Ä¢ Never skip meals\n‚Ä¢ Consistent meal timing\n‚Ä¢ 30 min daily exercise\n‚Ä¢ Check glucose before meals & bedtime\n${medications.find(m=>m.name.includes('Metformin'))?'\nüíä Metformin reminder: Take with food, never on empty stomach!':''}`,
  water:()=>`üíß Hydration guidance:\n\n‚Ä¢ Daily target for you (72kg): 2.4 litres (10 glasses)\n‚Ä¢ In Vijayawada heat: +200-300ml extra!\n‚Ä¢ Best times: Morning (500ml), before meals, after exercise\n\nDehydration signs:\n‚Ä¢ Dark yellow urine\n‚Ä¢ Headache & fatigue\n‚Ä¢ Dry mouth & skin\n‚Ä¢ Dizziness\n\n${userConditions.includes('kidney')?'‚ö†Ô∏è KIDNEY DISEASE: Follow doctor\'s fluid restriction!':''}\n${userConditions.includes('heart')?'‚ö†Ô∏è HEART: Sip slowly, no large amounts at once.':''}\n\nToday so far: ${waterCount}/8 glasses. ${waterCount>=8?'üéâ Goal achieved!':'Keep going! üí™'}`,
  sleep:()=>`üò¥ Sleep health tips:\n\n‚Ä¢ Target: 7-9 hours nightly\n‚Ä¢ Your schedule: Bed ${document.getElementById('bedtime-input')?.value||'22:00'}, Wake ${document.getElementById('wakeup-input')?.value||'06:00'}\n\nImprove quality:\n‚Ä¢ No screens 1 hour before bed\n‚Ä¢ Keep room cool (18-22¬∞C)\n‚Ä¢ No caffeine after 3 PM\n‚Ä¢ Consistent schedule ‚Äî even weekends!\n‚Ä¢ 5 min breathing exercises before sleep\n\n${userConditions.includes('diabetes_t2')?'üç¨ Diabetes: Check blood sugar before bed!':''}\n${userConditions.includes('hypertension')?'ü©∏ Hypertension: 7+ hours reduces heart risk by 45%!':''}\n\nSleep is medicine! üíä Poor sleep causes diabetes, hypertension & obesity.`,
};

function detectIntent(msg){
  const m=msg.toLowerCase();
  if(m.includes('breakfast')||m.includes('morning food'))return 'breakfast';
  if(m.includes('lunch')||m.includes('midday'))return 'lunch';
  if(m.includes('dinner')||m.includes('evening food')||m.includes('supper'))return 'dinner';
  if(m.includes('vital')||m.includes('heart rate')||m.includes('blood pressure')||m.includes('oxygen')||m.includes('temperature'))return 'vitals';
  if(m.includes('exercise')||m.includes('workout')||m.includes('walk')||m.includes('gym')||m.includes('yoga'))return 'exercise';
  if(m.includes('chest')||m.includes('heart pain')||m.includes('cardiac'))return 'chest_pain';
  if(m.includes('dizzy')||m.includes('dizziness')||m.includes('head spin')||m.includes('faint'))return 'dizzy';
  if(m.includes('blood sugar')||m.includes('glucose')||m.includes('diabetes')||m.includes('sugar high')||m.includes('sugar low'))return 'blood_sugar';
  if(m.includes('water')||m.includes('drink')||m.includes('hydrat'))return 'water';
  if(m.includes('sleep')||m.includes('insomn')||m.includes('bedtime')||m.includes('rest')||m.includes('tired'))return 'sleep';
  return null;
}

function getBotResponse(msg){
  const intent=detectIntent(msg);if(intent&&CHATBOT_KB[intent])return CHATBOT_KB[intent]();
  const m=msg.toLowerCase();
  if(m.includes('emergency')||m.includes('urgent')||m.includes('dying')||m.includes('dying'))
    return 'üÜò EMERGENCY?\n\nCall 108 (India Emergency) IMMEDIATELY!\n\nNearest: '+HOSPITALS[0].name+'\nüìû '+HOSPITALS[0].phone+' ('+HOSPITALS[0].distance+')\n\nYour emergency contact: '+emergencyContacts[0]?.name+' ‚Äî '+emergencyContacts[0]?.number+'\n\nStay calm. Help is available NOW!';
  if(m.includes('medication')||m.includes('medicine')||m.includes('tablet')||m.includes('pill'))
    return 'üíä Your medications:\n'+medications.map(m=>'‚Ä¢ '+m.name+' at '+m.time+' ('+m.condition+')').join('\n')+'\n\nNever miss a dose! Consistency is life-critical for chronic conditions.';
  if(m.includes('condition')||m.includes('disease')||m.includes('my health'))
    return userConditions.length===0?'ü©∫ No conditions added yet. Go to Disease Monitor page and add your conditions for personalized advice!'
      :'You have '+userConditions.length+' condition(s): '+userConditions.map(k=>CONDITION_DATA[k]?.label).join(', ')+'\n\nAsk me about diet, exercise, medication, or symptoms for any of these!';
  if(m.includes('hri')||m.includes('health risk')||m.includes('score'))
    return 'üìä HRI (Health Risk Index): '+document.getElementById('hri-num')?.textContent+'/100\n\n0-30: Normal ‚úÖ\n31-55: Elevated ‚ö†Ô∏è\n56-75: High Risk ‚ö°\n76-89: Critical üö®\n90+: Emergency üÜò\n\nHRI combines ALL your vitals using AI ‚Äî more accurate than any single reading!';
  if(m.includes('hello')||m.includes('hi')||m.includes('namaste')||m.includes('hey'))
    return 'üôè Namaste! I\'m HealthBot AI.\n\nI can help with:\n‚Ä¢ üçΩÔ∏è Meal advice (breakfast/lunch/dinner)\n‚Ä¢ üìä Vitals analysis\n‚Ä¢ üèÉ Exercise plans\n‚Ä¢ üíä Medication reminders\n‚Ä¢ üÜò Emergency guidance\n‚Ä¢ üò¥ Sleep tips\n‚Ä¢ üíß Hydration tracking\n\nWhat can I help you with today?';
  return 'ü§ñ I can help you with:\n‚Ä¢ "How are my vitals?"\n‚Ä¢ "What to eat for breakfast/lunch/dinner?"\n‚Ä¢ "What exercise today?"\n‚Ä¢ "I have chest pain" (emergency!)\n‚Ä¢ "My blood sugar is high"\n‚Ä¢ "Help me sleep better"\n‚Ä¢ "How much water should I drink?"\n\nFor emergencies always call 108! üÜò';
}

function toggleChatbot(){
  chatOpen=!chatOpen;
  const panel=document.getElementById('chatbot-panel');
  const badge=document.getElementById('chat-badge');
  if(chatOpen){panel.classList.add('open');badge.classList.remove('show');
    if(chatHistory.length===0)addBotMsg('üôè Namaste! I\'m HealthBot AI ‚Äî your 24/7 health assistant.\n\nI monitor your vitals in real-time and provide personalized advice. I can help with meals, exercise, medication, emergencies, and more.\n\nWhat can I help you with today?');
  }else panel.classList.remove('open');
}

function addBotMsg(text){
  const msgs=document.getElementById('chat-messages');if(!msgs)return;
  const typing=document.createElement('div');typing.className='chat-typing';typing.innerHTML='<span></span><span></span><span></span>';msgs.appendChild(typing);msgs.scrollTop=msgs.scrollHeight;
  setTimeout(()=>{
    typing.remove();
    const el=document.createElement('div');el.className='chat-msg bot';el.style.whiteSpace='pre-wrap';
    const isEmergency=text.includes('üÜò')||text.includes('Call 108')||text.includes('SERIOUS')||text.includes('üö®');
    if(isEmergency)el.classList.add('emergency-msg');
    el.textContent=text;msgs.appendChild(el);msgs.scrollTop=msgs.scrollHeight;
    chatHistory.push({role:'bot',text});
  },700+Math.random()*500);
}

function addUserMsg(text){
  const msgs=document.getElementById('chat-messages');if(!msgs)return;
  const el=document.createElement('div');el.className='chat-msg user';el.textContent=text;msgs.appendChild(el);msgs.scrollTop=msgs.scrollHeight;
  chatHistory.push({role:'user',text});
}

function sendChatMsg(){
  const input=document.getElementById('chat-input');const text=input.value.trim();if(!text)return;
  input.value='';addUserMsg(text);setTimeout(()=>addBotMsg(getBotResponse(text)),100);
}

function sendQuickMsg(text){
  if(!chatOpen)toggleChatbot();
  setTimeout(()=>{addUserMsg(text);setTimeout(()=>addBotMsg(getBotResponse(text)),100);},chatOpen?0:350);
}

/* ‚îÄ‚îÄ‚îÄ Real-time background monitors ‚îÄ‚îÄ‚îÄ */
let lastWaterAlertTime=0,lastWalkAlertTime=0,lastMealAlertTime=0,sedMin=0;

function runSmartMonitors(){
  const now=Date.now();const nowDate=new Date();
  const curH=nowDate.getHours(),curM=nowDate.getMinutes();
  const timeStr=curH.toString().padStart(2,'0')+':'+curM.toString().padStart(2,'0');
  
  checkAlarms();
  
  // Sedentary
  sedMin++;
  if(sedMin>=sedentaryLimit&&now-lastWalkAlertTime>sedentaryLimit*60000){
    lastWalkAlertTime=now;sedMin=0;
    showSmartAlert('üö∂','Time to Move!','You\'ve been sitting for '+sedentaryLimit+' min. A short walk is great for your health! üí™',9000,'teal');
  }
  
  // Water every 2 hours between 7am-9pm
  if(now-lastWaterAlertTime>120*60000&&curH>=7&&curH<=21){
    lastWaterAlertTime=now;
    if(waterCount<8)showSmartAlert('üíß','Drink Water!','Time for a glass of water! You\'ve had '+waterCount+'/8 glasses. Stay hydrated in Vijayawada heat! üå°Ô∏è',8000,'blue');
  }
  
  // Meal alerts
  const mealT=[{t:'07:30',n:'üç≥ Breakfast Time!'},{t:'13:00',n:'üç± Lunch Time!'},{t:'19:30',n:'üç≤ Dinner Time!'}];
  mealT.forEach(mt=>{if(timeStr===mt.t&&now-lastMealAlertTime>3600000){lastMealAlertTime=now;showSmartAlert('üçΩÔ∏è',mt.n,'Time for your meal! Remember balanced nutrition for better health.',8000,'amber');}});
  
  // Sleep
  const bt=document.getElementById('bedtime-input')?.value||'22:00';
  const[bh,bm]=bt.split(':').map(Number);
  const wt=`${(bh===0?23:bh-1).toString().padStart(2,'0')}:${bm.toString().padStart(2,'0')}`;
  if(timeStr===wt)showSmartAlert('üåô','Bedtime in 1 Hour!','Start winding down. Dim lights, no screens, relaxation time.',10000,'purple');
  if(timeStr===bt)showSmartAlert('üò¥','Bedtime!','Time to sleep! 8 hours for optimal health. Goodnight! üåô',10000,'purple');
  
  // Disease-specific alerts
  if(userConditions.length>0){
    userConditions.forEach(k=>{
      const risk=computeConditionRisk(k);const c=CONDITION_DATA[k];
      if(risk>75&&now%30000<2000)showSmartAlert(c.label.split(' ')[0],'High Risk!',c.label+' risk: '+risk+'%. '+c.emergency.substring(0,60),10000,'red');
    });
  }
  
  // Emergency check from HRI
  const hri=parseInt(document.getElementById('hri-num')?.textContent||'0');
  checkForEmergency(hri);
  
  // Refresh disease page if open
  if(document.getElementById('page-diseases')?.classList.contains('active'))buildDiseaseRiskGrid();
}

/* ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded',()=>{
  buildSchedulePage();buildHospitalList();buildEmergencyContactsUI();buildConditionTags();buildDiseaseRiskGrid();
  setTimeout(()=>document.getElementById('chat-badge')?.classList.add('show'),4000);
  setTimeout(()=>showSmartAlert('üëã','PulseIQ Pro v4 Active!','Smart Schedule, AI Chatbot, Disease Monitor & Emergency System ready! üöÄ',8000,'normal'),1500);
  setTimeout(()=>showSmartAlert('üíß','Hydration Reminder!','Drink 10 glasses of water today ‚Äî especially in Vijayawada heat!',7000,'blue'),5000);
  setInterval(runSmartMonitors,60000);
  setTimeout(runSmartMonitors,3000);
  setInterval(()=>{if(document.getElementById('page-schedule')?.classList.contains('active'))buildTodaySchedule();},15000);
});

// Extend showPage
const _origShowPage=window.showPage;
window.showPage=function(page,navBtn){
  _origShowPage&&_origShowPage(page,navBtn);
  if(page==='schedule')buildSchedulePage();
  if(page==='diseases'){buildDiseaseRiskGrid();buildHospitalList();buildEmergencyContactsUI();buildConditionTags();}
};

</script>

<!-- ‚ïê‚ïê‚ïê SMART ALERTS PANEL ‚ïê‚ïê‚ïê -->
<div class="smart-alerts-panel" id="smart-alerts-panel"></div>

<!-- ‚ïê‚ïê‚ïê ALARM RING MODAL ‚ïê‚ïê‚ïê -->
<div class="alarm-modal" id="alarm-ring-modal">
  <div class="alarm-box">
    <div style="font-size:3rem;animation:alarm-ring .6s linear infinite" id="alarm-ring-icon">‚è∞</div>
    <div class="alarm-box-time" id="alarm-ring-time">06:00</div>
    <div class="alarm-box-label" id="alarm-ring-label">Wake Up!</div>
    <div class="alarm-btns">
      <button class="btn btn-ghost" onclick="dismissAlarm()">üò¥ Snooze 5 min</button>
      <button class="btn btn-primary" onclick="stopAlarm()">‚úì Dismiss</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê EMERGENCY AUTO-CALL MODAL ‚ïê‚ïê‚ïê -->
<div class="emergency-modal" id="emergency-modal">
  <div class="emergency-box">
    <div class="emergency-header">
      <div class="emergency-icon">üÜò</div>
      <div><div class="emergency-title">EMERGENCY DETECTED</div>
        <div class="emergency-subtitle" id="em-subtitle">Critical health pattern ‚Äî Auto-calling emergency contacts</div></div>
    </div>
    <div class="emergency-countdown">
      <div class="ems-count" id="ems-countdown">10</div>
      <div class="ems-count-label">seconds until auto-call (tap Dismiss to cancel)</div>
    </div>
    <div class="call-list" id="em-call-list"></div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" style="flex:1;justify-content:center" onclick="dismissEmergencyModal()">‚úï Dismiss</button>
      <button class="btn btn-danger" style="flex:1;justify-content:center" onclick="triggerEmergencyNow()">üìû Call Now</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê HEALTH CHATBOT ‚ïê‚ïê‚ïê -->
<button class="chatbot-fab" onclick="toggleChatbot()" title="HealthBot AI Assistant">
  ü§ñ<div class="chat-badge" id="chat-badge">1</div>
</button>
<div class="chatbot-panel" id="chatbot-panel">
  <div class="chat-header">
    <div class="chat-avatar">ü§ñ</div>
    <div><div class="chat-name">HealthBot AI</div><div class="chat-status">‚óè Online ‚Äî Real-time health advisor</div></div>
    <button class="chat-close" onclick="toggleChatbot()">‚úï</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-quick-btns">
    <button class="chat-quick-btn" onclick="sendQuickMsg('What should I eat for breakfast?')">üç≥ Breakfast</button>
    <button class="chat-quick-btn" onclick="sendQuickMsg('How are my vitals?')">‚ù§Ô∏è Vitals</button>
    <button class="chat-quick-btn" onclick="sendQuickMsg('I have chest pain')">üö® Chest Pain</button>
    <button class="chat-quick-btn" onclick="sendQuickMsg('What exercise should I do today?')">üèÉ Exercise</button>
    <button class="chat-quick-btn" onclick="sendQuickMsg('My blood sugar is high')">üç¨ Blood Sugar</button>
    <button class="chat-quick-btn" onclick="sendQuickMsg('I feel dizzy')">üòµ Dizzy</button>
  </div>
  <div class="chat-input-row">
    <input class="chat-input" id="chat-input" placeholder="Ask about your health‚Ä¶" onkeydown="if(event.key==='Enter')sendChatMsg()">
    <button class="chat-send-btn" onclick="sendChatMsg()">‚û§</button>
  </div>
</div>


</body>
</html>